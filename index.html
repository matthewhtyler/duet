<!DOCTYPE html>
<!-- rebuilt 20260226-162108 -->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Duet">
<link rel="apple-touch-icon" href="favicon.png">
<link rel="icon" href="favicon.png">
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMiAzMiIgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIj4KICA8cmVjdCB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHJ4PSI3IiBmaWxsPSIjMjExZDFjIi8+CiAgPGNpcmNsZSBjeD0iMTIiIGN5PSIxNiIgcj0iNyIgc3Ryb2tlPSIjYzA3YThhIiBzdHJva2Utd2lkdGg9IjIuNSIgZmlsbD0ibm9uZSIvPgogIDxjaXJjbGUgY3g9IjIwIiBjeT0iMTYiIHI9IjciIHN0cm9rZT0iIzg0NTc2NCIgc3Ryb2tlLXdpZHRoPSIyLjUiIGZpbGw9Im5vbmUiLz4KPC9zdmc+">
  <meta name="theme-color" content="#faf8f5">
<title>Duet</title>
<style>
  :root {
    --bg: #faf8f5;
    --bg-card: #fff;
    --bg-card2: #faf8f5;
    --bg-input: #fff;
    --border: #ede9e2;
    --border-light: #f5f0eb;
    --text-primary: #2a1f1f;
    --text-secondary: #9a8a7a;
    --text-muted: #b0a090;
    --text-placeholder: #ccc;
    --nav-bg: #faf8f5;
    --nav-border: #ede9e2;
    --hamburger: #b0a090;
    --week-strip-bg: #fff;
    --popup-title: #2a1f1f;
    --icon-close: #888;
    --img-sep: #ede9e2;
    --todo-divider: #ede9e2;
    --todo-check-border: #9a8a7a;
    --picker-toggle-bg: #f0ede8;
    --picker-tab-active-bg: #fff;
    --picker-tab-active-color: #2a1f1f;
    --toggle-bg: #f0ede8;
    --toggle-active-bg: #fff;
    --toggle-active-color: #2a1f1f;
    --popup-week-bg: #fff;
  }
  body.dark-mode {
    --bg: #211d1c;
    --bg-card: #2a2522;
    --bg-card2: #211d1c;
    --bg-input: #302b29;
    --border: #3a3330;
    --border-light: #302b29;
    --text-primary: #f0ede8;
    --text-secondary: #9a8a7a;
    --text-muted: #9a8a7a;
    --text-placeholder: #55504e;
    --nav-bg: #211d1c;
    --nav-border: #3a3330;
    --hamburger: #7a6e68;
    --week-strip-bg: #2a2522;
    --popup-title: #ddd6cd;
    --icon-close: #9a8a7a;
    --img-sep: var(--bg-card);
    --todo-divider: #282423;
    --todo-check-border: #9a8a7a;
    --picker-toggle-bg: #302b29;
    --picker-tab-active-bg: #9a8a7a;
    --picker-tab-active-color: #f0ede9;
    --toggle-bg: #302b29;
    --toggle-active-bg: #9a8a7a;
    --toggle-active-color: #f0ede9;
    --popup-week-bg: var(--bg-input);
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; background: var(--bg); font-family: Georgia, "Times New Roman", serif; overflow: hidden; }
  body { display: flex; justify-content: center; }
  #app {
    width: 100%;
    max-width: 402px;
    height: 100vh;
    height: 100dvh;
    background: var(--bg);
    position: relative;
    overflow-x: hidden;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-top: 57px;
    box-sizing: border-box;
  }
  body.overlay-open #app { overflow-y: hidden; }
  button { font-family: inherit; cursor: pointer; -webkit-appearance: none; }
  input, textarea { font-family: sans-serif; -webkit-appearance: none; }
  .view { padding-bottom: 102px; }

  /* ── Top Nav ── */
  #top-nav {
    display: flex; align-items: center; justify-content: center;
    padding: 0;
    border-bottom: 1px solid var(--nav-border);
    background: var(--nav-bg);
    position: fixed; top: 0; left: 50%; transform: translateX(-50%);
    width: 100%; max-width: 402px; box-sizing: border-box;
    z-index: 60;
  }
  #top-nav-inner {
    display: flex; flex-direction: column; align-items: stretch;
    width: 100%; max-width: 390px; box-sizing: border-box;
  }
  #top-nav-main-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 18px 20px 14px;
  }
  #top-nav-ideas-row {
    display: none;
    padding: 0 20px 12px;
  }
  #app.ideas-nav { padding-top: 107px; }
  #nav-logo { display: flex; align-items: center; gap: 8px; background: none; border: none; outline: none; cursor: pointer; }
  #nav-logo span { font-size: 17px; font-weight: 600; letter-spacing: 0.02em; color: var(--text-primary); }
  body.dark-mode #logo-circle-dark { stroke: #845764; }
  body.dark-mode #nav-logo span { color: #ddd6cd; }
  body.dark-mode #logo-circle-dark { stroke: #845764; }
  #nav-back { background: none; border: none; padding: 4px; display: flex; }
  #nav-center { display: flex; align-items: center; gap: 0; }
  .nav-switcher-btn {
    background: none; border: none; display: flex; align-items: center; gap: 5px;
    padding: 4px 10px; font-size: 13px; font-weight: 500; color: var(--text-secondary);
    letter-spacing: 0.05em; text-transform: uppercase;
  }
  #nav-center-divider { color: #ddd; font-size: 14px; line-height: 1; }
  #nav-center-title { font-size: 13px; color: var(--text-secondary); letter-spacing: 0.05em; text-transform: uppercase; }
  #nav-hamburger { background: none; border: none; padding: 4px; display: flex; flex-direction: column; gap: 4px; }
  #nav-hamburger span { display: block; width: 18px; height: 1.5px; background: var(--hamburger); border-radius: 2px; }
  #nav-menu-overlay { position: fixed; inset: 0; z-index: 98; display: none; }
  #nav-menu-dropdown {
    position: absolute; top: calc(100% + 8px); right: 0;
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1); min-width: 160px;
    overflow: hidden; z-index: 99; display: none;
  }
  #nav-menu-dropdown button {
    width: 100%; display: flex; align-items: center; gap: 10px;
    padding: 14px 16px; background: none; border: none;
    border-bottom: 1px solid var(--border-light); font-family: sans-serif;
    font-size: 14px; color: var(--text-secondary); text-align: left;
  }
  #hamburger-wrap { position: relative; }

  /* ── Bottom Nav ── */
  #bottom-nav {
    position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
    width: 100%; max-width: 402px;
    background: var(--nav-bg); border-top: 1px solid var(--nav-border);
    display: flex; justify-content: center; align-items: center;
    height: 90px; box-sizing: border-box; z-index: 60; overflow: visible;
  }
  #bottom-nav-inner {
    display: flex; justify-content: space-around; align-items: center;
    width: 100%; max-width: 390px; height: 100%;
    padding-top: 4px; padding-bottom: 18px; box-sizing: border-box;
  }
  .nav-tab {
    background: none; border: none; display: flex; align-items: center;
    justify-content: center; padding: 0 12px; height: 100%;
  }
  #btn-new {
    background: none; border: none; display: flex; align-items: center;
    justify-content: center; padding: 0 12px; position: relative; bottom: 3px;
  }
  #btn-new-circle {
    width: 50px; height: 50px; border-radius: 50%; background: #c07a8a;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 14px rgba(192,122,138,0.45);
    transition: background 0.15s ease;
  }
  body.dark-mode #btn-new-circle { box-shadow: none; }

  /* ── Cards / shared ── */
  .card {
    background: var(--bg-card); border-radius: 14px; border: 1px solid var(--border);
    padding: 14px 16px; display: flex; align-items: center; gap: 14px;
    cursor: pointer;
  }
  .icon-bubble {
    width: 44px; height: 44px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  .section-label {
    font-size: 11px; color: var(--text-secondary); letter-spacing: 0.1em;
    text-transform: uppercase; font-family: sans-serif;
    padding-left: 10px;
  }
  .field-label {
    font-size: 12px; font-weight: 600; color: var(--text-secondary);
    letter-spacing: 0.05em; text-transform: uppercase;
    font-family: sans-serif; margin-bottom: 6px;
  }
  .field-input {
    width: 100%; padding: 9px 14px; font-size: 16px;
    border: 1.5px solid var(--border); border-radius: 10px;
    background: var(--bg-input); color: var(--text-primary); outline: none;
    font-family: sans-serif; margin-bottom: 16px;
    -webkit-appearance: none;
  }
  .field-input:focus { border-color: #c07a8a; }
  textarea.field-input { height: 100px; resize: none; line-height: 1.5; color: var(--text-primary); background: var(--bg-input); }

  /* ── Week Strip Carousel ── */
  #week-strip {
    padding: 16px 20px 0;
    position: relative;
  }
  #week-strip-scroll {
    overflow-x: scroll;
    overflow-y: visible;
    scrollbar-width: none;
    -ms-overflow-style: none;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: var(--week-strip-bg);
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
  }
  #week-strip-scroll::-webkit-scrollbar { display: none; }
  #week-strip-inner {
    display: flex;
    width: max-content;
  }
  .week-page {
    display: flex;
    justify-content: space-between;
    padding: 12px 10px 10px;
    flex-shrink: 0;
    scroll-snap-align: start;
    scroll-snap-stop: always;
    box-sizing: border-box;
  }
  .week-day { display: flex; flex-direction: column; align-items: center; gap: 6px; flex: 1; }
  .week-day-label { font-size: 11px; font-family: sans-serif; letter-spacing: 0.03em; }
  .week-day-num-wrap {
    width: 30px; height: 30px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
  }
  .week-day-num { font-size: 14px; font-family: sans-serif; }
  .week-day-dot { width: 6px; height: 6px; border-radius: 50%; cursor: pointer; }
  /* Tooltip */
  #week-tooltip {
    position: absolute;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px 14px;
    box-shadow: 0 6px 24px rgba(0,0,0,0.32);
    z-index: 80;
    white-space: nowrap;
    display: none;
    pointer-events: auto;
    --caret-left: 50%;
  }
  /* Caret points UP (tooltip is below the date cell) */
  #week-tooltip::before {
    content: '';
    position: absolute;
    bottom: 100%;
    left: var(--caret-left);
    transform: translateX(-50%);
    border-left: 7px solid transparent;
    border-right: 7px solid transparent;
    border-bottom: 7px solid #ede9e2;
  }
  #week-tooltip::after {
    content: '';
    position: absolute;
    bottom: calc(100% - 1px);
    left: var(--caret-left);
    transform: translateX(-50%);
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 6px solid var(--bg-card);
  }

  /* Picker tooltip (in New/Edit Date popups) */
  .picker-tooltip {
    position: absolute;
    background: #fff;
    border: 1px solid #ede9e2;
    border-radius: 10px;
    padding: 8px 14px;
    box-shadow: 0 6px 24px rgba(0,0,0,0.32);
    z-index: 80;
    white-space: nowrap;
    display: none;
    pointer-events: auto;
    --caret-left: 50%;
  }
  .picker-tooltip::before {
    content: '';
    position: absolute;
    bottom: 100%;
    left: var(--caret-left);
    transform: translateX(-50%);
    border-left: 7px solid transparent;
    border-right: 7px solid transparent;
    border-bottom: 7px solid #ede9e2;
  }
  .picker-tooltip::after {
    content: '';
    position: absolute;
    bottom: calc(100% - 1px);
    left: var(--caret-left);
    transform: translateX(-50%);
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 6px solid var(--bg-card);
  }

  /* Tooltips: force light mode colors in dark mode */
  body.dark-mode #week-tooltip,
  body.dark-mode .picker-tooltip {
    background: #f5f1ec;
    border-color: #ddd8d0;
    color: #3a3330;
  }
  body.dark-mode #week-tooltip::before { border-bottom-color: #ddd8d0; }
  body.dark-mode #week-tooltip::after  { border-bottom-color: #f5f1ec; }
  body.dark-mode .picker-tooltip::before { border-bottom-color: #ddd8d0; }
  body.dark-mode .picker-tooltip::after  { border-bottom-color: #f5f1ec; }

  /* ── Next Date Bubble ── */
  #next-date-card {
    border-radius: 14px; padding: 12px 14px; min-height: 70px; box-sizing: border-box;
    display: flex; align-items: center;
  }
  #next-date-card > div { width: 100%; }

  /* Date cards swipe carousel */
  #date-cards-outer {
    margin: 22px 20px 0; border-radius: 14px; overflow: hidden;
    position: relative; min-height: 70px; box-sizing: border-box;
    box-shadow: 0 4px 20px rgba(139,58,82,0.45);
    background: linear-gradient(to right, #8b3a52 50%, #c07a8a 50%);
  }
  body.dark-mode #date-cards-outer { box-shadow: none; }
  body.dark-mode #next-date-card { box-shadow: none !important; }

  #date-cards-scroll {
    overflow-x: scroll; overflow-y: hidden;
    scrollbar-width: none; -ms-overflow-style: none;
    scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;
    display: flex; font-size: 0;
  }
  #date-cards-scroll::-webkit-scrollbar { display: none; }
  #date-cards-inner { display: flex; width: max-content; font-size: 0; }
  .date-card-slide {
    flex-shrink: 0; scroll-snap-align: start; scroll-snap-stop: always;
    box-sizing: border-box; cursor: pointer;
  }
  /* Arrow overlay on right side of card */
  #date-cards-arrows {
    position: absolute; right: 0; top: 0; bottom: 0;
    display: flex; align-items: center; gap: 0; pointer-events: none;
  }
  #date-cards-arrows button {
    pointer-events: all; background: none; border: none;
    padding: 4px 6px; display: flex; align-items: center; cursor: pointer;
  }
  #date-btn-next { margin-right: 11px; }
  .date-card-row1 { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .date-card-day { font-size: 17px; font-weight: 700; color: #fff; letter-spacing: -0.01em; }
  .date-card-sub { font-size: 13px; color: rgba(255,255,255,0.6); font-family: sans-serif; }
  .date-nav-btn { background: none; border: none; padding: 2px 5px; display: flex; align-items: center; }
  .date-card-row2 { display: flex; align-items: center; gap: 8px; }
  .date-card-venue { font-size: 20px; font-weight: 700; color: #fff; letter-spacing: -0.01em; line-height: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .date-card-row3 { display: flex; align-items: center; gap: 4px; margin-top: 6px; }
  .date-card-loc { font-size: 13px; color: rgba(255,255,255,0.6); font-family: sans-serif; }

  /* ── Catalog view ── */
  #catalog-list { padding: 20px 20px 0; display: flex; flex-direction: column; gap: 10px; }
  .catalog-item-name { font-size: 15px; font-weight: 600; color: var(--text-primary); }
  .catalog-item-sub { font-size: 12px; color: var(--text-secondary); font-family: sans-serif; margin-top: 2px; }
  .catalog-item-note { font-size: 12px; color: var(--text-muted); font-style: italic; margin-top: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  #catalog-new-btn {
    margin: 20px 20px 0; width: calc(100% - 40px); padding: 12px 0;
    background: transparent; border-radius: 12px; font-size: 13px;
    font-weight: 600; font-family: sans-serif;
    display: flex; align-items: center; justify-content: center; gap: 6px;
    border: 1.5px solid;
  }

  /* ── Calendar ── */
  #cal-wrap { padding: 20px; }
  #cal-card { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border); padding: 16px; }
  #cal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
  #cal-month-label { font-size: 15px; font-weight: 700; color: var(--text-muted); letter-spacing: 0.01em; }
  .cal-nav-btn { background: none; border: none; padding: 4px 8px; border-radius: 8px; display: flex; align-items: center; cursor: pointer; }
  #cal-dow { display: grid; grid-template-columns: repeat(7,1fr); margin-bottom: 8px; }
  .cal-dow-cell { text-align: center; font-size: 11px; color: var(--text-muted); font-family: sans-serif; font-weight: 600; padding: 4px 0; }
  #cal-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 2px; }
  .cal-day {
    aspect-ratio: 1; border-radius: 8px; border: none;
    background: transparent; color: var(--text-primary);
    font-family: sans-serif; font-size: 14px;
    cursor: pointer; position: relative;
    display: flex; align-items: center; justify-content: center;
  }
  .cal-day.today { background: rgba(192,122,138,0.15); color: #c07a8a; font-weight: 700; border-radius: 8px; }
  .cal-day.selected { background: #c07a8a !important; color: #fff !important; font-weight: 700; border-radius: 8px !important; }
  .cal-dot {
    position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%);
    width: 5px; height: 5px; border-radius: 50%; background: #c07a8a;
  }
  .cal-dot.past { background: #b0a090; }
  .cal-dot.selected { background: #fff; }
  #cal-selected-card { margin-top: 20px; }
  #cal-upcoming { margin-top: 20px; }
  .upcoming-item {
    display: flex; align-items: center; gap: 14px; padding: 12px 14px;
    background: var(--bg-card); border-radius: 14px; border: 1.5px solid var(--border);
    cursor: pointer; margin-bottom: 8px;
  }
  .upcoming-item.highlighted {
    background: #c07a8a !important; border-color: transparent !important;
    box-shadow: 0 2px 12px rgba(192,122,138,0.3);
  }
  .upcoming-date-badge { width: 40px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; }
  .upcoming-month { font-size: 10px; font-family: sans-serif; font-weight: 600; color: var(--text-muted); letter-spacing: 0.06em; text-transform: uppercase; }
  .upcoming-day-num { font-size: 22px; font-weight: 700; color: var(--text-primary); line-height: 1.1; }
  .upcoming-divider { width: 1px; height: 36px; background: var(--border); flex-shrink: 0; }
  .upcoming-info { flex: 1; min-width: 0; overflow: hidden; }
  .upcoming-venue-row { display: flex; align-items: center; gap: 7px; margin-bottom: 2px; min-width: 0; }
  .upcoming-venue { font-size: 15px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.01em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }
  .upcoming-sub { font-size: 12px; color: var(--text-secondary); font-family: sans-serif; }
  .highlighted .upcoming-month { color: rgba(255,255,255,0.7); }
  .highlighted .upcoming-day-num { color: #fff; }
  .highlighted .upcoming-divider { background: rgba(255,255,255,0.25); }
  .highlighted .upcoming-venue { color: #fff; }
  .highlighted .upcoming-sub { color: rgba(255,255,255,0.65); }

  /* ── New Idea Sheet ── */
  #sheet-overlay { position: fixed; inset: 0; z-index: 55; display: none; }
  #idea-sheet, #todo-sheet {
    position: fixed; bottom: 68px; left: 50%; transform: translateX(-50%);
    width: 100%; max-width: 402px;
    background: var(--bg); border-radius: 20px 20px 0 0;
    border-top: 1px solid var(--border); border-left: 1px solid var(--border); border-right: 1px solid var(--border);
    max-height: calc(70vh); display: none;
    z-index: 56; box-shadow: 0 -8px 32px rgba(0,0,0,0.08);
  }
  #idea-sheet { flex-direction: column; overflow: hidden; }
  #todo-sheet { overflow-y: auto; padding: 20px 20px 24px; }
  #idea-sheet-body { flex: 1; overflow-y: auto; padding: 16px 20px 36px; min-height: 0; display: flex; flex-direction: column; }
  #sheet-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 20px 14px; flex-shrink: 0; border-bottom: 1px solid var(--border); }
  #sheet-title { font-size: 18px; font-weight: 700; color: var(--text-primary); }
  body.dark-mode #sheet-title { color: var(--popup-title); }
  #sheet-close { background: none; border: none; display: flex; }


  /* ── Rose-tinted date/time pickers ── */
  .rose-picker { color-scheme: light; accent-color: #c07a8a; }
  .rose-picker:focus { border-color: #c07a8a; outline: none; }
  .showtype-check { appearance:none; -webkit-appearance:none; width:16px; height:16px; border:1.5px solid #c8bfb6; border-radius:4px; background:var(--bg-input); cursor:pointer; flex-shrink:0; position:relative; transition: background 0.15s, border-color 0.15s; }
  .showtype-check:checked { background:#c07a8a; border-color:#c07a8a; }
  .showtype-check:checked::after { content:''; position:absolute; left:50%; top:50%; width:5px; height:9px; border:2px solid #fff; border-top:none; border-left:none; transform:translate(-50%, -60%) rotate(45deg); display:block; }
  select.field-input { appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23b0a090' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; cursor: pointer; }
  select.field-input:focus { border-color: #c07a8a; outline: none; }  #detail-overlay {
    position: fixed; inset: 0; background: rgba(30,20,20,0.5);
    display: none; align-items: flex-start; justify-content: center;
    padding-top: 66px; z-index: 200;
  }
  #detail-modal {
    width: calc(100% - 24px); max-width: 390px; background: var(--bg);
    border-radius: 20px; overflow: hidden;
    max-height: 80vh; overflow-y: auto;
  }
  #detail-banner { overflow: hidden; border-radius: 20px 20px 0 0; flex-shrink: 0; }
  #detail-padded { padding: 20px 20px 32px; }
  #detail-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px; }
  #detail-title { font-size: 17px; font-weight: 700; color: var(--text-primary); outline: none; text-decoration: none; }
  body.dark-mode #detail-title { color: var(--popup-title); }

  /* ── Home quick rows ── */
  .quick-row {
    display: flex; align-items: center; gap: 14px; padding: 12px 14px;
    background: var(--bg-card); border-radius: 14px; border: 1px solid var(--border);
  }
  .quick-row-name { font-size: 15px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.01em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .quick-row-sub { font-size: 12px; color: var(--text-secondary); font-family: sans-serif; margin-top: 2px; }
  .type-badge {
    font-size: 11px; padding: 3px 8px; border-radius: 10px;
    font-family: sans-serif; font-weight: 500; flex-shrink: 0;
  }

  /* ── Placeholder color ── */
  ::placeholder { color: var(--text-placeholder); opacity: 1; }
  :-ms-input-placeholder { color: var(--text-placeholder); }

  /* ── Idea sheet field rows — match Favorite Places modal exactly ── */
  .idea-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
  .idea-row-top { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 12px; }
  .idea-row .field-input, .idea-row-top .field-input { flex: 1; margin-bottom: 0; }
  .todo-link { color:#2a1f1f; font-weight:700; cursor:pointer; margin-left:1px; }
  .todo-link.done { color:#b0a090; text-decoration:line-through; }
  body.dark-mode .todo-link { color:#dcd6ce; }
  body.dark-mode .todo-link.done { color:#b0a090; }
  /* Edit Categories dark mode */
  body.dark-mode .ec-row { border-bottom-color: #3a3330 !important; }
  body.dark-mode .ec-row input { color: #f0ede9 !important; }
  .img-field-row { display:flex; align-items:center; gap:6px; margin-bottom:8px; }
  .img-field-row .field-input { flex:1 !important; width:auto !important; margin-bottom:0 !important; min-width:0; box-sizing:border-box; }
  .img-btn { background:none; border:none; cursor:pointer; padding:0; display:flex !important; align-items:center; justify-content:center; flex-shrink:0; width:20px !important; height:20px !important; line-height:0; }
  .idea-row-icon { width: 18px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
  .idea-row-icon button { background: none; border: none; padding: 0; cursor: pointer; display: flex; }
  textarea.idea-sheet-area { flex: 1; padding: 8px 14px; font-size: 16px; border: 1.5px solid var(--border); border-radius: 10px; background: var(--bg-input); color: var(--text-primary); outline: none; font-family: sans-serif; resize: none; line-height: 1.5; margin-bottom: 0; }
  textarea.idea-sheet-area:focus { border-color: #c07a8a; }

  /* scrollbar hide */
  ::-webkit-scrollbar { display: none; }

  body.dark-mode .icon-close { stroke: var(--icon-close) !important; }
  body.dark-mode .icon-close-fill { fill: var(--icon-close) !important; }
  body.dark-mode .btn-outline { border-color: #9a8a7a !important; }
  body.dark-mode .popup-overlay { background: rgba(10,8,8,0.75) !important; }
</style>
</head>
<body>
<div id="app">

  <!-- TOP NAV -->
  <div id="top-nav">
  <div id="top-nav-inner">
  <div id="top-nav-main-row">
    <button id="nav-logo" onclick="navigate('home')">
      <svg viewBox="0 0 28 18" width="28" height="18" fill="none">
        <circle id="logo-circle-light" cx="11" cy="9" r="7.5" stroke="#c07a8a" stroke-width="2.8"/>
        <circle id="logo-circle-dark" cx="18" cy="9" r="7.5" stroke="#8b3a52" stroke-width="2.8"/>
      </svg>
      <span>duet</span>
    </button>
    <button id="nav-back" onclick="navigate('home')" style="display:none">
      <svg viewBox="0 0 24 24" width="20" height="20" stroke="#b0a090" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    </button>

    <div id="nav-center">
      <!-- populated by renderNav() -->
    </div>

    <div id="hamburger-wrap">
      <button id="nav-hamburger" onclick="toggleMenu()">
        <span></span><span></span><span></span>
      </button>
      <div id="nav-menu-overlay" onclick="closeMenu()"></div>
      <div id="nav-menu-dropdown">
        <button onclick="exportAllData();closeMenu()">
          <svg viewBox="0 0 24 24" width="16" height="16" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Save
        </button>
        <button onclick="navigate('past');closeMenu()">
          <svg viewBox="0 0 24 24" width="16" height="16" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path d="M2.5 8A9 9 0 1 1 3.5 15"/><polyline points="2 4 2.5 8 7 7.5"/>
          </svg>
          Memories
        </button>
        <button onclick="navigate('archive');closeMenu()">
          <svg viewBox="0 0 24 24" width="16" height="16" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/>
          </svg>
          Archive
        </button>
        <button onclick="closeMenu();openSettings()">
          <svg viewBox="0 0 24 24" width="16" height="16" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
          Settings
        </button>
      </div>
    </div>
  </div><!-- /top-nav-main-row -->
  <div id="top-nav-ideas-row"></div>
  </div>
  </div>

  <!-- MAIN CONTENT -->
  <div id="main-content" class="view"></div>

  <!-- BOTTOM NAV -->
  <div id="bottom-nav">
  <div id="bottom-nav-inner">
    <button class="nav-tab" onclick="navigate('home')" id="tab-home">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="none">
        <circle id="icon-home" cx="12" cy="12" r="8.5" stroke="#b0a090" stroke-width="2"/>
      </svg>
    </button>
    <button class="nav-tab" onclick="navigate('ideas')" id="tab-ideas">
      <svg viewBox="0 0 24 24" width="22" height="22" stroke="#b0a090" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" id="icon-ideas">
        <path d="M8 22h8"/><path d="M12 15.8v6.2"/>
        <path d="M5 3h14l-1.5 9a5 5 0 0 1-5 4h-1a5 5 0 0 1-5-4L5 3z"/>
      </svg>
    </button>
    <button id="btn-new" onclick="handleNewBtn()">
      <div id="btn-new-circle">
        <svg id="btn-new-icon-plus" viewBox="0 0 24 24" width="22" height="22" stroke="#fff" stroke-width="2.5" fill="none" stroke-linecap="round">
          <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        <svg id="btn-new-icon-check" viewBox="0 0 24 24" width="22" height="22" stroke="#fff" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round" style="display:none">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      </div>
    </button>
    <button class="nav-tab" onclick="navigate('calendar')" id="tab-calendar">
      <svg viewBox="0 0 24 24" width="22" height="22" stroke="#b0a090" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" id="icon-calendar">
        <rect x="3" y="4" width="18" height="18" rx="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
    </button>
    <button class="nav-tab" onclick="handleTodoTabTap()" id="tab-todo">
      <svg viewBox="0 0 24 24" width="22" height="22" stroke="#b0a090" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" id="icon-todo"><rect x="3" y="3" width="18" height="18" rx="3"/><polyline points="9 12 11 14 15 10"/></svg>
    </button>
  </div><!-- /bottom-nav-inner -->
  </div><!-- /bottom-nav -->

  <!-- NEW IDEA SHEET -->
  <div id="sheet-overlay" onclick="closeSheet();closeTodoSheet()"></div>
  <div id="idea-sheet">
    <div id="sheet-header">
      <!-- Three-column: title left | toggle center | close right -->
      <div id="sheet-title" style="white-space:nowrap;flex:1"></div>
      <div id="sheet-type-toggle" style="display:none;background:var(--toggle-bg);border-radius:6px;padding:2px;gap:1px;flex-shrink:0">
        <button onclick="switchSheetType('out')" id="stoggle-out" style="padding:3px 10px;border:none;border-radius:5px;font-family:sans-serif;font-size:12px;font-weight:600;cursor:pointer;background:var(--toggle-active-bg);color:var(--toggle-active-color);box-shadow:0 1px 3px rgba(0,0,0,0.1)">Out</button>
        <button onclick="switchSheetType('in')"  id="stoggle-in"  style="padding:3px 10px;border:none;border-radius:5px;font-family:sans-serif;font-size:12px;font-weight:600;cursor:pointer;background:transparent;color:#9a8a7a">In</button>
      </div>
      <div style="flex:1;display:flex;justify-content:flex-end">
        <button id="sheet-close" onclick="closeSheet()">
          <svg viewBox="0 0 24 24" width="20" height="20" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-close">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Scrollable body -->
    <div id="idea-sheet-body">

    <!-- Idea fields (Out / In) -->
    <div id="idea-fields">

      <!-- Name -->
      <div class="idea-row">
        <button id="idea-heart-btn" onclick="toggleIdeaHeart()" style="background:none;border:none;cursor:pointer;padding:0;display:flex;flex-shrink:0"></button>
        <input class="field-input" id="idea-name" type="text" placeholder="Place / activity" style="flex:1;margin-bottom:0">
        <button id="idea-lock-btn" onclick="toggleIdeaPrivate()" type="button" style="background:none;border:none;cursor:pointer;padding:2px;display:flex;flex-shrink:0;color:#9a8a7a" title="Mark as private"></button>
      </div>

      <!-- Category: dynamic icon + dropdown (Out) -->
      <div class="idea-row" id="idea-cat-out-row">
        <button id="idea-cat-icon-btn" onclick="openNewIdeaIconPicker()" title="Change icon" style="width:18px;flex-shrink:0;background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;justify-content:center"></button>
        <select class="field-input" id="idea-cat-select" onchange="onIdeaCatSelectChange()" style="flex:1;margin-bottom:0;min-width:0">
          <option value="restaurant">Restaurant</option>
          <option value="bar">Bar</option>
          <option value="cafe">Cafe</option>
          <option value="movie">Movie</option>
          <option value="museum">Museum</option>
          <option value="bookstore">Bookstore</option>
          <option value="livemusic">Live Music</option>
          <option value="livejazz">Live Jazz</option>
          <option value="concert">Concert</option>
          <option value="livecomedy">Live Comedy</option>
                              <option value="theatre">Theatre</option>
          <option value="venue">Venue</option>
          <option value="park">Park</option>
          <option value="other">Other</option>
        </select>
        <label style="flex-shrink:0;display:flex;align-items:center;cursor:pointer;padding:2px" title="Show type in subtitle">
          <input type="checkbox" id="idea-showtype" checked class="showtype-check">
        </label>
      </div>

      <!-- Category: dynamic icon + dropdown (In) -->
      <div class="idea-row" id="idea-cat-in-row" style="display:none">
        <button id="idea-cat-icon-in-btn" onclick="openNewIdeaIconPicker()" title="Change icon" style="width:18px;flex-shrink:0;background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;justify-content:center"></button>
        <select class="field-input" id="idea-cat-select-in" onchange="onIdeaCatSelectChange()" style="flex:1;margin-bottom:0">
          <option value="orderin">Delivery</option>
          <option value="Cook">Cook</option>
          <option value="Movie">Movie</option>
          <option value="Game">Game</option>
          <option value="Activity">Activity</option>
          <option value="Other">Other</option>
        </select>
        <label style="flex-shrink:0;display:flex;align-items:center;cursor:pointer;padding:2px" title="Show type in subtitle">
          <input type="checkbox" id="idea-showtype-in" checked class="showtype-check">
        </label>
      </div>

      <!-- OUT-only fields -->
      <div id="out-fields-wrap">

        <!-- Cuisine (shown for restaurant/cafe) -->
        <div class="idea-row" id="cuisine-wrap" style="display:none">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><path d="M12 4a8 8 0 0 1 8 8H4a8 8 0 0 1 8-8z"/><path d="M12 4V2"/><circle cx="12" cy="2" r="1" fill="#c07a8a" stroke="none"/><path d="M2 12h20"/><path d="M3 15h18"/></svg>
          <input class="field-input" id="idea-cuisine" type="text" placeholder="Cuisine (e.g. Italian, Japanese)" style="flex:1;margin-bottom:0">
        </div>

        <!-- Image URLs -->
        <div id="idea-images-wrap" style="margin-bottom:12px;display:flex;align-items:center;gap:10px">
          <button id="idea-img-icon-btn" title="Search for photos" style="background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;flex-shrink:0;line-height:0">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          </button>
          <button id="idea-img-count-box" onclick="openImagesPopup('idea-image-fields', _getIdeaImgsearchName)" style="flex:1;padding:9px 14px;font-size:16px;font-family:sans-serif;background:var(--bg-input);border:1.5px solid var(--border);border-radius:10px;text-align:left;cursor:pointer;color:var(--text-placeholder);margin-bottom:0">No images</button>
          <div id="idea-image-fields" style="display:none"></div>
        </div>

        <!-- Short description (shown for all other out types) -->
        <div class="idea-row" id="idea-shortdesc-wrap" style="display:none">
          <svg viewBox="0 0 24 24" width="18" height="18" style="flex-shrink:0" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="17" x2="12" y2="11"/><circle cx="12" cy="7" r="1.2" fill="#9a8a7a" stroke="none"/></svg>
          <input class="field-input" id="idea-shortdesc" type="text" placeholder="Short description…" style="flex:1;margin-bottom:0">
        </div>

        <!-- About (long description) -->
        <div class="idea-row" id="idea-about-wrap" style="display:none">
          <div style="width:18px;flex-shrink:0"></div>
          <textarea class="idea-sheet-area" id="idea-about" rows="2" placeholder="Long description (ambience, etc)…" style="flex:1;margin-bottom:0"></textarea>
        </div>

        <!-- Address -->
        <div class="idea-row">
          <button onclick="ideaMapsAddress()" title="Open in Google Maps" style="background:none;border:none;cursor:pointer;padding:0;display:flex;flex-shrink:0">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
          </button>
          <input class="field-input" id="idea-address" type="text" placeholder="Address" style="flex:1;margin-bottom:0">
        </div>
        <!-- Neighborhood -->
        <div class="idea-row">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>
          <input class="field-input" id="idea-neighborhood" type="text" placeholder="Neighborhood (e.g. Williamsburg)" style="flex:1;margin-bottom:0">
        </div>

        <!-- Subway -->
        <div style="margin-bottom:12px">
          <div style="display:flex;align-items:center;gap:10px">
            <button onclick="ideaTransitDirections()" title="Transit directions from home" style="background:none;border:none;cursor:pointer;padding:0;display:flex;flex-shrink:0">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#9a8a7a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><text x="12" y="16.5" text-anchor="middle" font-family="'Helvetica Neue','Arial Black',Arial,sans-serif" font-weight="900" font-size="13" fill="#9a8a7a" stroke="none">A</text></svg>
            </button>
            <input class="field-input" id="idea-subway" type="text" placeholder="Transit (e.g. A C to 14th St 25min)" oninput="renderIdeaSubwayBadges()" style="flex:1;margin-bottom:0">
          </div>
          <div id="idea-subway-badges" style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-top:0;margin-left:28px;min-height:0"></div>
        </div>

        <!-- Walk/Drive -->
        <div style="margin-bottom:12px">
          <div style="display:flex;align-items:center;gap:10px">
            <button onclick="ideaWalkingDirections()" title="Walking directions from home" style="background:none;border:none;cursor:pointer;padding:0;display:flex;flex-shrink:0">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="#9a8a7a"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/></svg>
            </button>
            <input class="field-input" id="idea-walkdrive" type="text" placeholder="Walk / Drive (e.g. 20min walk / 8min drive)" oninput="renderIdeaWalkDriveBadges()" style="flex:1;margin-bottom:0">
          </div>
          <div id="idea-walkdrive-badges" style="display:flex;align-items:center;gap:8px;margin-top:0;margin-left:28px;min-height:0"></div>
        </div>

        <!-- Reservation -->
        <div id="reservation-wrap" style="margin-bottom:12px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
            <button onclick="ideaOpenReservation()" title="Open reservation" style="background:none;border:none;cursor:pointer;padding:0;display:flex;flex-shrink:0">
              <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><line x1="9" y1="9" x2="9" y2="15"/><line x1="12" y1="9" x2="12" y2="15"/><line x1="15" y1="9" x2="15" y2="15"/></svg>
            </button>
            <select class="field-input" id="idea-reservation" onchange="onIdeaReservationChange()" style="flex:1;margin-bottom:0">
              <option value="website">Website</option>
              <option value="resy">Resy</option>
              <option value="opentable">OpenTable</option>
              <option value="eventbrite">Eventbrite</option>
              <option value="none">No reservation needed</option>
            </select>
          </div>
          <div id="idea-website-wrap" style="display:none;margin-left:28px;margin-bottom:12px">
            <input class="field-input" id="idea-website-url" type="text" placeholder="Website URL" style="margin-bottom:0">
          </div>
          <div id="idea-eventbrite-wrap" style="display:none;margin-left:28px;margin-bottom:12px">
            <input class="field-input" id="idea-eventbrite-url" type="text" placeholder="Eventbrite URL" style="margin-bottom:0">
          </div>
        </div>
      </div><!-- /out-fields-wrap -->
      <input type="hidden" id="idea-note-short" value="">

      <!-- IN-only fields -->
      <div id="in-fields-wrap" style="display:none;flex-direction:column;flex:1;min-height:0">
        <!-- Images -->
        <div id="idea-in-images-wrap" style="margin-bottom:12px;display:flex;align-items:center;gap:10px">
          <button id="idea-in-img-icon-btn" title="Search for photos" style="background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;flex-shrink:0;line-height:0">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          </button>
          <button id="idea-img-count-box-in" onclick="openImagesPopup('idea-image-fields', _getIdeaImgsearchName)" style="flex:1;padding:9px 14px;font-size:16px;font-family:sans-serif;background:var(--bg-input);border:1.5px solid var(--border);border-radius:10px;text-align:left;cursor:pointer;color:var(--text-placeholder);margin-bottom:0">No images</button>
        </div>
        <!-- Short description -->
        <div class="idea-row" id="idea-in-shortdesc-wrap">
          <svg viewBox="0 0 24 24" width="18" height="18" style="flex-shrink:0" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="17" x2="12" y2="11"/><circle cx="12" cy="7" r="1.2" fill="#9a8a7a" stroke="none"/></svg>
          <input class="field-input" id="idea-in-shortdesc" type="text" placeholder="Short description…" style="flex:1;margin-bottom:0">
        </div>
        <!-- About (long description) -->
        <div class="idea-row-top" id="idea-in-note-row" style="flex:1;min-height:0">
          <div style="width:18px;flex-shrink:0;margin-top:10px"></div>
          <textarea class="idea-sheet-area" id="idea-note-long" placeholder="Long description…" style="flex:1;height:100%;min-height:80px;resize:none"></textarea>
        </div>
      </div>

    </div>

    <!-- Date fields (Calendar) -->
    <div id="date-fields" style="display:none">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
        <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0">
          <path d="M8 22h8"/><path d="M12 15.8v6.2"/><path d="M5 3h14l-1.5 9a5 5 0 0 1-5 4h-1a5 5 0 0 1-5-4L5 3z"/>
        </svg>
        <button id="date-activity-btn" onclick="openIdeasPicker()"
          style="flex:1;padding:9px 14px;background:var(--bg-input);border:1.5px solid var(--border);border-radius:10px;font-family:sans-serif;color:var(--text-primary);text-align:left;cursor:pointer;display:flex;align-items:center;gap:10px;margin-bottom:0">
          <span id="date-activity-icon" style="display:none"></span>
          <span id="date-activity-label" style="flex:1;font-size:16px;color:var(--text-placeholder)">Date ideas…</span>
          <span id="date-activity-info-btn" onclick="openDetailFromActivity('date-activity-info-btn',event)" style="display:none;width:20px;height:20px;background:#c07a8a;border-radius:50%;flex-shrink:0;align-items:center;justify-content:center;cursor:pointer"><svg viewBox="0 0 24 24" width="11" height="11" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></span>
        </button>
      </div>
      <!-- Custom activity text input (shown when Custom selected) -->
      <div id="date-custom-wrap" style="display:none;align-items:center;gap:10px;margin-bottom:18px">
        <div style="width:18px;flex-shrink:0"></div>
        <input class="field-input" id="date-custom-name" type="text" placeholder="Place / activity" style="flex:1;margin-bottom:0">
      </div>
      <!-- Calendar icon + week picker on same row -->
      <div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:8px">
        <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0;margin-top:10px">
          <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        <div style="flex:1;min-width:0">
          <div id="date-picker-wrap" style="position:relative;margin-bottom:8px">
            <div id="date-picker-scroll" style="overflow-x:scroll;overflow-y:visible;scrollbar-width:none;-ms-overflow-style:none;border-radius:14px;border:1px solid var(--border);background:var(--popup-week-bg);scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch">
              <div id="date-picker-inner" style="display:flex;width:max-content"></div>
            </div>
            <div id="date-picker-tooltip" class="picker-tooltip"></div>
          </div>
          <div style="display:flex;gap:8px">
            <div style="position:relative;flex:1">
              <svg style="position:absolute;left:13px;top:50%;transform:translateY(-50%);pointer-events:none;z-index:1" viewBox="0 0 24 24" width="16" height="16" stroke="#c07a8a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              <input class="field-input" id="date-day-text" type="text" placeholder="e.g. 3/3, March 3" style="padding-left:38px;margin-bottom:0" onblur="finalizePickerText('date')">
              <input type="hidden" id="date-day" value="">
            </div>
            <div style="position:relative;flex:1">
              <svg style="position:absolute;left:13px;top:50%;transform:translateY(-50%);pointer-events:none;z-index:1" viewBox="0 0 24 24" width="16" height="16" stroke="#c07a8a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
              </svg>
              <input class="field-input" id="date-time-select" type="text" placeholder="e.g. 8, 11am" style="padding-left:38px;margin-bottom:0" oninput="formatTimeInput(this)" onblur="finalizeTime(this)">
            </div>
          </div>
        </div>
      </div>
      <!-- In-location (only for In activities) -->
      <div id="date-in-location-wrap" style="display:none;margin-top:18px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
          <select class="field-input" id="date-in-location-select" onchange="onDateInLocationChange()" style="margin-bottom:0;flex:1">
            <option value="my_place">My place</option>
            <option id="date-in-partner-option" value="partner_place">Her place</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div id="date-in-location-other-wrap" style="display:none;align-items:center;gap:10px;margin-bottom:12px">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
          <input class="field-input" id="date-in-location-other" type="text" placeholder="Address or place name" style="flex:1;margin-bottom:0">
        </div>
      </div>
      <!-- Location: text input for Out/Custom -->
      <div id="date-location-text-wrap" style="display:none;align-items:center;gap:10px;margin-top:18px;margin-bottom:12px">
        <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
        <input class="field-input" id="date-location-text" type="text" placeholder="Address (e.g. 123 Metropolitan Ave, Brooklyn, NY)" style="flex:1;margin-bottom:0">
      </div>
      <!-- Neighborhood (Custom activity only) -->
      <div id="date-neighborhood-wrap" style="display:none;align-items:center;gap:10px;margin-bottom:12px">
        <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>
        <input class="field-input" id="date-neighborhood" type="text" placeholder="Neighborhood (e.g. Williamsburg)" style="flex:1;margin-bottom:0">
      </div>
      <div style="display:flex;align-items:center;gap:10px;margin-top:12px;margin-bottom:12px">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" style="flex-shrink:0">
          <line x1="4" y1="5" x2="20" y2="5" stroke="#9a8a7a" stroke-width="2" stroke-linecap="round"/>
          <line x1="4" y1="10" x2="17" y2="10" stroke="#9a8a7a" stroke-width="2" stroke-linecap="round"/>
          <line x1="4" y1="15" x2="20" y2="15" stroke="#9a8a7a" stroke-width="2" stroke-linecap="round"/>
          <line x1="4" y1="20" x2="13" y2="20" stroke="#9a8a7a" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <input class="field-input" id="date-note" type="text" placeholder="Note…" style="flex:1;margin-bottom:0">
      </div>
      <!-- Images -->
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:0">
        <button id="date-img-icon-btn" title="Search for photos" style="background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;flex-shrink:0;line-height:0">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        </button>
        <button id="date-img-count-box" onclick="openImagesPopup('date-image-fields', _getDateImgsearchName)" style="flex:1;padding:9px 14px;font-size:16px;font-family:sans-serif;background:var(--bg-input);border:1.5px solid var(--border);border-radius:10px;text-align:left;cursor:pointer;color:var(--text-placeholder);margin-bottom:0">No images</button>
        <div id="date-image-fields" style="display:none"></div>
      </div>
      <!-- Privacy box -->
      <div style="display:flex;align-items:center;gap:10px;margin-top:12px;padding-bottom:8px">
        <button id="date-lock-icon" onclick="toggleDatePrivate()" type="button" style="background:none;border:none;cursor:pointer;padding:0;display:flex;flex-shrink:0;color:#9a8a7a"></button>
        <button id="date-privacy-box" onclick="toggleDatePrivate()" style="flex:1;padding:9px 14px;font-size:16px;font-family:sans-serif;background:var(--bg-input);border:1.5px solid var(--border);border-radius:10px;text-align:left;cursor:pointer;color:var(--text-placeholder);margin-bottom:0">Not private</button>
      </div>
    </div>
    </div><!-- /idea-sheet-body -->
  </div>

  <!-- IDEAS PICKER MODAL -->
  <div id="ideas-picker-overlay" class="popup-overlay" onclick="closeIdeasPicker()" style="position:fixed;inset:0;background:rgba(30,20,20,0.5);z-index:500;display:none;align-items:center;justify-content:center;padding:20px">
    <div id="ideas-picker-sheet" onclick="event.stopPropagation()" style="width:100%;max-width:370px;background:var(--bg);border-radius:20px;padding:20px 20px 24px;height:76vh;display:flex;flex-direction:column;box-shadow:0 12px 48px rgba(0,0,0,0.18)">
      <!-- Header: title + X -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-shrink:0">
        <div style="font-size:17px;font-weight:700;color:var(--popup-title)">Date Ideas</div>
        <button onclick="closeIdeasPicker()" style="background:none;border:none;display:flex;cursor:pointer">
          <svg viewBox="0 0 24 24" width="20" height="20" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-close"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <!-- Filter toggle + search bar (mirrors Date Ideas screen) -->
      <div id="picker-controlbar" style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-shrink:0">
        <div id="picker-toggle" style="display:flex;background:var(--toggle-bg);border-radius:20px;padding:2px;gap:1px;flex-shrink:0">
          <button id="ptab-all" onclick="setPickerFilter('all')" style="padding:4px 12px;border:none;border-radius:18px;font-family:sans-serif;font-size:12px;font-weight:600;cursor:pointer;background:var(--toggle-active-bg);color:var(--toggle-active-color);box-shadow:0 1px 3px rgba(0,0,0,0.10)">All</button>
          <button id="ptab-out" onclick="setPickerFilter('out')" style="padding:4px 12px;border:none;border-radius:18px;font-family:sans-serif;font-size:12px;font-weight:600;cursor:pointer;background:transparent;color:#9a8a7a">Out</button>
          <button id="ptab-in"  onclick="setPickerFilter('in')"  style="padding:4px 12px;border:none;border-radius:18px;font-family:sans-serif;font-size:12px;font-weight:600;cursor:pointer;background:transparent;color:#9a8a7a">In</button>
          <button id="ptab-favs" onclick="setPickerFilter('favs')" style="padding:4px 10px;border:none;border-radius:18px;font-family:sans-serif;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px;background:transparent;color:#9a8a7a"><svg viewBox="0 0 24 24" width="13" height="13" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></button>
        </div>
        <div style="display:flex;align-items:center;background:var(--toggle-bg);border-radius:20px;padding:5px 10px;gap:6px;flex:1;min-width:0">
          <svg viewBox="0 0 24 24" width="13" height="13" stroke="#9a8a7a" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input id="picker-search-input" type="text" oninput="setPickerSearch(this.value)" placeholder="" style="border:none;background:transparent;outline:none;font-size:16px;font-family:sans-serif;color:var(--text-primary);width:100%;line-height:1;padding:0;min-width:0">
          <button id="picker-search-clear" onclick="setPickerSearch('');document.getElementById('picker-search-input').value=''" style="background:none;border:none;cursor:pointer;padding:0;display:none;flex-shrink:0;line-height:0"><svg viewBox="0 0 24 24" width="13" height="13" stroke="#9a8a7a" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
      </div>
      <!-- Scrollable list -->
      <div id="ideas-picker-body" style="overflow-y:auto;flex:1;min-height:0"></div>
    </div>
  </div>

  <!-- DETAIL MODAL -->
  <div id="detail-overlay" class="popup-overlay" onclick="closeDetail()">
    <div id="detail-modal" onclick="event.stopPropagation()">
      <div id="detail-banner"></div>
      <div id="detail-padded" style="background:var(--bg)">
      <div id="detail-header">
        <!-- Title row: title + heart right of title -->
        <div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0">
          <div style="min-width:0;flex:1">
            <div style="display:flex;align-items:center;gap:6px">
              <a id="detail-title" style="font-size:17px;font-weight:700;text-decoration:none;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;outline:none" target="_blank" rel="noopener"></a>
              <button id="detail-heart-btn" onclick="toggleSavedCurrent()" style="background:none;border:none;display:flex;padding:1px;cursor:pointer;flex-shrink:0;line-height:0"></button>
            </div>
            <div id="detail-subtitle" style="font-size:13px;color:#b0a090;font-style:italic;margin-top:6px"></div>
          </div>
        </div>
        <!-- Right side: 3-dot (opens edit) + close — no gap between them -->
        <div id="detail-header-btns" style="display:flex;align-items:center;flex-shrink:0;margin-left:8px;padding-top:2px">
          <button onclick="editIdea(detailItemId)" style="background:none;border:none;display:flex;padding:6px 2px;cursor:pointer;align-items:center">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="#888" class="icon-close-fill"><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg>
          </button>
          <button onclick="closeDetail()" style="background:none;border:none;display:flex;padding:4px 2px;cursor:pointer">
            <svg viewBox="0 0 24 24" width="20" height="20" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-close">
              <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
      </div>
      <div id="detail-body"></div>
      </div><!-- /detail-padded -->
    </div>
  </div>

  <!-- DATE INFO OVERLAY — same structure as detail modal -->
  <div id="date-info-overlay" class="popup-overlay" onclick="closeDateInfo()" style="position:fixed;inset:0;background:rgba(30,20,20,0.5);z-index:400;display:none;align-items:flex-start;justify-content:center;padding-top:66px">
    <div id="date-info-modal" onclick="event.stopPropagation()" style="width:calc(100% - 24px);max-width:390px;background:var(--bg);border-radius:20px;overflow:hidden;max-height:80vh;overflow-y:auto;box-shadow:0 12px 48px rgba(0,0,0,0.18)">

      <!-- Banner slot (image if available) -->
      <div id="di-banner" style="display:none"></div>

      <!-- Padded content -->
      <div id="di-padded" style="padding:20px 20px 32px;background:var(--bg)">

        <!-- Header: title + heart, 3-dot edit, close -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
          <div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0">
            <div style="min-width:0;flex:1">
              <div style="display:flex;align-items:center;gap:6px">
                <div id="di-title" style="font-size:17px;font-weight:700;color:var(--popup-title);white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></div>
              </div>
              <div id="di-subtitle" style="font-size:13px;color:#b0a090;font-style:italic;margin-top:6px;display:none"></div>
            </div>
          </div>
          <div id="di-header-btns" style="display:flex;align-items:center;flex-shrink:0;margin-left:8px;padding-top:2px">
            <button id="di-edit-btn" onclick="editDateFromInfo()" style="background:none;border:none;display:flex;padding:6px 2px;cursor:pointer;align-items:center">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="#888" class="icon-close-fill"><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg>
            </button>
            <button onclick="closeDateInfo()" style="background:none;border:none;cursor:pointer;display:flex;padding:4px 2px;align-items:center">
              <svg viewBox="0 0 24 24" width="20" height="20" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-close"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>
        </div>

        <!-- Body rows -->
        <div id="di-form">
          <!-- Time row -->
          <div id="di-time-row" style="display:none;align-items:center;gap:10px;margin-bottom:14px">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            <span id="di-time" style="font-size:14px;font-family:sans-serif;color:#9a8a7a"></span>
          </div>
          <!-- Address row -->
          <div id="di-address-row" style="display:none;align-items:center;gap:10px;margin-bottom:14px">
            <a id="di-address-pin-link" href="#" target="_blank" rel="noopener" style="display:flex;flex-shrink:0">
              <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
            </a>
            <a id="di-address" href="#" target="_blank" rel="noopener" style="font-size:14px;font-family:sans-serif;color:#9a8a7a;text-decoration:none"></a>
          </div>
          <!-- Subway row -->
          <!-- Commute row (subway + walk/drive on same line, centered, clickable) -->
          <div id="di-commute-row" style="display:none;margin-top:40px;margin-bottom:14px">
            <div style="display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap" id="di-commute-inner"></div>
            <div id="di-leaveby-row" style="display:none;margin-top:6px;text-align:center">
              <span style="font-size:13px;font-family:sans-serif;color:#9a8a7a">Leave by </span>
              <span id="di-leaveby-time" style="font-size:13px;font-family:sans-serif;color:var(--popup-title);font-weight:600"></span>
            </div>
          </div>
          <!-- About row -->
          <div id="di-about-row" style="display:none;align-items:flex-start;gap:10px;margin-bottom:14px">
            <svg style="margin-top:2px;flex-shrink:0" viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="17" x2="12" y2="11"/><circle cx="12" cy="7" r="1.2" fill="#9a8a7a" stroke="none"/></svg>
            <span id="di-about" style="font-size:14px;font-family:sans-serif;color:#9a8a7a;line-height:1.5"></span>
          </div>
        </div>

        <!-- Action buttons (Reserve + Reschedule) -->
        <div id="di-btns-wrap" style="display:none;margin-top:40px;justify-content:center;gap:10px;min-height:34px;align-items:center"></div>

      </div><!-- /di-padded -->
    </div>
  </div>
  <!-- EDIT DATE MODAL -->
  <div id="edit-date-overlay" class="popup-overlay" onclick="closeEditDate()" style="position:fixed;inset:0;background:rgba(30,20,20,0.5);z-index:400;display:none;align-items:center;justify-content:center;padding:16px">
    <div id="edit-date-modal" onclick="event.stopPropagation()" style="width:100%;max-width:390px;background:var(--bg);border-radius:20px;display:flex;flex-direction:column;height:min(88vh,620px);box-shadow:0 12px 48px rgba(0,0,0,0.18)">

      <!-- Header (sticky) -->
      <div style="padding:20px 20px 14px;flex-shrink:0;border-bottom:1px solid var(--border)">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div style="display:flex;align-items:center;gap:10px">
            <button id="ed-prev-btn" onclick="editDateNav(-1)" style="background:none;border:none;cursor:pointer;padding:4px;display:flex;opacity:0.3">
              <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
            </button>
            <div style="font-size:18px;font-weight:700;color:var(--popup-title)">Edit Date</div>
            <button id="ed-next-btn" onclick="editDateNav(1)" style="background:none;border:none;cursor:pointer;padding:4px;display:flex;opacity:0.3">
              <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
            </button>
          </div>
          <button onclick="closeEditDate()" style="background:none;border:none;cursor:pointer;display:flex;padding:4px">
            <svg viewBox="0 0 24 24" width="20" height="20" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-close"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      </div>

      <!-- Scrollable body -->
      <div style="flex:1;overflow-y:auto;padding:16px 20px 0;min-height:0">

        <!-- Activity -->
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0">
            <path d="M8 22h8"/><path d="M12 15.8v6.2"/><path d="M5 3h14l-1.5 9a5 5 0 0 1-5 4h-1a5 5 0 0 1-5-4L5 3z"/>
          </svg>
          <button id="ed-activity-btn" onclick="openIdeasPickerForEdit()"
            style="flex:1;padding:9px 14px;background:var(--bg-input);border:1.5px solid var(--border);border-radius:10px;font-family:sans-serif;color:var(--text-primary);text-align:left;cursor:pointer;display:flex;align-items:center;gap:10px;margin-bottom:0">
            <span id="ed-activity-icon" style="display:none"></span>
            <span id="ed-activity-label" style="flex:1;font-size:16px;color:var(--text-placeholder)">Date ideas…</span>
            <span id="ed-activity-edit-btn" onclick="edEditActivityIdea(event)" style="display:none;width:20px;height:20px;background:#c07a8a;border-radius:50%;flex-shrink:0;align-items:center;justify-content:center;cursor:pointer">
              <svg viewBox="0 0 24 24" width="11" height="11" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
            </span>
          </button>
        </div>
        <div id="ed-custom-wrap" style="display:none;align-items:center;gap:10px;margin-bottom:18px">
          <div style="width:18px;flex-shrink:0"></div>
          <input class="field-input" id="ed-custom-name" type="text" placeholder="Place / activity" style="flex:1;margin-bottom:0">
        </div>

        <!-- Calendar icon + week picker on same row; date+time fields below -->
        <div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:16px">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0;margin-top:10px">
            <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          <div style="flex:1;min-width:0">
            <div id="ed-picker-wrap" style="position:relative;margin-bottom:8px">
              <div id="ed-picker-scroll" style="overflow-x:scroll;overflow-y:visible;scrollbar-width:none;-ms-overflow-style:none;border-radius:14px;border:1px solid var(--border);background:var(--popup-week-bg);scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch">
                <div id="ed-picker-inner" style="display:flex;width:max-content"></div>
              </div>
              <div id="ed-picker-tooltip" class="picker-tooltip"></div>
            </div>
            <div style="display:flex;gap:8px">
              <div style="position:relative;flex:1">
                <svg style="position:absolute;left:13px;top:50%;transform:translateY(-50%);pointer-events:none;z-index:1" viewBox="0 0 24 24" width="16" height="16" stroke="#c07a8a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                <input class="field-input" id="ed-day-text" type="text" placeholder="e.g. 3/3, March 3" style="padding-left:38px;margin-bottom:0" onblur="finalizePickerText('ed')">
                <input type="hidden" id="ed-day" value="">
              </div>
              <div style="position:relative;flex:1">
                <svg style="position:absolute;left:13px;top:50%;transform:translateY(-50%);pointer-events:none;z-index:1" viewBox="0 0 24 24" width="16" height="16" stroke="#c07a8a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                </svg>
                <input class="field-input" id="ed-time" type="text" placeholder="e.g. 8, 11am" style="padding-left:38px;margin-bottom:0" oninput="formatTimeInput(this)" onblur="finalizeTime(this)">
              </div>
            </div>
          </div>
        </div>

        <!-- In-location (only for In activities) -->
        <div id="ed-in-location-wrap" style="display:none;margin-top:18px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
            <select class="field-input" id="ed-in-location-select" onchange="onEdInLocationChange()" style="flex:1;margin-bottom:0">
              <option value="my_place">My place</option>
              <option id="ed-in-partner-option" value="partner_place">Her place</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div id="ed-in-location-other-wrap" style="display:none;align-items:center;gap:10px;margin-bottom:12px">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
            <input class="field-input" id="ed-in-location-other" type="text" placeholder="Address or place name" style="flex:1;margin-bottom:0">
          </div>
        </div>

        <!-- Location (only for Custom activity) -->
        <div id="ed-location-wrap" style="display:none;margin-top:18px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
            <input class="field-input" id="ed-location" type="text" placeholder="Address (e.g. 123 Metropolitan Ave, Brooklyn, NY)" style="flex:1;margin-bottom:0">
          </div>
          <!-- Neighborhood -->
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>
            <input class="field-input" id="ed-neighborhood" type="text" placeholder="Neighborhood (e.g. Williamsburg)" style="flex:1;margin-bottom:0">
          </div>
        </div>

        <!-- Note -->
        <div style="display:flex;align-items:center;gap:10px;margin-top:12px;margin-bottom:12px">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" style="flex-shrink:0">
            <line x1="4" y1="5" x2="20" y2="5" stroke="#9a8a7a" stroke-width="2" stroke-linecap="round"/>
            <line x1="4" y1="10" x2="17" y2="10" stroke="#9a8a7a" stroke-width="2" stroke-linecap="round"/>
            <line x1="4" y1="15" x2="20" y2="15" stroke="#9a8a7a" stroke-width="2" stroke-linecap="round"/>
            <line x1="4" y1="20" x2="13" y2="20" stroke="#9a8a7a" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <input class="field-input" id="ed-note" type="text" placeholder="Note…" style="flex:1;margin-bottom:0">
        </div>

        <!-- Image Links -->
        <div id="ed-images-wrap" style="margin-bottom:0;display:flex;align-items:center;gap:10px">
          <button id="ed-img-icon-btn" title="Search for photos" style="background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;flex-shrink:0;line-height:0">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          </button>
          <button id="ed-img-count-box" onclick="openImagesPopup('ed-image-fields', _getEdImgsearchName)" style="flex:1;padding:9px 14px;font-size:16px;font-family:sans-serif;background:var(--bg-input);border:1.5px solid var(--border);border-radius:10px;text-align:left;cursor:pointer;color:var(--text-placeholder);margin-bottom:0">No images</button>
          <div id="ed-image-fields" style="display:none"></div>
        </div>
        <!-- Privacy box -->
        <div style="display:flex;align-items:center;gap:10px;margin-top:12px">
          <button id="ed-lock-icon" onclick="toggleEdPrivate()" type="button" style="background:none;border:none;cursor:pointer;padding:0;display:flex;flex-shrink:0;color:#9a8a7a"></button>
          <button id="ed-privacy-box" onclick="toggleEdPrivate()" style="flex:1;padding:9px 14px;font-size:16px;font-family:sans-serif;background:var(--bg-input);border:1.5px solid var(--border);border-radius:10px;text-align:left;cursor:pointer;color:var(--text-placeholder);margin-bottom:0">Not private</button>
        </div>
        <div style="height:8px"></div>
      </div>

      <!-- Footer (sticky) -->
      <div style="flex-shrink:0;padding:12px 20px 20px;border-top:1px solid var(--border)">
        <div style="display:flex;gap:8px">
          <button onclick="deleteEditDate()" style="padding:10px 16px;background:none;border:1.5px solid #c07a8a;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#c07a8a;cursor:pointer">Delete</button>
          <div style="flex:1"></div>
          <button onclick="closeEditDate()" style="padding:10px 16px;background:none;border:1.5px solid #ede9e2;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#9a8a7a;cursor:pointer" class="btn-outline">Cancel</button>
          <button onclick="saveEditDate()" style="padding:10px 20px;background:#c07a8a;border:none;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#fff;cursor:pointer">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div id="settings-overlay" class="popup-overlay" onclick="closeSettings()" style="position:fixed;inset:0;background:rgba(30,20,20,0.5);z-index:400;display:none;align-items:center;justify-content:center;padding:20px">
    <div onclick="event.stopPropagation()" style="width:100%;max-width:370px;background:var(--bg);border-radius:20px;padding:24px 20px 28px;box-shadow:0 12px 48px rgba(0,0,0,0.18)">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:22px">
        <div style="font-size:17px;font-weight:700;color:var(--popup-title)">Settings</div>
        <button onclick="closeSettings()" style="background:none;border:none;cursor:pointer;display:flex">
          <svg viewBox="0 0 24 24" width="20" height="20" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-close"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <!-- Home Address -->
      <div class="field-label" style="display:flex;align-items:center;gap:6px">
        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="#9a8a7a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12L12 3l9 9"/><path d="M9 21V12h6v9"/><path d="M3 12v9h18V12"/></svg>
        Home Address
      </div>
      <input class="field-input" id="settings-home-address" type="text" placeholder="e.g. 123 Main St, Brooklyn">
      <!-- Partner's Address -->
      <div class="field-label" style="display:flex;align-items:center;gap:6px;margin-top:16px">
        <svg viewBox="0 0 24 24" width="14" height="14" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
        Partner's Address
      </div>
      <input class="field-input" id="settings-partner-address" type="text" placeholder="e.g. 456 Park Ave, Brooklyn">
      <!-- Partner's Pronouns -->
      <div class="field-label" style="display:flex;align-items:center;gap:6px;margin-top:16px">
        <svg viewBox="0 0 24 24" width="14" height="14" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        Partner's Pronouns
      </div>
      <select class="field-input" id="settings-pronouns" onchange="onPronounsChange()" style="margin-bottom:0">
        <option value="she/her">she / her</option>
        <option value="he/him">he / him</option>
        <option value="they/them">they / them</option>
        <option value="other">other</option>
      </select>
      <div id="settings-pronouns-custom-wrap" style="display:none;margin-top:10px">
        <input class="field-input" id="settings-pronouns-custom" type="text" placeholder="Enter pronouns…" style="margin-bottom:0">
      </div>
      <!-- Appearance -->
      <div class="field-label" style="display:flex;align-items:center;gap:6px;margin-top:32px">
        <svg viewBox="0 0 24 24" width="14" height="14" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        Appearance
      </div>
      <div style="display:flex;align-items:center;gap:16px;margin-top:6px;margin-bottom:46px;justify-content:space-between">
        <div style="display:flex;gap:16px">
          <label onclick="setAppearance('light')" style="display:flex;align-items:center;gap:8px;cursor:pointer;font-family:sans-serif;font-size:14px;color:var(--text-primary)">
            <span id="radio-light" onclick="setAppearance('light')" style="width:18px;height:18px;border-radius:50%;border:2px solid #c07a8a;background:#c07a8a;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer">
              <span style="width:6px;height:6px;border-radius:50%;background:#fff;display:block"></span>
            </span>
            Light
          </label>
          <label onclick="setAppearance('dark')" style="display:flex;align-items:center;gap:8px;cursor:pointer;font-family:sans-serif;font-size:14px;color:var(--text-primary)">
            <span id="radio-dark" onclick="setAppearance('dark')" style="width:18px;height:18px;border-radius:50%;border:2px solid #c8bfb6;background:transparent;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer">
              <span style="width:6px;height:6px;border-radius:50%;background:transparent;display:block"></span>
            </span>
            Dark
          </label>
        </div>
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-right:15px">
          <input type="checkbox" id="settings-hide-private" class="showtype-check">
          <span style="font-size:14px;font-family:sans-serif;color:var(--text-primary)">Hide locked</span>
        </label>
      </div>
      <div style="margin-top:0;display:flex;justify-content:space-between;align-items:center">
        <button onclick="openMoreMenu()" style="padding:10px 16px;background:none;border:1.5px solid #ede9e2;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#9a8a7a;cursor:pointer" class="btn-outline">More…</button>
        <div style="display:flex;gap:8px">
          <button onclick="closeSettings()" style="padding:10px 16px;background:none;border:1.5px solid #ede9e2;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#9a8a7a;cursor:pointer" class="btn-outline">Cancel</button>
          <button onclick="saveSettingsData()" style="padding:10px 24px;background:#c07a8a;border:none;border-radius:10px;font-family:sans-serif;font-size:14px;font-weight:600;color:#fff;cursor:pointer">Save</button>
        </div>
      </div>
    </div>
  </div>


  <!-- MORE MENU POPUP -->
  <div id="more-menu-overlay" class="popup-overlay" onclick="closeMoreMenu()" style="position:fixed;inset:0;background:rgba(30,20,20,0.45);z-index:450;display:none;align-items:center;justify-content:center;padding:20px">
    <div onclick="event.stopPropagation()" style="background:var(--bg);border-radius:18px;padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.18);display:flex;flex-direction:column;gap:8px;min-width:220px">
      <button onclick="importData()" style="display:flex;align-items:center;gap:10px;padding:11px 14px;background:none;border:1.5px solid #ede9e2;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#9a8a7a;cursor:pointer;text-align:left;width:100%" class="btn-outline">
        <svg viewBox="0 0 24 24" width="15" height="15" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 5 17 10"/><line x1="12" y1="5" x2="12" y2="15"/></svg>
        Import Data
      </button>
      <button onclick="exportAllData();closeMoreMenu()" style="display:flex;align-items:center;gap:10px;padding:11px 14px;background:none;border:1.5px solid #ede9e2;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#9a8a7a;cursor:pointer;text-align:left;width:100%" class="btn-outline">
        <svg viewBox="0 0 24 24" width="15" height="15" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Save Data
      </button>
      <button onclick="openEraseConfirm()" style="display:flex;align-items:center;gap:10px;padding:11px 14px;background:none;border:1.5px solid #ede9e2;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#9a8a7a;cursor:pointer;text-align:left;width:100%" class="btn-outline">
        <svg viewBox="0 0 24 24" width="15" height="15" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
        Erase Data
      </button>
      <button onclick="closeMoreMenu();openEditCategories()" style="display:flex;align-items:center;gap:10px;padding:11px 14px;background:none;border:1.5px solid #ede9e2;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#9a8a7a;cursor:pointer;text-align:left;width:100%" class="btn-outline">
        <svg viewBox="0 0 24 24" width="15" height="15" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
        Edit Categories
      </button>
      <div style="margin-top:12px">
        <button onclick="closeMoreMenu()" style="display:flex;align-items:center;justify-content:center;width:100%;padding:11px 14px;background:#c07a8a;border:none;border-radius:10px;font-family:sans-serif;font-size:14px;font-weight:600;color:#fff;cursor:pointer">Done</button>
      </div>
    </div>
  </div>

  <!-- IMAGES POPUP -->
  <div id="images-popup-overlay" onclick="closeImagesPopup()" style="position:fixed;inset:0;background:rgba(30,20,20,0.45);z-index:600;display:none;align-items:center;justify-content:center;padding:20px">
    <div onclick="event.stopPropagation()" style="width:100%;max-width:370px;background:var(--bg);border-radius:20px;padding:20px 20px 16px;box-shadow:0 12px 48px rgba(0,0,0,0.18);display:flex;flex-direction:column;gap:0">

      <div id="images-popup-fields" style="max-height:52vh;overflow-y:auto;padding-bottom:4px"></div>
      <div style="margin-top:16px;display:flex;justify-content:center">
        <button onclick="closeImagesPopup()" style="width:90px;padding:11px 0;background:#c07a8a;border:none;border-radius:10px;font-family:sans-serif;font-size:14px;font-weight:600;color:#fff;cursor:pointer">Done</button>
      </div>
    </div>
  </div>

  <!-- ERASE CONFIRM POPUP -->
  <div id="erase-confirm-overlay" class="popup-overlay" onclick="closeEraseConfirm()" style="position:fixed;inset:0;background:rgba(30,20,20,0.5);z-index:500;display:none;align-items:center;justify-content:center;padding:24px">
    <div onclick="event.stopPropagation()" style="background:var(--bg);border-radius:18px;padding:24px 20px;box-shadow:0 12px 48px rgba(0,0,0,0.18);max-width:300px;width:100%">
      <div style="font-size:16px;font-weight:700;color:var(--popup-title);text-align:center;margin-bottom:10px">Erase all data?</div>
      <div style="font-size:13px;color:#9a8a7a;font-family:sans-serif;text-align:center;margin-bottom:20px;line-height:1.5">This will erase all date ideas, dates, and custom categories.</div>
      <div style="display:flex;gap:10px">
        <button onclick="closeEraseConfirm()" autofocus style="flex:1;padding:11px;background:#c07a8a;border:none;border-radius:10px;font-family:sans-serif;font-size:14px;font-weight:600;color:#fff;cursor:pointer">Cancel</button>
        <button onclick="eraseAllData()" style="flex:1;padding:11px;background:none;border:1.5px solid #e05050;border-radius:10px;font-family:sans-serif;font-size:14px;font-weight:600;color:#e05050;cursor:pointer">Erase</button>
      </div>
    </div>
  </div>

  <!-- Hidden file input for import -->
  <input type="file" id="import-file-input" accept=".json" style="display:none" onchange="handleImportFile(event)">
  <!-- EDIT CATEGORIES POPUP -->
  <div id="editcats-overlay" class="popup-overlay" onclick="closeEditCategories()" style="position:fixed;inset:0;background:rgba(30,20,20,0.5);z-index:500;display:none;align-items:center;justify-content:center;padding:20px">
    <div id="editcats-modal" onclick="event.stopPropagation()" style="width:100%;max-width:390px;background:var(--bg);border-radius:20px;display:flex;flex-direction:column;height:88vh;box-shadow:0 12px 48px rgba(0,0,0,0.18)">
      <!-- Header -->
      <div style="padding:20px 20px 14px;flex-shrink:0;border-bottom:1px solid var(--border)">
        <div style="font-size:17px;font-weight:700;color:var(--popup-title);margin-bottom:14px">Edit Categories</div>
        <!-- Out/In toggle -->
        <div id="editcats-toggle" style="display:flex;background:var(--toggle-bg);border-radius:8px;padding:3px;gap:2px">
          <button onclick="editCatsSetType('out')" id="editcats-btn-out" style="flex:1;padding:6px;border:none;border-radius:6px;font-family:sans-serif;font-size:13px;font-weight:600;cursor:pointer;background:var(--toggle-active-bg);color:var(--toggle-active-color);box-shadow:0 1px 3px rgba(0,0,0,0.1)">Going Out</button>
          <button onclick="editCatsSetType('in')" id="editcats-btn-in" style="flex:1;padding:6px;border:none;border-radius:6px;font-family:sans-serif;font-size:13px;font-weight:600;cursor:pointer;background:transparent;color:var(--text-secondary)">Staying In</button>
        </div>
      </div>
      <!-- List -->
      <div id="editcats-list" style="flex:1;overflow-y:auto;padding:10px 16px"></div>
      <!-- Footer -->
      <div style="padding:14px 20px;flex-shrink:0;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;align-items:center">
        <button onclick="closeEditCategories()" style="padding:10px 16px;background:none;border:1.5px solid #ede9e2;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#9a8a7a;cursor:pointer" class="btn-outline">Cancel</button>
        <button onclick="saveEditCategories()" style="padding:10px 20px;background:#c07a8a;border:none;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#fff;cursor:pointer">Save</button>
      </div>
    </div>
  </div>

  <!-- ICON PICKER POPUP -->
  <div id="iconpicker-overlay" class="popup-overlay" onclick="closeIconPicker(false)" style="position:fixed;inset:0;background:rgba(30,20,20,0.55);z-index:600;display:none;align-items:center;justify-content:center;padding:20px">
    <div id="iconpicker-modal" onclick="event.stopPropagation()" style="width:100%;max-width:340px;background:var(--bg);border-radius:20px;padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.18)">
      <div id="iconpicker-grid" style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button onclick="closeIconPicker(false)" style="padding:10px 16px;background:none;border:1.5px solid #ede9e2;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#9a8a7a;cursor:pointer" class="btn-outline">Cancel</button>
        <button onclick="closeIconPicker(true)" style="padding:10px 20px;background:#8b3a52;border:none;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#fff;cursor:pointer">Save</button>
      </div>
    </div>
  </div>

  <!-- DELETE CATEGORY CONFIRM -->
  <div id="delcat-overlay" class="popup-overlay" onclick="closeDelCat()" style="position:fixed;inset:0;background:rgba(30,20,20,0.55);z-index:700;display:none;align-items:center;justify-content:center;padding:20px">
    <div onclick="event.stopPropagation()" style="width:100%;max-width:320px;background:var(--bg);border-radius:20px;padding:24px;box-shadow:0 12px 48px rgba(0,0,0,0.18);text-align:center">
      <div style="font-size:16px;font-weight:600;color:#2a1f1f;font-family:sans-serif;margin-bottom:18px">Delete category?</div>
      <div style="display:flex;gap:10px">
        <button id="delcat-cancel-btn" onclick="closeDelCat()" style="flex:1;padding:10px;background:#c07a8a;border:none;border-radius:10px;font-family:sans-serif;font-size:14px;font-weight:600;color:#fff;cursor:pointer" autofocus>Cancel</button>
        <button onclick="confirmDelCat()" style="flex:1;padding:10px;background:none;border:1px solid #ede9e2;border-radius:10px;font-family:sans-serif;font-size:14px;color:#9a8a7a;cursor:pointer">Delete</button>
      </div>
    </div>
  </div>

  <!-- FAVORITE PLACES MODAL -->
  <div id="places-overlay" class="popup-overlay" onclick="closePlaces()" style="position:fixed;inset:0;background:rgba(30,20,20,0.5);z-index:400;display:none;align-items:center;justify-content:center;padding:16px">
    <div id="places-modal" onclick="event.stopPropagation()" style="width:100%;max-width:390px;background:var(--bg);border-radius:20px;display:flex;flex-direction:column;height:min(88vh,660px);box-shadow:0 12px 48px rgba(0,0,0,0.18)">
      <!-- Header (sticky) -->
      <div style="padding:20px 20px 14px;flex-shrink:0;border-bottom:1px solid var(--border)">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
          <div style="display:flex;align-items:center;gap:10px">
            <button id="places-prev-btn" onclick="placesNav(-1)" style="background:none;border:none;cursor:pointer;padding:4px;display:flex;opacity:0.4">
              <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
            </button>
            <div id="places-modal-title" style="font-size:17px;font-weight:700;color:var(--popup-title)">Edit Idea</div>
            <button id="places-next-btn" onclick="placesNav(1)" style="background:none;border:none;cursor:pointer;padding:4px;display:flex;opacity:0.4">
              <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
            </button>
          </div>
          <button onclick="closePlaces()" style="background:none;border:none;cursor:pointer;display:flex">
            <svg viewBox="0 0 24 24" width="20" height="20" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-close"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>

        <!-- Place selector -->
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
          <button id="places-heart-btn" onclick="togglePlaceTopChoice()" style="background:none;border:none;cursor:pointer;padding:2px;display:flex;flex-shrink:0"></button>
          <select id="places-select" onchange="handlePlaceSelect(this.value)" class="field-input" style="flex:1;margin-bottom:0"></select>
        </div>
      </div>

      <!-- Scrollable body -->
      <div id="places-form-body" style="flex:1;overflow-y:auto;padding:16px 20px 0;min-height:0">
        <!-- Form fields -->
        <div id="places-form">
          <!-- Name -->
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
            <span id="pf-name-icon" style="width:18px;flex-shrink:0;display:flex;align-items:center;justify-content:center"></span>
            <input class="field-input" id="pf-name" type="text" placeholder="Place / activity" oninput="markPlaceChanged()" style="flex:1;margin-bottom:0">
            <button id="pf-lock-btn" onclick="togglePfPrivate()" type="button" style="background:none;border:none;cursor:pointer;padding:2px;display:flex;flex-shrink:0;color:#9a8a7a" title="Mark as private"></button>
          </div>
          <!-- Type -->
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
            <button id="pf-type-icon" onclick="openIdeaIconPicker()" title="Change icon for this idea" style="width:18px;flex-shrink:0;background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;justify-content:center"></button>
            <select class="field-input" id="pf-type" onchange="onPlaceTypeChange()" style="flex:1;margin-bottom:0">
              <option value="restaurant">Restaurant</option>
              <option value="bar">Bar</option>
              <option value="cafe">Cafe</option>
              <option value="movie">Movie</option>
              <option value="museum">Museum</option>
              <option value="bookstore">Bookstore</option>
              <option value="livemusic">Live Music</option>
              <option value="livejazz">Live Jazz</option>
              <option value="concert">Concert</option>
              <option value="livecomedy">Live Comedy</option>
                                          <option value="theatre">Theatre</option>
              <option value="venue">Venue</option>
              <option value="park">Park</option>
              <option value="other">Other</option>
            </select>
            <label style="flex-shrink:0;display:flex;align-items:center;cursor:pointer;padding:2px" title="Show type in subtitle">
              <input type="checkbox" id="pf-showtype" checked class="showtype-check">
            </label>
          </div>
          <!-- Image URLs -->
          <div id="pf-images-wrap" style="margin-bottom:12px;display:flex;align-items:center;gap:10px">
            <button id="pf-img-icon-btn" title="Search for photos" style="background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;flex-shrink:0;line-height:0">
              <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            </button>
            <button id="pf-img-count-box" onclick="openImagesPopup('pf-image-fields', _getPfImgsearchName)" style="flex:1;padding:9px 14px;font-size:16px;font-family:sans-serif;background:var(--bg-input);border:1.5px solid var(--border);border-radius:10px;text-align:left;cursor:pointer;color:var(--text-placeholder);margin-bottom:0">No images</button>
            <div id="pf-image-fields" style="display:none"></div>
          </div>
          <!-- Cuisine (restaurants/cafes) or short description (other types) -->
          <div id="pf-cuisine-wrap" style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M12 4a8 8 0 0 1 8 8H4a8 8 0 0 1 8-8z"/><path d="M12 4V2"/><circle cx="12" cy="2" r="1" fill="#c07a8a" stroke="none"/><path d="M2 12h20"/><path d="M3 15h18"/></svg>
            <input class="field-input" id="pf-cuisine" type="text" placeholder="Cuisine (e.g. Italian, Japanese)" oninput="markPlaceChanged()" style="flex:1;margin-bottom:0">
          </div>
          <div id="pf-shortdesc-wrap" style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
            <svg viewBox="0 0 24 24" width="18" height="18" style="flex-shrink:0" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="17" x2="12" y2="11"/><circle cx="12" cy="7" r="1.2" fill="#9a8a7a" stroke="none"/></svg>
            <input class="field-input" id="pf-shortdesc" type="text" placeholder="Short description…" oninput="markPlaceChanged()" style="flex:1;margin-bottom:0">
          </div>

          <!-- About (long description) — no icon, indented to align with shortdesc input -->
          <div id="pf-about-wrap" style="display:flex;align-items:flex-start;gap:10px;margin-bottom:12px">
            <div style="width:18px;flex-shrink:0"></div>
            <textarea class="field-input" id="pf-about" rows="2" placeholder="Long description (ambience, etc)…" oninput="markPlaceChanged()" style="flex:1;resize:none;font-family:sans-serif;margin-bottom:0"></textarea>
          </div>
          <!-- Address -->
          <div id="pf-address-row" style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
            <button onclick="openPlaceMapsAddress()" title="Open in Google Maps" style="background:none;border:none;cursor:pointer;padding:0;display:flex;flex-shrink:0">
              <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
            </button>
            <input class="field-input" id="pf-address" type="text" placeholder="Address" oninput="markPlaceChanged()" style="flex:1;margin-bottom:0">
          </div>
          <!-- Neighborhood -->
          <div id="pf-neighborhood-row" style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>
            <input class="field-input" id="pf-neighborhood" type="text" placeholder="Neighborhood (e.g. Williamsburg)" oninput="markPlaceChanged()" style="flex:1;margin-bottom:0">
          </div>

          <!-- Commute: Subway -->
          <div id="pf-subway-row" style="margin-bottom:12px">
            <div style="display:flex;align-items:center;gap:10px">
              <button onclick="openTransitDirections()" title="Get transit directions" style="background:none;border:none;cursor:pointer;padding:0;display:flex;flex-shrink:0">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#9a8a7a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><text x="12" y="16.5" text-anchor="middle" font-family="'Helvetica Neue','Arial Black',Arial,sans-serif" font-weight="900" font-size="13" fill="#9a8a7a" stroke="none">A</text></svg>
              </button>
              <input class="field-input" id="pf-subway" type="text" placeholder="Transit (e.g. A C to 14th St 25min)" oninput="markPlaceChanged();renderSubwayBadges()" style="flex:1;margin-bottom:0">
            </div>
            <div id="pf-subway-badges" style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-top:0;margin-left:28px;min-height:0"></div>
          </div>

          <!-- Commute: Walk/Drive -->
          <div id="pf-walkdrive-row" style="margin-bottom:12px">
            <div style="display:flex;align-items:center;gap:10px">
              <button onclick="openWalkingDirections()" title="Get walking directions" style="background:none;border:none;cursor:pointer;padding:0;display:flex;flex-shrink:0">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="#9a8a7a"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/></svg>
              </button>
              <input class="field-input" id="pf-walkdrive" type="text" placeholder="Walk / Drive (e.g. 20min walk / 8min drive)" oninput="markPlaceChanged();renderWalkDriveBadges()" style="flex:1;margin-bottom:0">
            </div>
            <div id="pf-walkdrive-badges" style="display:flex;align-items:center;gap:8px;margin-top:0;margin-left:28px;min-height:0"></div>
          </div>

          <!-- Reservation (restaurant/bar/livemusic/show) -->
          <div id="pf-reservation-wrap" style="margin-bottom:4px">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
              <button onclick="openReservationLink()" title="Open reservation" style="background:none;border:none;cursor:pointer;padding:0;display:flex;flex-shrink:0">
                <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><line x1="9" y1="9" x2="9" y2="15"/><line x1="12" y1="9" x2="12" y2="15"/><line x1="15" y1="9" x2="15" y2="15"/></svg>
              </button>
              <select class="field-input" id="pf-reservation" onchange="markPlaceChanged();onReservationChange()" style="flex:1;margin-bottom:0">
                <option value="website">Website</option>
                <option value="resy">Resy</option>
                <option value="opentable">OpenTable</option>
                <option value="eventbrite">Eventbrite</option>
                <option value="none">No reservation needed</option>
              </select>
            </div>
            <div id="pf-website-wrap" style="display:none;margin-left:28px;margin-bottom:12px">
              <input class="field-input" id="pf-website-url" type="text" placeholder="Website URL" oninput="markPlaceChanged()" style="margin-bottom:0">
            </div>
            <div id="pf-eventbrite-wrap" style="display:none;margin-left:28px;margin-bottom:12px">
              <input class="field-input" id="pf-eventbrite-url" type="text" placeholder="Eventbrite URL" oninput="markPlaceChanged()">
            </div>
          </div>

        </div>
        <div style="height:8px"></div>
      </div>

      <!-- Footer (sticky) -->
      <div style="flex-shrink:0;padding:12px 20px 20px;border-top:1px solid var(--border)">

        <div style="display:flex;gap:8px">
          <button id="places-delete-btn" onclick="promptRemoveIdea()" style="padding:10px 16px;background:none;border:1.5px solid #c07a8a;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#c07a8a;cursor:pointer;opacity:0.4" disabled>Remove</button>
          <div style="flex:1"></div>
          <button onclick="closePlaces()" style="padding:10px 16px;background:none;border:1.5px solid #ede9e2;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#9a8a7a;cursor:pointer" class="btn-outline">Cancel</button>
          <button id="places-save-btn" onclick="savePlace()" style="padding:10px 20px;background:#c07a8a;border:none;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#fff;cursor:pointer">Save</button>
        </div>
      </div>
    </div><!-- /places-modal -->
  </div><!-- /places-overlay -->

<!-- ARCHIVE / DELETE CONFIRMATION POPUP — z-index 450, above Edit Idea (400) -->
<div id="remove-confirm-overlay" class="popup-overlay" onclick="closeRemoveConfirm()" style="position:fixed;inset:0;background:rgba(30,20,20,0.45);z-index:450;display:none;align-items:center;justify-content:center;padding:24px">
  <div onclick="event.stopPropagation()" style="width:100%;max-width:340px;background:var(--bg);border-radius:20px;padding:24px 24px 20px;box-shadow:0 16px 48px rgba(0,0,0,0.22)">
    <div style="font-size:16px;font-weight:700;color:var(--popup-title);margin-bottom:6px">Archive or delete the idea?</div>
    <div style="font-size:13px;color:#9a8a7a;font-family:sans-serif;margin-bottom:24px;line-height:1.5">Archiving hides it from your Date Ideas list but keeps it accessible from past memories.</div>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button onclick="confirmDeleteIdea()" style="padding:10px 16px;background:none;border:1.5px solid #c07a8a;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#c07a8a;cursor:pointer">Delete</button>
      <button onclick="confirmArchiveIdea()" style="padding:10px 20px;background:#c07a8a;border:none;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#fff;cursor:pointer">Archive</button>
    </div>
  </div>
</div>

<!-- NEW TO DO SHEET — bottom sheet, same as idea-sheet -->
<div id="todo-sheet">
  <!-- Header: title left, X right -->
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
    <div style="font-size:18px;font-weight:700;color:var(--popup-title);flex:1">New To Do</div>
    <div style="flex:1;display:flex;justify-content:flex-end">
      <button onclick="closeTodoSheet()" style="background:none;border:none;display:flex;cursor:pointer">
        <svg viewBox="0 0 24 24" width="20" height="20" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-close"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
  </div>

  <!-- To Do type (checkbox icon — static) + dropdown -->
  <div class="idea-row">
    <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><rect x="3" y="3" width="18" height="18" rx="3"/><polyline points="9 12 11 14 15 10"/></svg>
    <select id="ts-task" onchange="onTodoTaskChange()" class="field-input" style="flex:1;margin-bottom:0">
      <option value="" disabled selected>Select…</option>
      <option>Make a reservation</option>
      <option>Buy tickets</option>
      <option>Buy something</option>
      <option>Plan a date</option>
      <option>Message</option>
      <option>Other</option>
    </select>
  </div>

  <!-- Date picker (calendar icon — shown for Make a reservation / Buy tickets) -->
  <div id="ts-activity-wrap" style="display:none">
    <div class="idea-row">
      <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      <button id="ts-date-btn" onclick="openUpcomingDatesPicker('ts')"
        style="flex:1;padding:9px 14px;background:var(--bg-input);border:1.5px solid var(--border);border-radius:10px;font-family:sans-serif;color:var(--text-primary);text-align:left;cursor:pointer;display:flex;align-items:center;gap:10px;margin-bottom:0">
        <span id="ts-date-icon" style="display:none;flex-shrink:0"></span>
        <span id="ts-date-label" style="flex:1;font-size:16px;color:var(--text-placeholder)">Select date…</span>
      </button>
    </div>
  </div>

  <!-- Note field (context-sensitive label, shown for most tasks) -->
  <div id="ts-note-wrap" style="display:none">
    <div class="idea-row">
      <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></svg>
      <input id="ts-note" type="text" class="field-input" placeholder="" style="flex:1;margin-bottom:0;padding:9px 14px;font-size:16px;height:auto">
    </div>
  </div>

  <!-- Priority (clock icon) -->
  <div class="idea-row">
    <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    <select id="ts-priority" class="field-input" style="flex:1;margin-bottom:0">
      <option value="high">Next</option>
      <option value="normal" selected>Soon</option>
      <option value="low">Eventually</option>
    </select>
  </div>
  <!-- Privacy box -->
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px">
    <button id="ts-lock-icon" onclick="toggleTsPrivate()" type="button" style="background:none;border:none;cursor:pointer;padding:0;display:flex;flex-shrink:0;color:#9a8a7a"></button>
    <button id="ts-privacy-box" onclick="toggleTsPrivate()" style="flex:1;padding:9px 14px;font-size:16px;font-family:sans-serif;background:var(--bg-input);border:1.5px solid var(--border);border-radius:10px;text-align:left;cursor:pointer;color:var(--text-placeholder);margin-bottom:0">Not private</button>
  </div>
</div>

<!-- UPCOMING DATES PICKER POPUP -->
<div id="upcoming-dates-picker-overlay" onclick="closeUpcomingDatesPicker()" style="position:fixed;inset:0;background:rgba(30,20,20,0.5);z-index:500;display:none;align-items:center;justify-content:center;padding:20px">
  <div onclick="event.stopPropagation()" style="width:100%;max-width:370px;background:var(--bg);border-radius:20px;padding:20px 20px 24px;max-height:76vh;display:flex;flex-direction:column;box-shadow:0 12px 48px rgba(0,0,0,0.18)">
    <!-- Header: title + X -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-shrink:0">
      <div style="font-size:17px;font-weight:700;color:var(--popup-title)">Upcoming Dates</div>
      <button onclick="closeUpcomingDatesPicker()" style="background:none;border:none;display:flex;cursor:pointer">
        <svg viewBox="0 0 24 24" width="20" height="20" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-close"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <!-- List -->
    <div id="upcoming-dates-picker-list" style="flex:1;overflow-y:auto"></div>
  </div>
</div>

<!-- EDIT TO DO OVERLAY — traditional popup, same as Edit Date -->
<div id="edit-todo-overlay" class="popup-overlay" onclick="closeEditTodo()" style="position:fixed;inset:0;background:rgba(30,20,20,0.5);z-index:400;display:none;align-items:center;justify-content:center;padding:16px">
  <div id="edit-todo-modal" onclick="event.stopPropagation()" style="width:100%;max-width:390px;background:var(--bg);border-radius:20px;padding:20px 20px 24px;max-height:88vh;overflow-y:auto;box-shadow:0 12px 48px rgba(0,0,0,0.18)">
    <!-- Header: prev arrow | Edit To Do | next arrow | X -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:10px">
        <button id="et-prev-btn" onclick="editTodoNav(-1)" style="background:none;border:none;cursor:pointer;padding:4px;display:flex;opacity:0.3">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <div style="font-size:18px;font-weight:700;color:var(--popup-title)">Edit To Do</div>
        <button id="et-next-btn" onclick="editTodoNav(1)" style="background:none;border:none;cursor:pointer;padding:4px;display:flex;opacity:0.3">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </button>
      </div>
      <button onclick="closeEditTodo()" style="background:none;border:none;cursor:pointer;display:flex;padding:4px">
        <svg viewBox="0 0 24 24" width="20" height="20" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-close"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>

    <!-- To Do type -->
    <div class="idea-row" style="margin-bottom:14px">
      <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><rect x="3" y="3" width="18" height="18" rx="3"/><polyline points="9 12 11 14 15 10"/></svg>
      <select id="et-task" onchange="onEditTodoTaskChange()" class="field-input" style="flex:1;margin-bottom:0">
      <option value="" disabled>Select…</option>
      <option>Make a reservation</option>
      <option>Buy tickets</option>
      <option>Buy something</option>
      <option>Plan a date</option>
      <option>Message</option>
      <option>Other</option>
      </select>
    </div>

    <!-- Date picker -->
    <div id="et-activity-wrap" style="display:none">
      <div class="idea-row" style="margin-bottom:14px">
        <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        <button id="et-date-btn" onclick="openUpcomingDatesPicker('et')"
          style="flex:1;padding:9px 14px;background:var(--bg-input);border:1.5px solid var(--border);border-radius:10px;font-family:sans-serif;color:var(--text-primary);text-align:left;cursor:pointer;display:flex;align-items:center;gap:10px;margin-bottom:0">
          <span id="et-date-icon" style="display:none"></span>
          <span id="et-date-label" style="flex:1;font-size:16px;color:var(--text-placeholder)">Select date…</span>
        </button>
      </div>
    </div>

    <!-- Note -->
    <div id="et-note-wrap" style="display:none">
      <div class="idea-row" style="margin-bottom:14px;align-items:flex-start">
        <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0;margin-top:9px"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></svg>
        <input type="text" class="field-input" id="et-note" placeholder="" style="flex:1;margin-bottom:0;padding:9px 14px;font-size:16px;height:auto">
      </div>
    </div>

    <!-- Priority -->
    <div class="idea-row" style="margin-bottom:14px">
      <svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <select id="et-priority" class="field-input" style="flex:1;margin-bottom:0">
      <option value="high">Next</option>
      <option value="normal">Soon</option>
      <option value="low">Eventually</option>
      </select>
    </div>

    <!-- Privacy box -->
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
      <button id="et-lock-icon" onclick="toggleEtPrivate()" type="button" style="background:none;border:none;cursor:pointer;padding:0;display:flex;flex-shrink:0;color:#9a8a7a"></button>
      <button id="et-privacy-box" onclick="toggleEtPrivate()" style="flex:1;padding:9px 14px;font-size:16px;font-family:sans-serif;background:var(--bg-input);border:1.5px solid var(--border);border-radius:10px;text-align:left;cursor:pointer;color:var(--text-placeholder);margin-bottom:0">Not private</button>
    </div>
    <!-- Buttons: Delete / Cancel / Save -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:24px;gap:8px">
      <button onclick="deleteTodoFromEdit()" style="padding:10px 16px;background:none;border:1.5px solid #c07a8a;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#c07a8a;cursor:pointer">Delete</button>
      <div style="display:flex;gap:8px">
        <button onclick="closeEditTodo()" style="padding:10px 16px;background:none;border:1.5px solid #ede9e2;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#9a8a7a;cursor:pointer" class="btn-outline">Cancel</button>
        <button onclick="saveEditTodo()" style="padding:10px 20px;background:#c07a8a;border:none;border-radius:10px;font-family:sans-serif;font-size:13px;font-weight:600;color:#fff;cursor:pointer">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════
const ROSE = '#c07a8a', BURGUNDY = '#8b3a52';
function accentColor(type) {
  if (document.body.classList.contains('dark-mode')) return ROSE;
  return BURGUNDY;
}
function subColor(type) {
  return '#9a8a7a';
}
const ROSE_BG = 'rgba(192,122,138,0.1)', BURGUNDY_BG = 'rgba(139,58,82,0.1)';
const ROSE_MUTED = '#c9a0aa', BURGUNDY_MUTED = '#a0b8d0';
const MTA_COLORS = {
  '1':'#EE352E','2':'#EE352E','3':'#EE352E',
  '4':'#00933C','5':'#00933C','6':'#00933C',
  '7':'#B933AD',
  'A':'#2850AD','C':'#2850AD','E':'#2850AD',
  'B':'#FF6319','D':'#FF6319','F':'#FF6319','M':'#FF6319',
  'G':'#6CBE45',
  'J':'#996633','Z':'#996633',
  'L':'#A7A9AC',
  'N':'#FCCC0A','Q':'#FCCC0A','R':'#FCCC0A','W':'#FCCC0A',
  'S':'#808183',
};

let currentView = 'home';
let sheetOpen = false;
let ideaType = 'out';
let ideasFilter = 'all';
let ideasSearch = '';
let _favScrollIdx = 0;
let selectedCategory = 'restaurant';
let selectedCalDay = null;
let currentCalMonth = new Date().getMonth();
let currentCalYear = new Date().getFullYear();
let dateIdx = 0;

// ── Category definitions (id, label, iconKey) ────────
// iconKey maps to ICONS object keys
const DEFAULT_OUT_CATS = [
  {id:'restaurant', label:'Restaurant',         iconKey:'dinner'},
  {id:'bar',        label:'Bar',                iconKey:'wine'},
  {id:'cafe',       label:'Cafe',               iconKey:'coffee'},
  {id:'movie',      label:'Movie',               iconKey:'movie'},
  {id:'museum',     label:'Museum',             iconKey:'frame'},
  {id:'bookstore',  label:'Bookstore',           iconKey:'book'},
  {id:'livemusic',  label:'Live Music',          iconKey:'music'},
  {id:'livejazz',   label:'Live Jazz',           iconKey:'music'},
  {id:'concert',    label:'Concert',             iconKey:'music'},
  {id:'livecomedy', label:'Live Comedy',         iconKey:'mic'},
  {id:'theatre',    label:'Theatre',             iconKey:'mask'},
  {id:'venue',      label:'Venue',               iconKey:'mic'},
  {id:'park',       label:'Park',                iconKey:'evergreen'},
  {id:'other',      label:'Other',               iconKey:'park'},
];
const DEFAULT_IN_CATS = [
  {id:'orderin',    label:'Delivery',  iconKey:'dinner'},
  {id:'cook',       label:'Cook',      iconKey:'chefhat'},
  {id:'moviein',    label:'Movie',     iconKey:'movie'},
  {id:'game',       label:'Game',      iconKey:'game'},
  {id:'otherin',    label:'Other',     iconKey:'sofa'},
];

function loadCats() {
  try {
    const s = localStorage.getItem('ll_cats');
    if (s) { const p = JSON.parse(s); return {out: p.out||DEFAULT_OUT_CATS, in: p.in||DEFAULT_IN_CATS}; }
  } catch(e) {}
  return {out: DEFAULT_OUT_CATS.map(c=>({...c})), in: DEFAULT_IN_CATS.map(c=>({...c}))};
}
function saveCats() {
  try { localStorage.setItem('ll_cats', JSON.stringify({out: OUT_CATS, in: IN_CATS})); } catch(e) {}
}
const _loadedCats = loadCats();
let OUT_CATS = _loadedCats.out;
let IN_CATS  = _loadedCats.in;

// Lookup by id or label (for backward compat with old string-based data)
function findCat(val, type) {
  const arr = type === 'in' ? IN_CATS : OUT_CATS;
  if (!val) return null;
  const vl = val.toLowerCase();
  return arr.find(c => c.id === val || c.id === vl || c.label === val || c.label.toLowerCase() === vl) || null;
}
// Get display label for a category value
function catLabelForId(val, type) {
  const c = findCat(val, type);
  if (c) return c.label;
  // Legacy CAT_LABELS fallback
  return CAT_LABELS[val] || toTitleCase(val||'');
}
// All available icon keys
const ALL_ICON_KEYS = ['dinner','wine','coffee','movie','music','ticket','mic','frame','painting','camera','walker','park','evergreen','palmtree','building','sofa','sofa2','bed','lingerie','mask','game','puzzle','eightball','bowling','videogame','book','gift','chefhat','clock','smile','sun','moon','star','heart','spade'];

const DEFAULT_UPCOMING_DATES = [
  { day:28, month:'Feb', year:2026, activity:'Dinner',  venue:'Lilia',           neighborhood:'Williamsburg', time:'7:30 PM',  isFeb:true  },
  { day:7,  month:'Mar', year:2026, activity:'Concert', venue:'National Sawdust', neighborhood:'Williamsburg', time:'8:00 PM',  isFeb:false },
  { day:15, month:'Mar', year:2026, activity:'Brunch',  venue:'Maison Premiere',  neighborhood:'Williamsburg', time:'11:00 AM', isFeb:false },
  { day:20, month:'Mar', year:2026, activity:'Movie',   venue:'Nitehawk Cinema',  neighborhood:'Williamsburg', time:'7:00 PM',  isFeb:false },
];

function loadDates() {
  try {
    const s = localStorage.getItem('ll_dates');
    return s ? JSON.parse(s) : DEFAULT_UPCOMING_DATES.map(d => ({...d}));
  } catch(e) { return DEFAULT_UPCOMING_DATES.map(d => ({...d})); }
}
function saveDates(arr) {
  try { localStorage.setItem('ll_dates', JSON.stringify(arr)); } catch(e) {}
}

let UPCOMING_DATES = loadDates();

// Derive FUTURE_DATES from UPCOMING_DATES (for home screen bubble)
const MONTH_NUMS = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
const DAY_NAMES = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
function buildFutureDates() {
  const today = new Date(); today.setHours(0,0,0,0);
  return UPCOMING_DATES
    .filter(u => {
      const mNum = MONTH_NUMS[u.month];
      if (mNum === undefined) return false;
      const dt = new Date(u.year || new Date().getFullYear(), mNum, u.day);
      dt.setHours(0,0,0,0);
      return dt >= today;
    })
    .sort((a,b) => {
      const da = new Date(a.year||2026, MONTH_NUMS[a.month]||0, a.day);
      const db = new Date(b.year||2026, MONTH_NUMS[b.month]||0, b.day);
      return da - db;
    })
    .map(u => {
      const mNum = MONTH_NUMS[u.month] ?? 0;
      const dt = new Date(u.year || 2026, mNum, u.day);
      return {
        dayFull: DAY_NAMES[dt.getDay()],
        dayShort: `${u.month} ${u.day}`,
        activity: u.activity,
        venue: u.venue,
        neighborhood: u.neighborhood,
        time: u.time,
        inLocation: u.inLocation,
        inLocationOther: u.inLocationOther,
        _ref: u
      };
    });
}
let FUTURE_DATES = [];

// ── Neighborhood helpers ──────────────────────────────
// Parse approximate neighborhood from an address string
function _neighborhoodFromAddress(addr) {
  if (!addr) return '';
  // Split by comma, strip empties
  const parts = addr.split(',').map(s => s.trim()).filter(Boolean);
  // Work backwards, skipping state abbreviations, zip codes, country
  for (let i = parts.length - 1; i >= 0; i--) {
    const p = parts[i];
    // Skip zip codes (standalone or combined "NY 11201")
    if (/^\d{5}(-\d{4})?$/.test(p)) continue;
    // Skip "State ZIP" combos like "NY 11201"
    if (/^[A-Z]{2}\s+\d{4,5}$/.test(p)) continue;
    // Skip standalone state abbreviation
    if (/^[A-Z]{2}$/.test(p)) continue;
    // Skip country
    if (/^(USA|US|United States)$/i.test(p)) continue;
    // Manhattan normalisations
    const lower = p.toLowerCase().replace(/\s+/g,' ');
    if (['new york', 'new york city', 'nyc', 'manhattan'].includes(lower)) return 'Manhattan';
    return p;
  }
  return '';
}

// Get display neighborhood for an idea: explicit field wins, else parse address
function _ideaNeighborhood(idea) {
  if (!idea) return '';
  if (idea.neighborhood && idea.neighborhood.trim()) return idea.neighborhood.trim();
  return _neighborhoodFromAddress(idea.address || '');
}

const DEFAULT_IDEAS = [
  { id:1, type:'out', category:'restaurant', name:'Lilia',                address:'567 Union Ave, Williamsburg', note:'Best pasta in Brooklyn', saved:true  },
  { id:2, type:'out', category:'bar',        name:'Maison Premiere',      address:'298 Bedford Ave, Williamsburg', note:'Absinthe, oysters, dreamy', saved:false },
  { id:3, type:'out', category:'livemusic',  name:'National Sawdust',     address:'80 N 6th St, Williamsburg', note:'Small intimate venue', saved:true  },
  { id:4, type:'out', category:'movie',      name:'Nitehawk Cinema',      address:'136 Metropolitan Ave, Williamsburg', note:'Dinner + film in one', saved:false },
  { id:5, type:'out', category:'park',       name:'Prospect Park',        address:'Prospect Park, Brooklyn', note:'Golden hour walk', saved:true  },
  { id:6, type:'out', category:'venue',      name:"St. Ann's Warehouse",  address:'45 Water St, DUMBO', note:'Experimental / incredible', saved:false },
  { id:7, type:'in',  category:'Cook',       name:'Cook pasta together',  address:'', note:'She loves to cook', saved:true  },
  { id:8, type:'in',  category:'Movie',      name:'Film night at home',   address:'', note:'Criterion picks', saved:true  },
  { id:9, type:'in',  category:'Game',       name:'Board game night',     address:'', note:'', saved:false },
];

const STATIC_PAST_DATES = [
  { id:'p1', day:14, month:'Feb', year:2026, label:'Sat Feb 14', activity:'Dinner',  venue:'Aska',            time:'8:00 PM', neighborhood:'Williamsburg', note:"First Valentine's. Perfect." },
  { id:'p2', day:7,  month:'Feb', year:2026, label:'Sat Feb 7',  activity:'Concert', venue:'National Sawdust', time:'8:00 PM', neighborhood:'Williamsburg', note:'Ambrose Akinmusire. She cried (good).' },
];
const PAST_DATES = STATIC_PAST_DATES; // legacy alias

function _computeMemories() {
  const today = new Date(); today.setHours(0,0,0,0);
  const M = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
  let saved = {};
  try { saved = JSON.parse(localStorage.getItem('ll_memories') || '{}'); } catch(e) {}
  // Start with static past dates merged with any saved edits
  const all = STATIC_PAST_DATES.map(d => ({ ...d, ...(saved[d.id] || {}) }));
  // Add any UPCOMING_DATES that are before today
  UPCOMING_DATES.forEach(u => {
    const mNum = M[u.month]; if (mNum === undefined) return;
    const yr = u.year || new Date().getFullYear();
    const dt = new Date(yr, mNum, u.day); dt.setHours(0,0,0,0);
    if (dt < today) {
      const id = 'u_' + u.day + '_' + u.month;
      if (!all.find(x => x.day === u.day && x.month === u.month))
        all.push({ ...u, id, year: yr, ...(saved[id] || {}) });
    }
  });
  // Sort reverse chronological (newest first)
  all.sort((a,b) => {
    const da = new Date(a.year||2026, M[a.month]||0, a.day||1);
    const db = new Date(b.year||2026, M[b.month]||0, b.day||1);
    return db - da;
  });
  return all;
}

// ── localStorage helpers ──────────────────────────────
function loadIdeas() {
  try {
    const s = localStorage.getItem('ll_ideas');
    return s ? JSON.parse(s) : DEFAULT_IDEAS.map(i => ({...i}));
  } catch(e) { return DEFAULT_IDEAS.map(i => ({...i})); }
}
function saveIdeas(arr) {
  try { localStorage.setItem('ll_ideas', JSON.stringify(arr)); } catch(e) {}
}
let ideas = loadIdeas();

function loadSettings() {
  try { return JSON.parse(localStorage.getItem('ll_settings') || '{}'); } catch(e) { return {}; }
}
function saveSettings(obj) {
  try { localStorage.setItem('ll_settings', JSON.stringify(obj)); } catch(e) {}
}
let appSettings = loadSettings();
let homeAddress = appSettings.homeAddress || '';
let partnerAddress = appSettings.partnerAddress || '';
let partnerPronouns = appSettings.partnerPronouns || 'she/her';
let partnerPronounsCustom = appSettings.partnerPronounsCustom || '';
let hidePrivate = appSettings.hidePrivate || false;
FUTURE_DATES = buildFutureDates();

// Returns the object pronoun: "her", "him", "them", or custom
function partnerObj() {
  if (partnerPronouns === 'she/her') return 'her';
  if (partnerPronouns === 'he/him') return 'him';
  if (partnerPronouns === 'they/them') return 'them';
  return partnerPronounsCustom.split('/')[1]?.trim() || partnerPronounsCustom || 'them';
}
// Returns the possessive: "her", "his", "their", or custom
function partnerPoss() {
  if (partnerPronouns === 'she/her') return 'her';
  if (partnerPronouns === 'he/him') return 'his';
  if (partnerPronouns === 'they/them') return 'their';
  return partnerPronounsCustom.split('/')[1]?.trim() || partnerPronounsCustom || 'their';
}
// Returns "Her place" / "His place" / "Their place" etc.
function partnerPlaceLabel() {
  const p = partnerPoss();
  return p.charAt(0).toUpperCase() + p.slice(1) + ' place';
}

// Returns the location string to show on date cards for In activities
function _dateLocationLabel(d) {
  if (!d.inLocation) return null;
  if (d.inLocation === 'my_place') return 'My place';
  if (d.inLocation === 'partner_place') return partnerPlaceLabel();
  if (d.inLocation === 'other') return d.inLocationOther || 'Other';
  return null;
}

// ═══════════════════════════════════════════════════════
// SVG HELPERS
// ═══════════════════════════════════════════════════════
function svgIcon(paths, size, color, sw=2, extra='') {
  return `<svg viewBox="0 0 24 24" width="${size}" height="${size}" stroke="${color}" stroke-width="${sw}" fill="none" stroke-linecap="round" stroke-linejoin="round" ${extra}>${paths}</svg>`;
}
const ICONS = {
  heart: (s,c,filled) => `<svg viewBox="0 0 24 24" width="${s}" height="${s}" stroke="${c}" stroke-width="2" fill="${filled?c:'none'}" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>`,
  building: (s,c) => `<svg viewBox="0 0 24 24" width="${s}" height="${s}" stroke="${c}" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>`,
  puzzle: (s,c) => `<svg viewBox="0 0 24 24" width="${s}" height="${s}" stroke="${c}" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M19.439 7.85c-.049.322.059.648.289.878l1.568 1.568c.47.47.706 1.087.706 1.704s-.235 1.233-.706 1.704l-1.611 1.611a.98.98 0 0 1-.837.276c-.47-.07-.802-.48-.968-.925a2.501 2.501 0 1 0-3.214 3.214c.446.166.855.497.925.968a.979.979 0 0 1-.276.837l-1.61 1.61a2.404 2.404 0 0 1-3.408 0l-1.569-1.568a.998.998 0 0 0-.877-.29c-.493.074-.84.504-1.02.968a2.5 2.5 0 1 1-3.237-3.237c.464-.18.894-.527.967-1.02a.997.997 0 0 0-.289-.877l-1.568-1.568a2.402 2.402 0 0 1 0-3.408l1.61-1.61a.979.979 0 0 1 .837-.276c.47.07.802.48.968.925a2.501 2.501 0 1 0 3.214-3.214c-.446-.166-.855-.497-.925-.968a.979.979 0 0 1 .276-.837l1.61-1.61a2.402 2.402 0 0 1 3.408 0l1.568 1.569c.23.23.556.338.878.28.493-.074.84-.504 1.02-.968a2.5 2.5 0 1 1 3.237 3.237c-.464.18-.894.527-.967 1.02z"/></svg>`,
  mapPin: (s,c) => svgIcon('<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>',s,c),
  chevRight: (s,c) => svgIcon('<polyline points="9 18 15 12 9 6"/>',s,c),
  edit: (s,c) => svgIcon('<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>',s,c),
  plus: (s,c,sw=2) => svgIcon('<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>',s,c,sw),
  wine: (s,c) => svgIcon('<path d="M8 22h8"/><path d="M12 15.8v6.2"/><path d="M5 3h14l-1.5 9a5 5 0 0 1-5 4h-1a5 5 0 0 1-5-4L5 3z"/>',s,c),
  sofa: (s,c) => svgIcon('<path d="M20 9V6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v3"/><path d="M2 11v5a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-5a2 2 0 0 0-4 0v1H6v-1a2 2 0 0 0-4 0Z"/><path d="M4 18v2"/><path d="M20 18v2"/>',s,c),
  dinner: (s,c) => svgIcon('<path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/>',s,c),
  movie: (s,c) => svgIcon('<rect x="2" y="2" width="20" height="20" rx="2"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/>',s,c),
  music: (s,c) => svgIcon('<path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>',s,c),
  smile: (s,c) => svgIcon('<circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><circle cx="9" cy="9.5" r="1.2" fill="'+c+'" stroke="none"/><circle cx="15" cy="9.5" r="1.2" fill="'+c+'" stroke="none"/>',s,c),
  park: (s,c) => svgIcon('<circle cx="12" cy="12" r="2" fill="'+c+'"/><ellipse cx="12" cy="5" rx="3" ry="4.5"/><ellipse cx="18.5" cy="9.5" rx="3" ry="4.5" transform="rotate(72 18.5 9.5)"/><ellipse cx="16" cy="17.5" rx="3" ry="4.5" transform="rotate(144 16 17.5)"/><ellipse cx="8" cy="17.5" rx="3" ry="4.5" transform="rotate(-144 8 17.5)"/><ellipse cx="5.5" cy="9.5" rx="3" ry="4.5" transform="rotate(-72 5.5 9.5)"/>',s,c),
  book: (s,c) => svgIcon('<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>',s,c),
  coffee: (s,c) => svgIcon('<path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V8z"/><line x1="6" y1="2" x2="6" y2="4"/><line x1="10" y1="2" x2="10" y2="4"/><line x1="14" y1="2" x2="14" y2="4"/>',s,c),
  clock: (s,c) => svgIcon('<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',s,c),
  mic: (s,c) => svgIcon('<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>',s,c),
  walker: (s,c) => `<svg viewBox="0 0 24 24" width="${s}" height="${s}" fill="${c}"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/></svg>`,
  game: (s,c) => svgIcon(`<rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.8" fill="${c}" stroke="none"/><circle cx="15.5" cy="8.5" r="1.8" fill="${c}" stroke="none"/><circle cx="8.5" cy="15.5" r="1.8" fill="${c}" stroke="none"/><circle cx="15.5" cy="15.5" r="1.8" fill="${c}" stroke="none"/>`,s,c),
  painting: (s,c) => svgIcon('<rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>',s,c),
  chefhat: (s,c) => svgIcon('<path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/><line x1="6" y1="17" x2="18" y2="17"/>',s,c),
  spade: (s,c) => `<svg viewBox="0 0 24 24" width="${s}" height="${s}" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2 C12 2 3 8 3 13 C3 16.5 5.5 18.5 8.5 18 C7.5 19.5 7 21 7 21 L17 21 C17 21 16.5 19.5 15.5 18 C18.5 18.5 21 16.5 21 13 C21 8 12 2 12 2Z"/></svg>`,
  hike: (s,c) => svgIcon('<circle cx="12" cy="5" r="2"/><path d="M10 22V18L7 14l3-4 4 3 3-2"/><path d="M11 10l2 2v5l3 3"/>',s,c),
  evergreen: (s,c) => svgIcon('<path d="M12 2 L5 10 L8 10 L4 16 L8 16 L10 16 L10 22 L14 22 L14 16 L16 16 L20 16 L16 10 L19 10 Z"/>',s,c),
  palmtree: (s,c) => svgIcon('<path d="M13 8c0-2.76-2.46-5-5.5-5S2 5.24 2 8h2l1-1 1 1h4"/><path d="M13 7.14A5.82 5.82 0 0 1 16.5 6c3.04 0 5.5 2.24 5.5 5h-3l-1-1-1 1h-4"/><path d="M5.89 9.71c-2.15 2.15-2.3 5.47-.35 7.43l4.24-4.25.7-.7.71-.71 2.12-2.12c-1.95-1.96-5.27-1.8-7.42.35Z"/><path d="M11 15.5c.5 2.5-.17 4.5-1 6.5h4c2-5.5-.5-12-1-14"/>',s,c),
  bed: (s,c) => svgIcon('<path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/>',s,c),
  eightball: (s,c) => `<svg viewBox="0 0 24 24" width="${s}" height="${s}"><path fill-rule="evenodd" fill="${c}" d="M12 2a10 10 0 1 1 0 20A10 10 0 0 1 12 2zM12 5.5a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11z"/><text x="12" y="14" text-anchor="middle" font-size="8" font-family="sans-serif" font-weight="900" fill="${c}" stroke="none">8</text></svg>`,
  moon: (s,c) => svgIcon('<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>',s,c),
  star: (s,c) => svgIcon('<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',s,c),
  camera: (s,c) => svgIcon('<path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/>',s,c),
  gift: (s,c) => svgIcon('<polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/>',s,c),
  sun: (s,c) => svgIcon('<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>',s,c),
  ticket: (s,c) => svgIcon('<path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><line x1="9" y1="9" x2="9" y2="15"/><line x1="12" y1="9" x2="12" y2="15"/><line x1="15" y1="9" x2="15" y2="15"/>',s,c),
  frame: (s,c) => svgIcon('<rect x="2" y="4" width="20" height="16" rx="1"/><rect x="5" y="7" width="14" height="10"/><path d="M5 17 L10 12 L13 14 L19 9"/>',s,c),
  sofa2: (s,c) => svgIcon('<path d="M20 9V6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v3"/><path d="M2 11v5a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-5a2 2 0 0 0-4 0v2H6v-2a2 2 0 0 0-4 0Z"/><path d="M4 18v2"/><path d="M20 18v2"/><path d="M12 4v9"/>',s,c),
  lingerie: (s,c) => `<svg viewBox="0 0 24 24" width="${s}" height="${s}" fill="none" stroke="${c}" stroke-linecap="round" stroke-linejoin="round"><path stroke-width="2" d="M4 5 C6 5 8 7 10 9.5 C11 11 12 11.5 12 11.5 C12 11.5 13 11 14 9.5 C16 7 18 5 20 5"/><path stroke-width="2" d="M4 5 C4 5 3 7 3 9 C3 12 5 14 8 14 C10 14 11 13 12 12 C13 13 14 14 16 14 C19 14 21 12 21 9 C21 7 20 5 20 5"/><line stroke-width="1.5" x1="5" y1="17" x2="19" y2="17"/><line stroke-width="1.5" x1="5" y1="17" x2="12" y2="22"/><line stroke-width="1.5" x1="19" y1="17" x2="12" y2="22"/></svg>`,
  bowling: (s,c) => `<svg viewBox="0 0 24 24" width="${s}" height="${s}"><path fill-rule="evenodd" d="M12 2a10 10 0 1 1 0 20A10 10 0 0 1 12 2zm-4.5 4.7a1.8 1.8 0 1 0 0 3.6 1.8 1.8 0 0 0 0-3.6zm6 0a1.8 1.8 0 1 0 0 3.6 1.8 1.8 0 0 0 0-3.6zm-3 5a1.8 1.8 0 1 0 0 3.6 1.8 1.8 0 0 0 0-3.6z" fill="${c}"/></svg>`,
  videogame: (s,c) => `<svg viewBox="0 0 409.31 338.63" width="${s}" height="${s}" fill="${c}" stroke="${c}" stroke-width="8" stroke-linejoin="round"><path d="M253.89,266.83c-11.96-17.1-52.03-13.53-72.03-12.74-15.32.6-26.81,10.3-34.52,22.13l-17.76,27.24c-17.03,26.12-46.26,40.71-77.18,32.89C24.2,329.23-.02,303.59,0,272.1l.05-93.9c.03-62.53,50.61-119.77,113.25-120.66l76.41-1.09.45-42.03c.09-8.64,5.85-13.54,13.58-14.36,6.25-.66,14.37,4.58,14.5,12.86l.68,43.61,76.35,1.04c61.07.83,109.4,55.93,112.95,117.24,1.92,33.06.89,64.56.26,97.42-.55,28.98-20.32,52.68-45.01,61.82-27.61,10.22-60.22,3.39-77.07-20.71l-32.5-46.49ZM285.99,262.54l16.47,25.43c10.38,16.02,26.06,25.52,46.03,21.13,15.37-3.38,31.6-17.99,31.58-36.69l-.11-94.68c-.06-47.65-41.23-90.49-90.13-92.03-57.47-1.81-111.94-1.42-169.45-.18-48.74,1.05-91.44,42.7-91.74,90.39l-.59,93.19c-.12,19.26,13.8,35.51,30.59,39.73,19.66,4.95,36.55-4.24,47.2-20.64l18.37-28.31c11.61-17.88,30.81-32.31,53.09-33.4,18.09-.89,35.83-.83,53.71,0,23.96,1.12,42.4,16.64,54.98,36.07Z"/><path d="M108.01,120.17c28.56-2.65,51.43,18.82,53.56,44.63,2.29,27.7-17.63,51.34-45.07,53.48-26.4,2.06-49.92-16.85-52.85-43.2-3-26.97,15.61-52.25,44.36-54.91ZM105.91,149.16c-12.09,3.64-16.64,16.82-13,27.16,3.89,11.06,15.04,16.55,26.06,13.07,10.93-3.45,17.37-14.93,13.76-25.84-3.61-10.92-13.82-18.3-26.82-14.38Z"/><path d="M309.24,207.58c-.24,6.28-6.93,10.25-11.46,10.6s-14.25-1.8-14.59-8.09l-1.38-26.08-22-.85c-8.47-.33-13.53-7.88-13.08-14.69.58-8.76,7.26-13.42,16.26-13.59l18.97-.35.86-24.97c.22-6.32,9.42-9.97,14.58-9.56,7.07.56,12.35,6.78,12.53,14.33l.49,20.4,20.14.39c9.2.18,14.85,6.94,14.48,14.95-.39,8.5-7.16,13.2-16.25,13.41l-18.64.45-.91,23.66Z"/></svg>`,
  mask: (s,c) => `<svg viewBox="-20 -10 459.9 299.81" width="${s}" height="${s}" fill="none" overflow="visible" stroke="${c}" stroke-width="35" stroke-linecap="round" stroke-linejoin="round"><path d="M418.97,65.7c1.54,24.87,1.28,57.72-1.64,82.55-4.01,34.04-15.4,63.1-37.28,89.44-6.22,7.49-12.91,13.64-20.68,19.46-22.29,16.69-47.52,24.62-75.5,22.25-14.16-1.19-27.29-5.77-39.35-13.15l-13.71-8.38c-13.83-8.46-30.92-7.46-44.68,1.01l-11.46,7.05c-11.8,7.26-24.58,11.81-38.49,13.27-14.73,1.55-28.98,0-42.96-4.86-20.04-6.98-37.65-19.16-51.7-35.06-17.13-19.39-28.92-42.52-34.89-67.7C.99,147.79.11,122.36,0,97.9-.11,70.83,2.15,32.69,11.47,7.41c.9-2.44,2.45-4.76,4.43-6.31,2.2-1.72,4.98-1.33,6.85.53l10.17,10.11c17.65,17.54,43.67,31.65,67.81,37.59l25.92,6.38c11.56,2.84,22.82,5.05,34.24,8.45s21.24,7.39,31.06,13.15l13.2,7.74c3.09,1.81,6.7,1.43,9.64-.3l11.7-6.89c39.14-23.07,86.77-19.31,131.09-43.89,14.78-8.2,27.34-18.99,38.45-31.59,2.31-2.62,5.85-3.3,8.4-.7,1.75,1.78,3.08,4.21,4.02,6.64,6.56,16.95,9.39,39.21,10.52,57.38ZM167.81,188.66c8.06-1.32,2.56-13.73.53-18.22-7.53-16.65-21.83-28.87-39.33-34.34-12.01-3.75-24.35-4.42-36.93-3.08-8.55.91-16.68,1.21-25.14-.15-2.71-.44-5.41-.79-8.18-.76s-4.47,2.88-4.05,5.33c.34,1.98.81,3.82,1.61,5.62,4.92,11.12,12.47,20.44,22.15,27.8,19.37,14.73,44.52,19.57,68.48,19.37,7.09-.06,13.69-.39,20.86-1.56ZM251.42,188.33c7.65,1.83,14.85,1.8,22.47,1.86,14.01.11,27.5-1.45,40.88-5.53,22.27-6.78,41.44-21.63,49.8-43.79.7-1.86.93-4.08.45-5.94-.98-3.78-7.32-2.8-10.57-2.27-20.49,3.3-28.12-1.55-46.1.1-10.31.95-20.04,3.41-29.17,8.24-15.74,8.33-27.39,22.72-31.38,40.05-.66,2.88.71,6.59,3.62,7.29Z"/></svg>`,
};

function activityIcon(cat, size, color, type) {
  // Try to find iconKey from category definitions first
  const allCats = [...OUT_CATS, ...IN_CATS];
  const catObj = allCats.find(c => c.id === cat || c.id === (cat||'').toLowerCase() || c.label === cat || c.label.toLowerCase() === (cat||'').toLowerCase());
  if (catObj && catObj.iconKey && ICONS[catObj.iconKey]) {
    return ICONS[catObj.iconKey](size, color);
  }
  // Fallback: string matching (for legacy data / custom cats)
  const t = (cat||'').toLowerCase();
  const isIn = type === 'in' || ideaType === 'in';
  if (t.includes('order in')) return ICONS.dinner(size,color);
  if (t.includes('cook')) return ICONS.chefhat(size,color);
  if (t.includes('activity') && isIn) return ICONS.puzzle(size,color);
  if (t.includes('dinner')||t.includes('lunch')||t.includes('restaurant')) return ICONS.dinner(size,color);
  if (t.includes('brunch')||t.includes('coffee')||t.includes('cafe')||t.includes('tea')) return ICONS.coffee(size,color);
  if (t.includes('drink')||t.includes('bar')||t.includes('cocktail')||t.includes('wine')) return ICONS.wine(size,color);
  if (t.includes('movie')||t.includes('film')||t.includes('cinema')) return ICONS.movie(size,color);
  if (t.includes('comedy')) return ICONS.mic(size,color);
  if (t.includes('concert')||t.includes('music')||t.includes('live')||t.includes('jazz')||t.includes('gig')) return ICONS.music(size,color);
  if (t.includes('magic')) return ICONS.spade(size,color);
  if (t.includes('burlesque')) return ICONS.mask(size,color);
  if (t.includes('theatre')||t.includes('theater')||t.includes('play')) return ICONS.smile(size,color);
  if (t.includes('venue')||t.includes('show')||t.includes('performance')||t.includes('standup')) return ICONS.mic(size,color);
  if (t.includes('park')||t.includes('garden')||t.includes('picnic')) return ICONS.park(size,color);
  if (t.includes('activity')||t.includes('tennis')||t.includes('sport')||t.includes('run')||t.includes('jog')||t.includes('hike')) return ICONS.park(size,color);
  if (t.includes('museum')||t.includes('gallery')||t.includes('art')) return ICONS.painting(size,color);
  if (t.includes('book')||t.includes('library')) return ICONS.book(size,color);
  if (t.includes('game')||t.includes('board')) return ICONS.game(size,color);
  if (t.includes('in')||t.includes('cook')||t.includes('home')||t.includes('chill')) return ICONS.sofa(size,color);
  return ICONS.park(size,color);
}
// Helper: renders icon for an idea, respecting customIconKey
function ideaIcon(item, size, color) {
  if (item && item.customIconKey && ICONS[item.customIconKey]) {
    return ICONS[item.customIconKey](size, color);
  }
  return activityIcon(item ? item.category : '', size, color, item ? item.type : '');
}


// ═══════════════════════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════════════════════
function render() {
  // Keep partner place label in sync
  const _ppl = partnerPlaceLabel();
  // Only update partner-place options in location dropdowns, not task selects
  document.querySelectorAll('#date-location-select option, #ed-location-select option, #date-in-partner-option, #ed-in-partner-option').forEach(opt => {
    if (opt.id === 'date-in-partner-option' || opt.id === 'ed-in-partner-option' || opt.value === 'Her place' || (opt.value.endsWith(' place') && opt.value !== 'My place')) {
      opt.value = _ppl; opt.textContent = _ppl;
    }
  });
  const main = document.getElementById('main-content');
  if (!main) return;
  if (currentView !== 'ideas') {
    const _row = document.getElementById('top-nav-ideas-row');
    if (_row) { _row.innerHTML = ''; _row.style.display = 'none'; }
    const _appEl = document.getElementById('app');
    if (_appEl) _appEl.classList.remove('ideas-nav');
  }
  if (currentView === 'home')     main.innerHTML = renderHome();
  else if (currentView === 'ideas')    main.innerHTML = renderIdeas();
  else if (currentView === 'calendar') main.innerHTML = renderCalendar();
  else if (currentView === 'todo')     main.innerHTML = renderTodo();
  else if (currentView === 'past')     main.innerHTML = renderPastDates();
  else if (currentView === 'archive')  main.innerHTML = renderArchive();
  renderNav();
  // Initialize scroll positions after DOM update
  if (currentView === 'home') {
    setTimeout(() => { _initDateCardsScroll(); _initWeekStrip(); }, 0);
  }
  if (currentView === 'calendar') {
    setTimeout(_initCalSwipe, 0);
  }
}

function renderNav() {
  const logo = document.getElementById('nav-logo');
  const back = document.getElementById('nav-back');
  const center = document.getElementById('nav-center');
  const isHome = currentView === 'home';
  if (logo) logo.style.display = isHome ? 'flex' : 'none';
  if (back) back.style.display = isHome ? 'none' : 'flex';

  if (center) {
    if (currentView === 'ideas') {
      center.innerHTML = `<span style="font-size:13px;color:#9a8a7a;letter-spacing:0.05em;text-transform:uppercase;font-family:sans-serif">Date Ideas</span>`;
    } else {
      const titles = { calendar:'Calendar', todo:'To Do', home:'', past:'Memories', archive:'Archive' };
      const t = titles[currentView] || '';
      center.innerHTML = t ? `<span style="font-size:13px;color:#9a8a7a;letter-spacing:0.05em;text-transform:uppercase;font-family:sans-serif">${t}</span>` : '';
    }
  }

  const tabs = ['home','ideas','calendar','todo'];
  tabs.forEach(t => {
    const icon = document.getElementById('icon-'+t);
    if (icon) icon.style.stroke = currentView === t ? ROSE : '#b0a090';
  });
}


// ── Double-tap for todo tab → toggle hide locked ────────────────────────────
let _todoTabLastTap = 0;
function handleTodoTabTap() {
  const now = Date.now();
  const delta = now - _todoTabLastTap;
  _todoTabLastTap = now;
  if (delta < 350) {
    // Double tap → toggle hide locked
    toggleHideLocked();
  } else {
    // Single tap → navigate as normal
    navigate('todo');
  }
}

function navigate(view) {
  // Check if todo sheet is open — treat same as idea sheet being open
  const _todoSheetEl = document.getElementById('todo-sheet');
  const _todoSheetOpen = _todoSheetEl && _todoSheetEl.style.display === 'block';
  if (sheetOpen || _todoSheetOpen) {
    if (view === 'home') {
      closeSheet();
      closeTodoSheet();
      currentView = 'home';
      render();
      return;
    }
    switchSheetContext(view);
    return;
  }
  // Home icon tapped while already on home → toggle dark mode
  if (view === 'home' && currentView === 'home') {
    const newMode = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
    setAppearance(newMode);
    return;
  }
  // Redirect legacy out/in to ideas
  if (view === 'out' || view === 'in') { currentView = 'ideas'; render(); return; }
  currentView = view;
  // Hide ideas nav row when leaving ideas screen
  if (view !== 'ideas') {
    const row = document.getElementById('top-nav-ideas-row');
    if (row) { row.innerHTML = ''; row.style.display = 'none'; }
    document.getElementById('app').classList.remove('ideas-nav');
  }
  render();
}

function setIdeasFilter(f) {
  ideasFilter = f;
  _favScrollIdx = 0;
  // Full re-render needed so controlbar toggle styles update correctly
  const main = document.getElementById('main-content');
  if (main) main.innerHTML = renderIdeas();
}
function setIdeasSearch(q) {
  ideasSearch = q;
  _renderIdeasBody();
}


function getImageUrls(item) {
  if (!item.imageUrls || !item.imageUrls.length) return [];
  return item.imageUrls.filter(u => u && u.trim());
}

// Banner HTML for list cards (no arrows needed — shows first image only, 100px)
function cardImageBanner(item) {
  const urls = getImageUrls(item);
  if (!urls.length) return '';
  return `<div style="height:100px;overflow:hidden;border-radius:13px 13px 0 0;flex-shrink:0;margin-bottom:-10px;background:#6b2340;position:relative"><img src="${urls[0]}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;display:block" onerror="this.parentNode.style.background='#6b2340';this.style.display='none'"></div>`;
}

// Animated scroll for image carousels (shared by Idea Info + Date Info banners)
function _imgCarouselScrollTo(scrollId, idx) {
  const scroll = document.getElementById(scrollId);
  if (!scroll) return;
  const w = scroll.offsetWidth;
  if (!w) return;
  scroll.style.scrollSnapType = 'none';
  const start = scroll.scrollLeft;
  const end = idx * w;
  const duration = 200;
  const startTime = performance.now();
  const ease = t => t < 0.5 ? 2*t*t : -1+(4-2*t)*t;
  function step(now) {
    const t = Math.min((now - startTime) / duration, 1);
    scroll.scrollLeft = start + (end - start) * ease(t);
    if (t < 1) requestAnimationFrame(step);
    else {
      scroll.scrollLeft = end;
      requestAnimationFrame(() => { scroll.style.scrollSnapType = 'x mandatory'; });
    }
  }
  requestAnimationFrame(step);
}

// Banner HTML for detail popup (taller, snap-scroll carousel if multiple images)
let _detailImgIdx = 0;
function detailImageBanner(item) {
  const urls = getImageUrls(item);
  if (!urls.length) return '';
  const id = item.id;
  const pillStyle = 'background:rgba(0,0,0,0.38);border-radius:20px;display:flex;align-items:center;gap:2px;padding:3px 4px;opacity:0;transition:opacity 0.2s';
  const btn3Style = 'background:none;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:5px 4px;line-height:0';
  const btnXStyle = 'background:none;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:4px 5px;line-height:0';
  const slides = urls.map(u => `<div style="flex-shrink:0;width:100%;height:200px;scroll-snap-align:start;scroll-snap-stop:always;background:#6b2340"><img src="${u}" style="width:100%;height:100%;object-fit:cover;object-position:center;display:block" onerror="this.parentNode.style.background='#6b2340';this.style.display='none'"></div>`).join('');
  const arrows = urls.length > 1 ? `
    <div id="detail-pill-arrows" style="position:absolute;top:10px;left:10px;${pillStyle}">
      <button onclick="detailImgNav(${id},-1,event)" style="${btn3Style}">
        <svg viewBox="0 0 24 24" width="13" height="13" stroke="#fff" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
      </button>
      <button onclick="detailImgNav(${id},1,event)" style="${btn3Style}">
        <svg viewBox="0 0 24 24" width="13" height="13" stroke="#fff" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
    </div>` : '';
  const controls = `
    <div id="detail-pill-controls" style="position:absolute;top:10px;right:10px;${pillStyle}">
      <button onclick="editIdea(detailItemId);event.stopPropagation()" style="${btn3Style}">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="#fff"><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg>
      </button>
      <button onclick="closeDetail();event.stopPropagation()" style="${btnXStyle}">
        <svg viewBox="0 0 24 24" width="16" height="16" stroke="#fff" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>`;
  return `<div id="detail-img-banner" style="height:200px;position:relative;flex-shrink:0;border-radius:20px 20px 0 0;overflow:hidden;"
    onmouseenter="document.querySelectorAll('#detail-pill-arrows,#detail-pill-controls').forEach(p=>p&&(p.style.opacity='1'))"
    onmouseleave="document.querySelectorAll('#detail-pill-arrows,#detail-pill-controls').forEach(p=>p&&(p.style.opacity='0'))">
    <div id="detail-img-scroll" style="display:flex;height:200px;overflow-x:scroll;overflow-y:hidden;scrollbar-width:none;-ms-overflow-style:none;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;border-radius:20px 20px 0 0">${slides}</div>
    ${arrows}${controls}
  </div>`;
}

function detailImgNav(itemId, dir, e) {
  e.stopPropagation();
  const item = ideas.find(i => i.id === itemId);
  if (!item) return;
  const urls = getImageUrls(item);
  _detailImgIdx = (_detailImgIdx + dir + urls.length) % urls.length;
  _imgCarouselScrollTo('detail-img-scroll', _detailImgIdx);
}

// Collect image URL fields from new-idea sheet
// ── Unified image field system ──
// All rows are identical: [drag grip] [thumb] [input] [×] [+]
// The photo icon lives in static HTML to the left of the container.
function _makeImgFieldRow(value, containerId) {
  const row = document.createElement('div');
  row.className = 'img-field-row';

  // Drag grip — always draggable
  const grip = document.createElement('span');
  grip.style.cssText = 'flex-shrink:0;display:flex;align-items:center;cursor:grab;line-height:0';
  grip.innerHTML = `<svg viewBox="0 0 24 24" width="14" height="14" fill="#c0b8b0" style="display:block"><circle cx="9" cy="7" r="1.3"/><circle cx="15" cy="7" r="1.3"/><circle cx="9" cy="12" r="1.3"/><circle cx="15" cy="12" r="1.3"/><circle cx="9" cy="17" r="1.3"/><circle cx="15" cy="17" r="1.3"/></svg>`;
  row.appendChild(grip);

  // Thumb — always visible; 3 states: blank (mag glass), bad url (warning), good (image)
  const thumb = document.createElement('div');
  thumb.className = 'img-field-thumb';
  thumb.style.cssText = 'width:26px;height:26px;border-radius:4px;overflow:hidden;flex-shrink:0;background:var(--bg-card);display:flex;align-items:center;justify-content:center;border:1px solid var(--border);cursor:pointer;position:relative';

  // Magnifying glass — shown when field is empty
  const magIcon = document.createElement('span');
  magIcon.innerHTML = `<svg viewBox="0 0 24 24" width="13" height="13" stroke="#9a8a7a" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round" style="display:block"><circle cx="11" cy="11" r="6"/><line x1="19" y1="19" x2="14.65" y2="14.65"/></svg>`;
  magIcon.style.cssText = 'display:flex;align-items:center;justify-content:center;position:absolute;inset:0;pointer-events:none';
  thumb.appendChild(magIcon);

  // Warning icon — shown when text is present but not a valid/loadable image
  const warnIcon = document.createElement('span');
  warnIcon.innerHTML = `<svg viewBox="0 0 24 24" width="14" height="14" fill="none" style="display:block"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" fill="#c07a8a"/><line x1="12" y1="9" x2="12" y2="13" stroke="#fff" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="16.5" r="1" fill="#fff"/></svg>`;
  warnIcon.style.cssText = 'display:none;align-items:center;justify-content:center;position:absolute;inset:0;pointer-events:none';
  thumb.appendChild(warnIcon);

  const thumbImg = document.createElement('img');
  thumbImg.style.cssText = 'width:100%;height:100%;object-fit:cover;display:none;position:relative;z-index:1';
  thumb.appendChild(thumbImg);

  function _setThumbState(state) {
    // state: 'empty' | 'warn' | 'image'
    magIcon.style.display  = state === 'empty' ? 'flex' : 'none';
    warnIcon.style.display = state === 'warn'  ? 'flex' : 'none';
    thumbImg.style.display = state === 'image' ? 'block' : 'none';
    thumb.style.cursor = (state === 'image') ? 'grab' : 'pointer';
  }
  _setThumbState('empty');

  // Thumb click: search when empty or warn state
  thumb.onclick = () => {
    if (thumbImg.style.display === 'block') return; // has image, drag-only
    const fn = window._imgsearchFns && window._imgsearchFns[containerId];
    if (fn) fn();
    inp.focus();
  };
  row.appendChild(thumb);

  // Input
  const inp = document.createElement('input');
  inp.className = 'field-input';
  inp.type = 'text';
  inp.placeholder = 'Image URL…';
  inp.value = value || '';
  row.appendChild(inp);

  // Clear (×)
  const clearBtn = document.createElement('button');
  clearBtn.type = 'button';
  clearBtn.className = 'img-btn';
  clearBtn.style.opacity = '0.35';
  clearBtn.innerHTML = `<svg viewBox="0 0 24 24" width="13" height="13" stroke="#9a8a7a" stroke-width="2.5" fill="none" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`;
  clearBtn.title = 'Clear';
  clearBtn.onclick = () => {
    // Use row's live parent (may be popup or hidden container)
    const liveParent = row.parentNode;
    const allRows = liveParent ? liveParent.querySelectorAll('.img-field-row') : [];
    if (!inp.value.trim() && allRows.length > 1) {
      row.remove();
    } else {
      inp.value = '';
      _setThumbState('empty');
      delete thumb.dataset.imgOk;
      clearBtn.style.opacity = '0.35';
      _detachThumbDrag();
      inp.focus();
    }
  };
  row.appendChild(clearBtn);

  // Plus (+)
  const plusBtn = document.createElement('button');
  plusBtn.type = 'button';
  plusBtn.className = 'img-btn';
  plusBtn.innerHTML = `<svg viewBox="0 0 24 24" width="13" height="13" stroke="#9a8a7a" stroke-width="2.5" fill="none" stroke-linecap="round"><line x1="12" y1="4" x2="12" y2="20"/><line x1="4" y1="12" x2="20" y2="12"/></svg>`;
  plusBtn.onclick = () => {
    // Add to row's live parent
    const liveParent = row.parentNode;
    const newRow = _makeImgFieldRow('', containerId);
    if (liveParent) {
      row.insertAdjacentElement('afterend', newRow);
      newRow.querySelector('input').focus();
    }
  };
  row.appendChild(plusBtn);

  // Thumb drag state — only active when image is loaded
  let _thumbDragCleanup = null;
  function _detachThumbDrag() {
    if (_thumbDragCleanup) { _thumbDragCleanup(); _thumbDragCleanup = null; }
  }
  function _attachThumbDrag() {
    _detachThumbDrag();
    _thumbDragCleanup = _attachImgRowDrag(thumb, row);
  }

  // Update thumb state on input change
  function _updateRow() {
    const v = inp.value.trim();
    clearBtn.style.opacity = v ? '1' : '0.35';
    if (!v) {
      _setThumbState('empty');
      delete thumb.dataset.imgOk;
      _detachThumbDrag();
    } else if (/^https?:\/\//i.test(v)) {
      thumbImg.src = v;
      thumbImg.onload = () => {
        _setThumbState('image');
        thumb.dataset.imgOk = 'true';
        _attachThumbDrag();
      };
      thumbImg.onerror = () => {
        _setThumbState('warn');
        delete thumb.dataset.imgOk;
        _detachThumbDrag();
      };
    } else {
      // Has text but not a URL
      _setThumbState('warn');
      delete thumb.dataset.imgOk;
      _detachThumbDrag();
    }
  }
  inp.addEventListener('input', _updateRow);
  if (value) setTimeout(_updateRow, 0);

  // Enter key: add new row at bottom of live parent
  inp.addEventListener('keydown', e => {
    if (e.key !== 'Enter') return;
    e.preventDefault();
    if (!inp.value.trim()) return; // don't add if field is empty
    const liveParent = inp.closest('#images-popup-fields') || inp.closest('[id$="-image-fields"]');
    if (!liveParent) return;
    const allRows = liveParent.querySelectorAll('.img-field-row');
    const lastRow = allRows[allRows.length - 1];
    const newRow = _makeImgFieldRow('', containerId);
    liveParent.appendChild(newRow);
    newRow.querySelector('input').focus();
  });

  // Grip is always draggable
  _attachImgRowDrag(grip, row);

  return row;
}

function _attachImgRowDrag(handle, row) {
  let clone = null, startY = 0, offsetY = 0, dragging = false;

  function getLiveParent() { return row.parentNode; }

  function startDrag(clientY) {
    dragging = true;
    const rect = row.getBoundingClientRect();
    startY = clientY;
    offsetY = clientY - rect.top;
    // Ghost clone
    clone = row.cloneNode(true);
    clone.style.cssText = `position:fixed;left:${rect.left}px;top:${rect.top}px;width:${rect.width}px;opacity:0.85;pointer-events:none;z-index:9999;background:var(--bg-card);border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.25);box-sizing:border-box`;
    document.body.appendChild(clone);
    row.style.opacity = '0.35';
  }

  function moveDrag(clientY) {
    if (!dragging || !clone) return;
    clone.style.top = (clientY - offsetY) + 'px';
    const parent = getLiveParent();
    if (!parent) return;
    const rows = [...parent.querySelectorAll('.img-field-row')].filter(r => r !== row);
    let target = null;
    for (const r of rows) {
      const rect = r.getBoundingClientRect();
      if (clientY < rect.top + rect.height / 2) { target = r; break; }
    }
    rows.forEach(r => { r.style.borderTop = ''; r.style.borderBottom = ''; });
    if (target) target.style.borderTop = '2px solid #c07a8a';
    else if (rows.length) rows[rows.length - 1].style.borderBottom = '2px solid #c07a8a';
  }

  function endDrag(clientY) {
    if (!dragging) return;
    dragging = false;
    if (clone) { clone.remove(); clone = null; }
    row.style.opacity = '';
    const parent = getLiveParent();
    if (!parent) return;
    const rows = [...parent.querySelectorAll('.img-field-row')].filter(r => r !== row);
    rows.forEach(r => { r.style.borderTop = ''; r.style.borderBottom = ''; });
    let target = null;
    for (const r of rows) {
      const rect = r.getBoundingClientRect();
      if (clientY < rect.top + rect.height / 2) { target = r; break; }
    }
    if (target) parent.insertBefore(row, target);
    else parent.appendChild(row);
  }

  // Touch events
  handle.addEventListener('touchstart', e => {
    if (e.touches.length !== 1) return;
    e.preventDefault();
    startDrag(e.touches[0].clientY);
  }, { passive: false });
  handle.addEventListener('touchmove', e => {
    if (!dragging) return;
    e.preventDefault();
    moveDrag(e.touches[0].clientY);
  }, { passive: false });
  handle.addEventListener('touchend', e => {
    endDrag(e.changedTouches[0].clientY);
  }, { passive: true });

  // Mouse events
  handle.style.cursor = 'grab';
  function onMouseDown(e) {
    if (e.button !== 0) return;
    e.preventDefault();
    startDrag(e.clientY);
    function onMove(e) { moveDrag(e.clientY); }
    function onUp(e) { endDrag(e.clientY); window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); }
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onUp);
  }
  handle.addEventListener('mousedown', onMouseDown);

  // Return cleanup function
  return function cleanup() {
    handle.removeEventListener('mousedown', onMouseDown);
  };
}

function _addImgFieldTo(containerId, afterRow) {
  // Use afterRow's live parent if available (may be in popup), else hidden container
  const parent = (afterRow && afterRow.parentNode) || document.getElementById(containerId);
  if (!parent) return;
  const newRow = _makeImgFieldRow('', containerId);
  if (afterRow && afterRow.parentNode === parent) {
    afterRow.insertAdjacentElement('afterend', newRow);
  } else {
    parent.appendChild(newRow);
  }
  newRow.querySelector('input').focus();
}

function _collectImgUrls(containerId) {
  // Rows may be in the popup while it's open, or in the hidden container
  const hidden = document.getElementById(containerId);
  const popup = document.getElementById('images-popup-fields');
  // If popup is open for this container, collect from popup
  const source = (_imagesPopupContainerId === containerId && popup) ? popup : hidden;
  if (!source) return [];
  return [...source.querySelectorAll('.img-field-row input[type=text]')]
    .map(i => i.value.trim()).filter(Boolean);
}

function _populateImgContainer(containerId, urls) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '';
  const list = (urls && urls.length) ? urls : [''];
  list.forEach(url => container.appendChild(_makeImgFieldRow(url, containerId)));
}

// Wire static photo icon buttons
function _openExternal(url) {
  // In iOS standalone PWA mode, window.open opens in-app.
  // Using a temporary <a target="_blank"> forces Safari to open externally.
  const a = document.createElement('a');
  a.href = url;
  a.target = '_blank';
  a.rel = 'noopener noreferrer';
  document.body.appendChild(a);
  a.click();
  setTimeout(() => document.body.removeChild(a), 100);
}

// ── imgsearch: Brave image search, callable from multiple places ──
function imgsearch(getNameFn) {
  const n = getNameFn();
  if (!n) {
    _showNoNameToast();
    return;
  }
  _openExternal('https://search.brave.com/images?q=' + encodeURIComponent(n));
}

// Toast: shown when imgsearch is triggered but no name is set
function _showNoNameToast() {
  let toast = document.getElementById('imgsearch-no-name-toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'imgsearch-no-name-toast';
    toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999;background:#fff;border-radius:14px;padding:14px 18px;box-shadow:0 8px 32px rgba(0,0,0,0.18);display:flex;align-items:center;gap:10px;max-width:280px;pointer-events:none;opacity:0;transition:opacity 0.15s ease';
    toast.innerHTML = `<svg viewBox="0 0 24 24" width="20" height="20" fill="none" flex-shrink="0" style="flex-shrink:0"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" fill="#c07a8a" rx="3"/><line x1="12" y1="9" x2="12" y2="13" stroke="#fff" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="16.5" r="1" fill="#fff"/></svg><span style="font-size:13px;font-family:sans-serif;color:#281f1f;line-height:1.4">No activity or place named yet.</span>`;
    document.body.appendChild(toast);
  }
  // Show then fade out
  clearTimeout(toast._hideTimer);
  toast.style.opacity = '1';
  toast._hideTimer = setTimeout(() => { toast.style.opacity = '0'; }, 2200);
}

// Name getter functions for each context
function _getIdeaImgsearchName() { return (document.getElementById('idea-name') || {value:''}).value.trim(); }
function _getPfImgsearchName()   { return (document.getElementById('pf-name')   || {value:''}).value.trim(); }
function _getEdImgsearchName()   {
  if (edSelectedActivity && !edSelectedActivity.custom) return edSelectedActivity.name || '';
  return (document.getElementById('ed-custom-name') || {value:''}).value.trim();
}
function _getDateImgsearchName() {
  if (selectedActivity && !selectedActivity.custom && selectedActivity.name) return selectedActivity.name;
  return (document.getElementById('date-custom-name') || {value:''}).value.trim();
}

// ── Images popup ──
let _imagesPopupContainerId = null;
window._imgsearchFns = window._imgsearchFns || {};

function openImagesPopup(containerId, getNameFn) {
  _imagesPopupContainerId = containerId;
  // Store per-container so blank thumb clicks work
  if (getNameFn) window._imgsearchFns[containerId] = () => imgsearch(getNameFn);
  window._currentImgsearchFn = window._imgsearchFns[containerId] || null;

  // Move the hidden fields container into the popup
  const sourceContainer = document.getElementById(containerId);
  const popupFields = document.getElementById('images-popup-fields');
  if (sourceContainer && popupFields) {
    popupFields.innerHTML = '';
    // Ensure there's at least one row
    if (!sourceContainer.querySelector('.img-field-row')) {
      _populateImgContainer(containerId, []);
    }
    // Move rows into popup display area
    [...sourceContainer.querySelectorAll('.img-field-row')].forEach(r => popupFields.appendChild(r));
  }

  document.getElementById('images-popup-overlay').style.display = 'flex';
  document.body.classList.add('overlay-open');

  // Auto-run imgsearch if no filled image urls yet
  const existingUrls = _collectImgUrls(containerId);
  if (existingUrls.length === 0 && window._currentImgsearchFn) {
    window._currentImgsearchFn();
  }
  // Focus first input
  const firstInput = popupFields ? popupFields.querySelector('input[type=text]') : null;
  if (firstInput) setTimeout(() => firstInput.focus(), 80);
}

function closeImagesPopup() {
  if (!_imagesPopupContainerId) return;
  // Move rows back to source container
  const sourceContainer = document.getElementById(_imagesPopupContainerId);
  const popupFields = document.getElementById('images-popup-fields');
  if (sourceContainer && popupFields) {
    [...popupFields.querySelectorAll('.img-field-row')].forEach(r => sourceContainer.appendChild(r));
  }
  document.getElementById('images-popup-overlay').style.display = 'none';
  document.body.classList.remove('overlay-open');
  _imagesPopupContainerId = null;
  window._currentImgsearchFn = null;
  // Update count boxes
  _updateImgCountBox('idea-image-fields', 'idea-img-count-box');
  _updateImgCountBox('idea-image-fields', 'idea-img-count-box-in');
  _updateImgCountBox('pf-image-fields',   'pf-img-count-box');
  _updateImgCountBox('ed-image-fields',   'ed-img-count-box');
  _updateImgCountBox('date-image-fields', 'date-img-count-box');
}

function _updateImgCountBox(containerId, boxId) {
  const box = document.getElementById(boxId);
  if (!box) return;
  // Only count rows where the image loaded successfully (data-img-ok on thumb)
  const popup = document.getElementById('images-popup-fields');
  const source = (_imagesPopupContainerId === containerId && popup)
    ? popup
    : document.getElementById(containerId);
  const thumbs = source ? source.querySelectorAll('.img-field-thumb[data-img-ok]') : [];
  const n = thumbs.length;
  if (n === 0) {
    box.innerHTML = '';
    box.textContent = 'No images';
    box.style.color = 'var(--text-placeholder)';
    box.style.display = '';
    box.style.alignItems = '';
    box.style.gap = '';
    box.style.padding = '9px 14px';
  } else {
    // Build mini thumbnails + count label
    const countLabel = n === 1 ? '1 image' : n + ' images';
    let thumbsHtml = '';
    thumbs.forEach(thumb => {
      const img = thumb.querySelector('img');
      const src = img ? img.src : '';
      thumbsHtml += '<div style="width:24px;height:24px;border-radius:3px;overflow:hidden;flex-shrink:0;background:var(--bg-card)">'
        + '<img src="' + src + '" style="width:100%;height:100%;object-fit:cover;display:block" onerror="this.parentNode.style.background=\'#6b2340\';this.style.display=\'none\'">'
        + '</div>';
    });
    box.style.display = 'flex';
    box.style.alignItems = 'center';
    box.style.gap = '5px';
    box.style.padding = '9px 14px 9px 6px';
    box.style.color = 'var(--text-primary)';
    box.innerHTML = thumbsHtml
      + '<span style="font-size:14px;font-family:sans-serif;color:var(--text-placeholder);flex-shrink:0;margin-left:2px">' + countLabel + '</span>';
  }
}

function _wireImgIconBtn(btnId, getNameFn) {
  // No-op: image icon buttons no longer trigger search directly
}

// Shims
function collectNewIdeaImageUrls() { return _collectImgUrls('idea-image-fields'); }
function collectPfImageUrls()      { return _collectImgUrls('pf-image-fields'); }
function collectEdImageUrls()      { return _collectImgUrls('ed-image-fields'); }
function collectDateImageUrls()    { return _collectImgUrls('date-image-fields'); }
// After populating a container, images load async via setTimeout inside _makeImgFieldRow.
// Use a MutationObserver to watch for data-img-ok attribute changes on thumb elements,
// which fires reliably whenever an image loads or fails — regardless of timing.
function _scheduleImgCountBoxUpdate(containerId, boxId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  // Disconnect any previous observer on this container
  if (container._imgObserver) { container._imgObserver.disconnect(); container._imgObserver = null; }
  const obs = new MutationObserver(() => _updateImgCountBox(containerId, boxId));
  obs.observe(container, { subtree: true, attributes: true, attributeFilter: ['data-img-ok'] });
  container._imgObserver = obs;
  // Also schedule a one-time check after a short delay as a fallback for cached images
  setTimeout(() => _updateImgCountBox(containerId, boxId), 150);
}

function populatePfImageFields(item) {
  _populateImgContainer('pf-image-fields', getImageUrls(item));
  _wireImgIconBtn('pf-img-icon-btn', () => (document.getElementById('pf-name')||{value:''}).value.trim());
  _updateImgCountBox('pf-image-fields', 'pf-img-count-box');
  _scheduleImgCountBoxUpdate('pf-image-fields', 'pf-img-count-box');
}
function populateEdImageFields(urls) {
  _populateImgContainer('ed-image-fields', urls);
  _updateImgCountBox('ed-image-fields', 'ed-img-count-box');
  _scheduleImgCountBoxUpdate('ed-image-fields', 'ed-img-count-box');
}
function populateDateImageFields(urls) {
  _populateImgContainer('date-image-fields', urls);
  _updateImgCountBox('date-image-fields', 'date-img-count-box');
  _scheduleImgCountBoxUpdate('date-image-fields', 'date-img-count-box');
}
function addImageField(btn)   { _addImgFieldTo('idea-image-fields'); }
function addPfImageField(btn) { _addImgFieldTo('pf-image-fields'); }
function addEdImageField(btn) { _addImgFieldTo('ed-image-fields'); }

// addEdImageField, collectEdImageUrls, populateEdImageFields — now handled by unified image system shims above

// Resolve image URLs for a memory: own imageUrls > matched idea's imageUrls
function _getMemoryImageUrls(d) {
  if (d.imageUrls && d.imageUrls.filter(Boolean).length) return d.imageUrls.filter(Boolean);
  const matched = ideas.find(i => i.name && d.venue && i.name.toLowerCase() === d.venue.toLowerCase());
  return matched ? (matched.imageUrls || []).filter(Boolean) : [];
}




function ideaMatchesSearch(item, q) {
  if (!q) return true;
  const s = q.toLowerCase();
  return [item.name, item.category, item.cuisine, item.shortdesc,
    item.about, item.note, item.address, item.subwayRoute,
    item.walkDriveTime, item.type
  ].some(f => f && f.toLowerCase().includes(s));
}

function scrollFavs(dir) {
  const el = document.getElementById('favs-scroll');
  if (el) el.scrollBy({ left: dir * 180, behavior: 'smooth' });
}

function renderIdeas() {
  const q = (ideasSearch || '').trim();
  const isFavFilter = ideasFilter === 'favs';

  // Pool: apply filter, always exclude archived
  let pool = ideas.filter(i => !i.archived && !_isHiddenPrivate(i) && ideaMatchesSearch(i, q));
  if (ideasFilter === 'out')  pool = pool.filter(i => i.type === 'out');
  if (ideasFilter === 'in')   pool = pool.filter(i => i.type === 'in');
  if (ideasFilter === 'favs') pool = pool.filter(i => i.saved);

  const byName = (a,b) => a.name.localeCompare(b.name);

  // ── Heart SVG for toggle button
  const heartSvg = (active) => `<svg viewBox="0 0 24 24" width="13" height="13" stroke="${active?_toggleActiveColor:'#9a8a7a'}" stroke-width="2" fill="${active?_toggleActiveColor:'none'}" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>`;

  // ── Control bar: toggle LEFT, search pill RIGHT
  const _isDarkMode = document.body.classList.contains('dark-mode');
  const _toggleActiveBg = _isDarkMode ? '#9a8a7a' : '#fff';
  const _toggleActiveColor = _isDarkMode ? '#f0ede9' : '#2a1f1f';
  const af = f => `background:${ideasFilter===f?_toggleActiveBg:'transparent'};color:${ideasFilter===f?_toggleActiveColor:'#9a8a7a'};box-shadow:${ideasFilter===f?'0 1px 3px rgba(0,0,0,0.10)':'none'}`;
  const clearBtn = q ? `<button onclick="clearIdeasSearch()" style="background:none;border:none;cursor:pointer;padding:0;display:flex;flex-shrink:0;line-height:0;padding-top:9px"><svg viewBox="0 0 24 24" width="13" height="13" stroke="#9a8a7a" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>` : '';
  const controlBar = `<div id="ideas-controlbar" style="display:flex;align-items:center;justify-content:space-between;gap:12px;width:100%">
    <div style="display:flex;background:var(--toggle-bg);border-radius:20px;padding:2px;gap:1px;flex-shrink:0">
      <button data-filter="all" onclick="setIdeasFilter('all')" style="padding:4px 12px;border:none;border-radius:18px;font-family:sans-serif;font-size:12px;font-weight:600;cursor:pointer;${af('all')}">All</button>
      <button data-filter="out" onclick="setIdeasFilter('out')" style="padding:4px 12px;border:none;border-radius:18px;font-family:sans-serif;font-size:12px;font-weight:600;cursor:pointer;${af('out')}">Out</button>
      <button data-filter="in" onclick="setIdeasFilter('in')"  style="padding:4px 12px;border:none;border-radius:18px;font-family:sans-serif;font-size:12px;font-weight:600;cursor:pointer;${af('in')}">In</button>
      <button data-filter="favs" onclick="setIdeasFilter('favs')" style="padding:4px 10px;border:none;border-radius:18px;font-family:sans-serif;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px;${af('favs')}">${heartSvg(ideasFilter==='favs')}</button>
    </div>
    <div style="display:flex;align-items:center;background:var(--toggle-bg);border-radius:20px;padding:5px 10px;gap:6px;width:160px;flex-shrink:0;margin-left:auto">
      <svg viewBox="0 0 24 24" width="13" height="13" stroke="#9a8a7a" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input id="ideas-search-input" type="text" value="${q.replace(/"/g,'&quot;')}" oninput="ideasSearch=this.value;_renderIdeasBody()" placeholder="" style="border:none;background:transparent;outline:none;font-size:16px;font-family:sans-serif;color:var(--text-primary);width:100%;line-height:1;padding:0;min-width:0">
      ${clearBtn}
    </div>
  </div>`;

  // Inject controlbar into top nav ideas row
  setTimeout(() => {
    const row = document.getElementById('top-nav-ideas-row');
    if (row) { row.innerHTML = controlBar; row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.justifyContent = 'space-between'; }
    document.getElementById('app').classList.add('ideas-nav');
  }, 0);
  return `<div id="ideas-body">${_buildIdeasBody(pool, q, byName, isFavFilter)}</div>`;
}

// Shared body builder used by both renderIdeas (initial) and _renderIdeasBody (updates)
function _buildIdeasBody(pool, q, byName, isFavFilter) {
  // ── Small card: same image panel as home page (120px wide)
  function smallCard(item, accent, navCtx) {
    const sub = itemSubLine(item);
    const _subColor = subColor(item.type);
    const urls = getImageUrls(item);
    const imgPanel = urls.length
      ? `<div style="width:120px;flex-shrink:0;margin:-12px -14px -12px 0;border-left:1px solid var(--img-sep);border-radius:0 14px 14px 0;overflow:hidden;align-self:stretch;background:#6b2340;position:relative"><img src="${urls[0]}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;display:block" onerror="this.parentNode.style.background='#6b2340';this.style.display='none'"></div>`
      : '';
    return `<div class="quick-row" onclick="openDetail(${item.id},'${navCtx}')" style="cursor:pointer;overflow:hidden">
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;gap:7px;margin-bottom:${sub?'4px':'0'}">
          ${ideaIcon(item, 14, accent)}
          <div class="quick-row-name">${item.name}</div>
        </div>
        ${sub ? `<div class="quick-row-sub" style="color:${_subColor}">${sub}</div>` : ''}
      </div>
      ${imgPanel}
    </div>`;
  }

  // ── Fav card: full-width, image banner on top, text row identical to smallCard + nav arrows
  function favCard(item, idx, total) {
    const sub = itemSubLine(item);
    const accent = accentColor(item.type);
    const _subColor = subColor(item.type);
    const urls = getImageUrls(item);
    const hasPrev = idx > 0;
    const hasNext = idx < total - 1;
    const chevStyle = 'background:none;border:none;cursor:pointer;padding:2px;display:flex;flex-shrink:0;line-height:0';
    const navArrows = `<div style="display:flex;gap:0;flex-shrink:0;align-items:center">
      <button onclick="event.stopPropagation();scrollFavs(-1)" style="${chevStyle};opacity:${hasPrev?1:0.25}">
        <svg viewBox="0 0 24 24" width="15" height="15" stroke="#b0a090" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
      </button>
      <button onclick="event.stopPropagation();scrollFavs(1)" style="${chevStyle};opacity:${hasNext?1:0.25}">
        <svg viewBox="0 0 24 24" width="15" height="15" stroke="#b0a090" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
    </div>`;
    return `<div onclick="openDetail(${item.id},'featured')" class="quick-row" style="cursor:pointer;flex-direction:column;align-items:stretch;padding:0;flex-shrink:0;width:calc(100vw - 40px);max-width:362px;scroll-snap-align:start;overflow:hidden">
      <div style="height:100px;background:#6b2340;border-radius:13px 13px 0 0;flex-shrink:0;overflow:hidden;position:relative">${urls.length ? `<img src="${urls[0]}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;display:block" onerror="this.parentNode.style.background='#6b2340';this.style.display='none'">` : ''}</div>
      <div style="display:flex;align-items:center;gap:14px;padding:0 14px 12px">
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:7px;margin-bottom:${sub?'3px':'0'}">
            ${ideaIcon(item, 14, accent)}
            <div class="quick-row-name" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${item.name}</div>
          </div>
          ${sub ? `<div class="quick-row-sub" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:${_subColor}">${sub}</div>` : ''}
        </div>
        ${navArrows}
      </div>
    </div>`;
  }

  if (!pool.length) {
    return `<div style="padding:40px 20px;text-align:center;color:#b0a090;font-size:14px;font-style:italic">${q ? 'No matches' : (isFavFilter ? 'No favorites yet' : 'No ideas yet')}</div>`;
  }

  // ── Favs filter view: vertical list split by Going Out / Staying In
  if (isFavFilter) {
    const favOut = pool.filter(i => i.type === 'out').sort(byName);
    const favIn  = pool.filter(i => i.type === 'in').sort(byName);
    const favOutHtml = favOut.length ? `<div style="margin-bottom:20px">
      <div class="section-label" style="margin-bottom:8px">Going Out</div>
      <div style="display:flex;flex-direction:column;gap:8px">${favOut.map(i => smallCard(i, accentColor('out'), 'out')).join('')}</div>
    </div>` : '';
    const favInHtml = favIn.length ? `<div>
      <div class="section-label" style="margin-bottom:8px">Staying In</div>
      <div style="display:flex;flex-direction:column;gap:8px">${favIn.map(i => smallCard(i, accentColor('in'), 'in')).join('')}</div>
    </div>` : '';
    return `<div style="padding:12px 20px 80px">${favOutHtml}${favInHtml}</div>`;
  }

  // ── All / Out / In view: Favorites carousel + sections
  const favsOut = ideas.filter(i => !i.archived && !_isHiddenPrivate(i) && i.saved && i.type === 'out').sort(byName);
  const favsIn  = ideas.filter(i => !i.archived && !_isHiddenPrivate(i) && i.saved && i.type === 'in').sort(byName);

  // Shuffle helper (Fisher-Yates)
  function _shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  // Out: shuffle, but pin the first-alphabetically item to the end
  let shuffledFavsOut = [];
  if (favsOut.length) {
    const firstAlpha = favsOut[0]; // already sorted by name, so [0] is first alpha
    const rest = _shuffle(favsOut.filter(i => i.id !== firstAlpha.id));
    shuffledFavsOut = [...rest, firstAlpha];
  }
  const shuffledFavsIn = _shuffle(favsIn);

  // When a type filter is active, only show that type's favs; hide Featured if none
  const favs = ideasFilter === 'out' ? shuffledFavsOut
             : ideasFilter === 'in'  ? shuffledFavsIn
             : [...shuffledFavsOut, ...shuffledFavsIn];
  let favsHtml = '';
  if (!q && favs.length) {
    _featuredNavOrder = favs.map(i => i.id); // capture current shuffle order for swipe nav
    favsHtml = `<div style="margin-bottom:20px">
      <div class="section-label" style="margin-bottom:8px">Featured</div>
      <div id="favs-scroll" style="display:flex;flex-direction:row;gap:10px;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch">
        ${favs.map((item, idx) => favCard(item, idx, favs.length)).join('')}
      </div>
    </div>`;
  }

  const out = pool.filter(i => i.type === 'out').sort(byName);
  const inIdeas = pool.filter(i => i.type === 'in').sort(byName);
  const outHtml = (out.length && ideasFilter !== 'in') ? `<div style="margin-bottom:20px">
    <div class="section-label" style="margin-bottom:8px">Going Out</div>
    <div style="display:flex;flex-direction:column;gap:8px">${out.map(i => smallCard(i, accentColor('out'), 'out')).join('')}</div>
  </div>` : '';
  const inHtml = (inIdeas.length && ideasFilter !== 'out') ? `<div>
    <div class="section-label" style="margin-bottom:8px">Staying In</div>
    <div style="display:flex;flex-direction:column;gap:8px">${inIdeas.map(i => smallCard(i, accentColor('in'), 'in')).join('')}</div>
  </div>` : '';

  return `<div style="padding:12px 20px 80px">${favsHtml}${outHtml}${inHtml}</div>`;
}

// Called on keystrokes and filter changes — re-renders body + updates controlbar toggle styles
function _renderIdeasBody() {
  const q = (ideasSearch || '').trim();
  const isFavFilter = ideasFilter === 'favs';
  let pool = ideas.filter(i => !_isHiddenPrivate(i) && ideaMatchesSearch(i, q));
  if (ideasFilter === 'out')  pool = pool.filter(i => i.type === 'out');
  if (ideasFilter === 'in')   pool = pool.filter(i => i.type === 'in');
  if (ideasFilter === 'favs') pool = pool.filter(i => i.saved);
  const byName = (a,b) => a.name.localeCompare(b.name);

  // Update clear button
  const inp = document.getElementById('ideas-search-input');
  const pill = inp && inp.parentElement;
  if (pill) {
    let xBtn = pill.querySelector('.ideas-clear-btn');
    if (q && !xBtn) {
      xBtn = document.createElement('button');
      xBtn.className = 'ideas-clear-btn';
      xBtn.setAttribute('onclick','clearIdeasSearch()');
      xBtn.style.cssText = 'background:none;border:none;cursor:pointer;padding:0;display:flex;flex-shrink:0;line-height:0';
      xBtn.innerHTML = '<svg viewBox="0 0 24 24" width="13" height="13" stroke="#9a8a7a" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
      pill.appendChild(xBtn);
    } else if (!q && xBtn) {
      xBtn.remove();
    }
  }

  // Update controlbar toggle active states
  const cb = document.getElementById('ideas-controlbar');
  if (cb) {
    const _dm = document.body.classList.contains('dark-mode');
    const _activeBg = _dm ? '#9a8a7a' : '#fff';
    const _activeColor = _dm ? '#f0ede9' : '#2a1f1f';
    cb.querySelectorAll('button[data-filter]').forEach(btn => {
      const f = btn.dataset.filter;
      const active = ideasFilter === f;
      btn.style.background = active ? _activeBg : 'transparent';
      btn.style.color = active ? _activeColor : '#9a8a7a';
      btn.style.boxShadow = active ? '0 1px 3px rgba(0,0,0,0.10)' : 'none';
    });
  }

  const body = document.getElementById('ideas-body');
  if (body) body.innerHTML = _buildIdeasBody(pool, q, byName, isFavFilter);
}

// scrollFavs: scrolls the favorites list by showing next/prev card
function scrollFavs(dir) {
  const favs = ideas.filter(i => i.saved).sort((a,b) => a.name.localeCompare(b.name));
  if (!favs.length) return;
  _favScrollIdx = Math.max(0, Math.min(favs.length - 1, _favScrollIdx + dir));
  const scroll = document.getElementById('favs-scroll');
  if (!scroll) return;
  const cards = scroll.children;
  if (cards[_favScrollIdx]) cards[_favScrollIdx].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function clearIdeasSearch() {
  ideasSearch = '';
  const inp = document.getElementById('ideas-search-input');
  if (inp) inp.value = '';
  _renderIdeasBody();
}


// ── Todo state ─────────────────────────────────────────
let todos = JSON.parse(localStorage.getItem('lovelife_todos') || '[]');
let _reservedDateKeys = new Set(JSON.parse(localStorage.getItem('duet_reserved') || '[]'));
function _saveReserved() { localStorage.setItem('duet_reserved', JSON.stringify([..._reservedDateKeys])); }
function _dateKey(u) { return `${u.month}-${u.day}-${u.year||2026}`; }
function saveTodos() { localStorage.setItem('lovelife_todos', JSON.stringify(todos)); }

// Track auto-delete timers keyed by todo id
const _todoDeleteTimers = {};


function _todoDateStr(u) {
  // Convert u.day (number) + u.month (e.g. 'Feb') to YYYY-MM-DD
  const months = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};
  const m = months[u.month] || 1;
  const yr = u.year || new Date().getFullYear();
  return `${yr}-${String(m).padStart(2,'0')}-${String(u.day).padStart(2,'0')}`;
}
function _todoTimeStr(timeStr) {
  // Convert "7:30 PM" → "19:30"
  if (!timeStr) return '19:00';
  const m = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
  if (!m) return '19:00';
  let h = parseInt(m[1]); const min = m[2]; const ampm = m[3].toUpperCase();
  if (ampm === 'PM' && h !== 12) h += 12;
  if (ampm === 'AM' && h === 12) h = 0;
  return `${String(h).padStart(2,'0')}:${min}`;
}
function _buildResUrl(name, res, dateStr, timeStr, eventbriteUrl, websiteUrl) {
  const slug = name.toLowerCase().replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,'-');
  if (res === 'opentable') {
    let url = `https://www.opentable.com/s?term=${encodeURIComponent(name)}&covers=2`;
    if (dateStr) url += `&dateTime=${dateStr}${timeStr ? 'T'+timeStr : ''}`;
    return url;
  }
  if (res === 'eventbrite') return eventbriteUrl || `https://www.google.com/search?q=${encodeURIComponent(name+' eventbrite')}`;
  if (res === 'website') {
    if (!websiteUrl) return '';
    return /^https?:\/\//i.test(websiteUrl) ? websiteUrl : 'https://' + websiteUrl;
  }
  // Resy: ?date=YYYY-MM-DD&seats=2&time=HHMM (4-digit 24h, no colon)
  let url = `https://resy.com/cities/new-york-ny/venues/${slug}?seats=2`;
  if (dateStr) url += `&date=${dateStr}`;
  if (timeStr) url += `&time=${timeStr.replace(':','')}`;
  return url;
}

function _todoRow(t) {
  const PRIORITY_LABELS = { high: 'Next', normal: 'Soon', low: 'Eventually' };
  const PRIORITY_COLORS = { high: '#9a8a7a', normal: '#9a8a7a', low: '#9a8a7a' };
  const label = PRIORITY_LABELS[t.priority] || 'Soon';
  const col = PRIORITY_COLORS[t.priority] || '#9a8a7a';

  let mainHtml = '';
  const textColor = t.done ? '#b0a090' : '#7a6e6e';
  const textDecor = t.done ? 'line-through' : 'none';
  const baseStyle = `font-size:14px;font-family:sans-serif;line-height:1.4;color:${textColor};text-decoration:${textDecor}`;

  if (t.task === 'Make a reservation') {
    let placeName = '';
    let resUrl = '';
    // New format: resolve venue dynamically from the linked upcoming date
    const _linkedDate = _findDateByKey(t.dateKey);
    if (_linkedDate) {
      placeName = _linkedDate.venue || '';
      const idea = ideas.find(i => i.name && i.name.toLowerCase() === placeName.toLowerCase());
      const res = idea ? (idea.reservation || 'resy') : 'resy';
      resUrl = _buildResUrl(placeName, res, _todoDateStr(_linkedDate), _todoTimeStr(_linkedDate.time),
        idea ? idea.eventbriteUrl : '', idea ? idea.websiteUrl : '');
    } else if (t.activity && !t.activity.custom) {
      // Legacy: activity-based todo
      const idea = ideas.find(i => i.id === t.activity.id);
      placeName = idea ? idea.name : (t.activity.name || '');
      const scheduled = UPCOMING_DATES.find(u => u.venue && u.venue.toLowerCase() === placeName.toLowerCase());
      const dateStr = scheduled ? _todoDateStr(scheduled) : new Date().toISOString().split('T')[0];
      const timeStr = scheduled ? _todoTimeStr(scheduled.time) : '19:00';
      const res = idea ? (idea.reservation || 'resy') : 'resy';
      resUrl = _buildResUrl(placeName, res, dateStr, timeStr, idea ? idea.eventbriteUrl : '', idea ? idea.websiteUrl : '');
    } else if (t.activity && t.activity.custom && t.customPlace) {
      placeName = t.customPlace;
      resUrl = _buildResUrl(placeName, 'resy', new Date().toISOString().split('T')[0], '19:00', '');
    }
    if (placeName) {
      mainHtml = `<span style="${baseStyle}">Make a reservation at <a onclick="event.stopPropagation();_openExternal('${resUrl}')" class="todo-link${t.done?' done':''}">${placeName}</a></span>`;
    } else {
      mainHtml = `<span style="${baseStyle}">Make a reservation</span>`;
    }
  } else if (t.task === 'Buy tickets') {
    let actName = '';
    const _linkedDateTix = _findDateByKey(t.dateKey);
    if (_linkedDateTix) {
      actName = _linkedDateTix.venue || '';
    } else if (t.activity && !t.activity.custom) {
      const idea = ideas.find(i => i.id === t.activity.id);
      actName = idea ? idea.name : (t.activity.name || '');
    } else if (t.activity && t.activity.custom && t.customPlace) {
      actName = t.customPlace;
    }
    if (actName) {
      const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(actName + ' tickets')}`;
      mainHtml = `<span style="${baseStyle}">Buy tickets for <a onclick="event.stopPropagation();_openExternal('${searchUrl}')" class="todo-link${t.done?' done':''}">${actName}</a></span>`;
    } else {
      mainHtml = `<span style="${baseStyle}">Buy tickets</span>`;
    }
  } else if (t.task === 'Buy something' && t.note) {
    mainHtml = `<span style="${baseStyle}">Buy ${t.note}</span>`;
  } else if (t.task === 'Other' && t.note) {
    mainHtml = `<span style="${baseStyle}">${t.note}</span>`;
  } else {
    let displayText = t.task;
    if (t.task === 'Message' && t.note) displayText = `Message about ${t.note}`;
    else if (t.task === 'Message') displayText = `Message ${partnerObj()}`;
    else if (t.note && t.task !== 'Other') displayText = `${t.task} ${t.note}`;
    mainHtml = `<span style="${baseStyle}">${displayText}</span>`;
  }

  return `<div id="todo-row-${t.id}" onclick="openTodoEdit('${t.id}')" style="display:flex;align-items:flex-start;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--todo-divider);cursor:pointer;gap:12px;opacity:${t.done?'0.45':'1'}">
    <div style="flex:1;min-width:0">
      <div style="line-height:1.4">${mainHtml}</div>
      <div style="font-size:11px;margin-top:3px;font-family:sans-serif;color:${t.done?'#c8bfb6':col};font-weight:500;letter-spacing:0.03em">${label}</div>
    </div>
    <button onclick="event.stopPropagation();toggleTodoDone('${t.id}')" style="width:20px;height:20px;flex-shrink:0;margin-top:2px;margin-left:-2px;border:1.5px solid ${t.done?'#c8bfb6':'#9a8a7a'};border-radius:4px;background:${t.done?'#c8bfb6':'var(--bg-input)'};cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0">
      ${t.done?'<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>':''}
    </button>
  </div>`;
}

function renderTodo() {
  const priorityOrder = { high: 0, normal: 1, low: 2 };
  const sorted = [...todos].sort((a, b) => {
    if (a.done !== b.done) return a.done ? 1 : -1;
    const pa = priorityOrder[a.priority ?? 'normal'] ?? 1;
    const pb = priorityOrder[b.priority ?? 'normal'] ?? 1;
    if (pa !== pb) return pa - pb;
    return (a.createdAt || 0) - (b.createdAt || 0);
  });

  function todoRow(t) { return _todoRow(t); }

  const filtered = sorted.filter(t => !_isTodoHiddenPrivate(t));
  const listHtml = filtered.length
    ? filtered.map(todoRow).join('')
    : `<div style="padding:60px 20px;text-align:center;color:#b0a090;font-size:15px;font-style:italic">Nothing to do…</div>`;

  return `<div style="padding:20px 20px 80px"><div style="padding:0 10px">${listHtml}</div></div>`;
}

function _scheduleTodoDelete(id) {
  if (_todoDeleteTimers[id]) clearTimeout(_todoDeleteTimers[id]);
  _todoDeleteTimers[id] = setTimeout(() => {
    delete _todoDeleteTimers[id];
    const t = todos.find(t => t.id === id);
    if (t && t.done) {
      todos = todos.filter(t => t.id !== id);
      saveTodos();
      if (currentView === 'todo') {
        const main = document.getElementById('main-content');
        if (main) { main.innerHTML = renderTodo(); todos.filter(t=>t.done).forEach(t=>_scheduleTodoDelete(t.id)); }
      } else if (currentView === 'home') {
        const main = document.getElementById('main-content');
        if (main) { main.innerHTML = renderHome(); setTimeout(_initWeekStrip, 0); }
      }
    }
  }, 5000);
}


// ── Todo activity selection ─────────────────────────
let _todoSelectedActivity = null;     // kept for legacy compat, not used for new todos
let _editTodoSelectedActivity = null; // kept for legacy compat
let _todoSelectedDateKey = null;      // NEW: {day, month, year} key for selected upcoming date
let _editTodoSelectedDateKey = null;  // NEW: for edit todo
let _editTodoIdx = 0;
let _upcomingPickerContext = null;    // 'ts' or 'et'

// ── Upcoming Dates Picker ──────────────────────────────
function _dateObjKey(u) {
  // Returns a stable string key for an upcoming date object
  return `${u.year||2026}-${u.month}-${u.day}`;
}
function _findDateByKey(key) {
  if (!key) return null;
  return UPCOMING_DATES.find(u => _dateObjKey(u) === key) || null;
}

function openUpcomingDatesPicker(context) {
  _upcomingPickerContext = context;
  const list = document.getElementById('upcoming-dates-picker-list');
  if (!list) return;

  const now = new Date(); now.setHours(0,0,0,0);
  const upcoming = UPCOMING_DATES
    .filter(u => {
      const dt = new Date((u.year||2026), MONTH_NUMS[u.month]||0, u.day);
      dt.setHours(0,0,0,0);
      return dt >= now;
    })
    .filter(u => !_isDateHiddenPrivate(u))
    .sort((a,b) => new Date((a.year||2026),MONTH_NUMS[a.month]||0,a.day) - new Date((b.year||2026),MONTH_NUMS[b.month]||0,b.day));

  if (upcoming.length === 0) {
    list.innerHTML = '<div style="padding:40px 0;text-align:center;color:#b0a090;font-size:14px;font-style:italic;font-family:sans-serif">No upcoming dates</div>';
  } else {
    list.innerHTML = upcoming.map(u => {
      const key = _dateObjKey(u);
      const currentKey = context === 'ts' ? _todoSelectedDateKey : _editTodoSelectedDateKey;
      const isSelected = currentKey === key;
      const borderStyle = isSelected ? `border-color:${ROSE};` : '';
      return `<div class="upcoming-item" onclick="selectUpcomingDate('${key}')" style="${borderStyle}cursor:pointer">
        <div class="upcoming-date-badge">
          <span class="upcoming-month">${u.month}</span>
          <span class="upcoming-day-num">${u.day}</span>
        </div>
        <div class="upcoming-divider"></div>
        <div class="upcoming-info">
          <div class="upcoming-venue-row">
            ${activityIcon(u.activity, 14, ROSE)}
            <span class="upcoming-venue">${u.venue}</span>
          </div>
          <span class="upcoming-sub">${u.time ? u.time + ((_dateLocationLabel(u) || u.neighborhood) ? ' · ' + (_dateLocationLabel(u) || u.neighborhood) : '') : (_dateLocationLabel(u) || u.neighborhood || '')}</span>
        </div>
      </div>`;
    }).join('');
  }

  document.getElementById('upcoming-dates-picker-overlay').style.display = 'flex';
}

function closeUpcomingDatesPicker() {
  document.getElementById('upcoming-dates-picker-overlay').style.display = 'none';
  _upcomingPickerContext = null;
}

function selectUpcomingDate(key) {
  const u = _findDateByKey(key);
  if (!u) return;
  const ctx = _upcomingPickerContext;
  if (ctx === 'ts') {
    _todoSelectedDateKey = key;
    _updateTodoDateBtn('ts-date-btn', 'ts-date-icon', 'ts-date-label', u);
    // Update privacy from linked idea
    _tsIsPrivate = null;
    _renderPrivacyBox('ts-lock-icon', 'ts-privacy-box', _effectivePrivate(_tsIsPrivate, _tsIdeaIsPrivate()), _tsIsPrivate === null && _tsIdeaIsPrivate());
  } else if (ctx === 'et') {
    _editTodoSelectedDateKey = key;
    _updateTodoDateBtn('et-date-btn', 'et-date-icon', 'et-date-label', u);
    _etIsPrivate = null;
    _renderPrivacyBox('et-lock-icon', 'et-privacy-box', _effectivePrivate(_etIsPrivate, _etIdeaIsPrivate()), _etIsPrivate === null && _etIdeaIsPrivate());
  }
  closeUpcomingDatesPicker();
}

function _updateTodoDateBtn(btnId, iconId, labelId, u) {
  const btn = document.getElementById(btnId);
  const iconEl = document.getElementById(iconId);
  const labelEl = document.getElementById(labelId);
  if (!btn || !labelEl) return;
  if (!u) {
    if (iconEl) { iconEl.innerHTML = ''; iconEl.style.display = 'none'; }
    labelEl.textContent = 'Select date…';
    labelEl.style.fontSize = '16px';
    labelEl.style.color = 'var(--text-placeholder)';
    btn.style.borderColor = 'var(--border)';
  } else {
    // Show month+day badge as icon
    const matchedIdea = ideas.find(i => i.name && u.venue && i.name.toLowerCase() === u.venue.toLowerCase());
    const accent = matchedIdea ? accentColor(matchedIdea.type) : ROSE;
    if (iconEl) {
      iconEl.innerHTML = `<span style="font-size:11px;font-weight:700;font-family:sans-serif;color:${accent};line-height:1;white-space:nowrap">${u.month} ${u.day}</span>`;
      iconEl.style.display = 'flex';
      iconEl.style.alignItems = 'center';
    }
    labelEl.textContent = u.venue;
    labelEl.style.fontSize = '';
    labelEl.style.color = document.body.classList.contains('dark-mode') ? 'var(--text-primary)' : '#2a1f1f';
    btn.style.borderColor = accent;
  }
}

// ── Privacy helpers for ts/et that use dateKey ─────────
function _tsIdeaIsPrivate() {
  const u = _findDateByKey(_todoSelectedDateKey);
  if (!u) return false;
  const idea = ideas.find(i => i.name && u.venue && i.name.toLowerCase() === u.venue.toLowerCase());
  return !!(idea && idea.isPrivate);
}
function _etIdeaIsPrivate() {
  const u = _findDateByKey(_editTodoSelectedDateKey);
  if (!u) return false;
  const idea = ideas.find(i => i.name && u.venue && i.name.toLowerCase() === u.venue.toLowerCase());
  return !!(idea && idea.isPrivate);
}

function openIdeasPickerForTodo() {
  ideasPickerContext = 'todo';
  openIdeasPicker();
}
function openIdeasPickerForEditTodo() {
  ideasPickerContext = 'edittodo';
  openIdeasPicker();
}

function _applyActivityToTodo(item) {
  _todoSelectedActivity = item;
  _tsIsPrivate = null;
  _updateActivityBtn('ts-activity-btn','ts-activity-icon','ts-activity-label','ts-custom-wrap', item);
  _renderPrivacyBox('ts-lock-icon', 'ts-privacy-box', _effectivePrivate(_tsIsPrivate, _tsIdeaIsPrivate()), _tsIsPrivate === null && _tsIdeaIsPrivate());
}
function _applyActivityToEditTodo(item) {
  _editTodoSelectedActivity = item;
  _etIsPrivate = null;
  _updateActivityBtn('et-activity-btn','et-activity-icon','et-activity-label','et-custom-wrap', item);
  _renderPrivacyBox('et-lock-icon', 'et-privacy-box', _effectivePrivate(_etIsPrivate, _etIdeaIsPrivate()), _etIsPrivate === null && _etIdeaIsPrivate());
}
function _updateActivityBtn(btnId, iconId, labelId, customWrapId, item) {
  const btn = document.getElementById(btnId);
  const iconEl = document.getElementById(iconId);
  const labelEl = document.getElementById(labelId);
  const customWrap = document.getElementById(customWrapId);
  if (!btn || !iconEl || !labelEl) return;
  // Info arrow button (ts, et, date contexts)
  const infoBtnMap = {'ts-activity-btn':'ts-activity-info-btn','et-activity-btn':'et-activity-info-btn','date-activity-btn':'date-activity-info-btn'};
  const infoBtn = infoBtnMap[btnId] ? document.getElementById(infoBtnMap[btnId]) : null;
  if (item && item.custom) {
    iconEl.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" stroke="#9a8a7a" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
    labelEl.textContent = 'Custom';
    labelEl.style.color = '#9a8a7a';
    btn.style.borderColor = '#b0a090';
    if (customWrap) customWrap.style.display = 'block';
    if (infoBtn) infoBtn.style.display = 'none';
  } else if (item) {
    const accent = accentColor(item.type);
    iconEl.innerHTML = ideaIcon(item, 16, accent);
    labelEl.textContent = item.name;
    labelEl.style.color = document.body.classList.contains('dark-mode') ? 'var(--text-primary)' : '#2a1f1f';
    btn.style.borderColor = '#c07a8a';
    if (customWrap) customWrap.style.display = 'none';
    if (infoBtn) { infoBtn.style.display = 'flex'; infoBtn.dataset.ideaId = item.id; }
  } else {
    iconEl.innerHTML = '';
    labelEl.textContent = 'Choose activity…';
    labelEl.style.color = '#b0a090';
    btn.style.borderColor = document.body.classList.contains('dark-mode') ? 'var(--border)' : '#ede9e2';
    if (customWrap) customWrap.style.display = 'none';
    if (infoBtn) infoBtn.style.display = 'none';
  }
}

// ── New To Do sheet ───────────────────────────────────
let _todoEditId = null;

function openTodoAdd() {
  _todoEditId = null;
  _todoSelectedActivity = null;
  _todoSelectedDateKey = null;
  const ts = document.getElementById('todo-sheet');
  if (!ts) return;
  document.getElementById('ts-task').value = '';
  document.getElementById('ts-priority').value = 'normal';
  document.getElementById('ts-note').value = '';
  _updateTodoDateBtn('ts-date-btn', 'ts-date-icon', 'ts-date-label', null);
  onTodoTaskChange();
  ts.style.display = 'block';
  document.getElementById('btn-new-circle').style.background = '#a05268';
  document.getElementById('btn-new-icon-plus').style.display = 'none';
  document.getElementById('btn-new-icon-check').style.display = 'block';
  // Defer overlay so the current click event doesn't immediately close it
  setTimeout(() => { document.getElementById('sheet-overlay').style.display = 'block'; }, 0);
}

function closeTodoSheet() {
  const ts = document.getElementById('todo-sheet');
  if (ts) ts.style.display = 'none';
  const ideaSheet = document.getElementById('idea-sheet');
  const ideaSheetVisible = ideaSheet && (ideaSheet.style.display === 'block' || ideaSheet.offsetParent !== null);
  if (!ideaSheetVisible) {
    document.getElementById('sheet-overlay').style.display = 'none';
  }
  _todoEditId = null;
  _todoSelectedActivity = null;
  _todoSelectedDateKey = null;
  document.getElementById('btn-new-circle').style.background = ROSE;
  document.getElementById('btn-new-icon-plus').style.display = 'block';
  document.getElementById('btn-new-icon-check').style.display = 'none';
}

function onTodoTaskChange() {
  const task = (document.getElementById('ts-task') || {}).value || '';
  const actWrap = document.getElementById('ts-activity-wrap');
  const noteWrap = document.getElementById('ts-note-wrap');
  const noteInp = document.getElementById('ts-note');
  const usesActivity = task === 'Make a reservation' || task === 'Buy tickets';
  const noteConfig = {
    'Buy something':'Buy what?',
    'Message':'What about?',
    'Plan a date':'For when? For what?',
    'Other':'Describe the to do'
  };
  if (actWrap) actWrap.style.display = usesActivity ? 'block' : 'none';
  if (noteWrap) noteWrap.style.display = (task in noteConfig) ? 'block' : 'none';
  if (noteInp) {
    noteInp.placeholder = noteConfig[task] || '';
    if (noteInp.tagName === 'TEXTAREA') noteInp.style.height = '36px';
  }
  if (usesActivity && noteInp) noteInp.value = '';
  if (!usesActivity) {
    _todoSelectedActivity = null;
    _todoSelectedDateKey = null;
    _updateTodoDateBtn('ts-date-btn', 'ts-date-icon', 'ts-date-label', null);
  }
}

function saveTodoFromSheet() {
  const task = (document.getElementById('ts-task') || {}).value || '';
  const priority = (document.getElementById('ts-priority') || {}).value || 'normal';
  const note = ((document.getElementById('ts-note') || {}).value || '').trim();
  if (!task) return;
  const usesDate = task === 'Make a reservation' || task === 'Buy tickets';
  const todoObj = {
    task, priority,
    note: usesDate ? '' : note,
    dateKey: usesDate ? (_todoSelectedDateKey || null) : null,
    activity: null,  // legacy field cleared
    customPlace: '',
    done: false, createdAt: Date.now(), id: String(Date.now()),
    isPrivate: _tsIsPrivate
  };
  todos.unshift(todoObj);
  _tsIsPrivate = null;
  _renderPrivacyBox('ts-lock-icon', 'ts-privacy-box', false, false);
  saveTodos();
  closeTodoSheet();
  navigate('todo');
}

function deleteTodoFromSheet() {
  // no-op on new sheet (no delete for new)
}

// ── Edit To Do popup ──────────────────────────────────
function openTodoEdit(id) {
  const idx = todos.findIndex(t => t.id === id);
  if (idx < 0) return;
  _editTodoIdx = idx;
  _populateEditTodo(todos[idx]);
  updateEditTodoNav();
  document.getElementById('edit-todo-overlay').style.display = 'flex';
}

function _populateEditTodo(t) {
  _etIsPrivate = t.isPrivate === true ? true : t.isPrivate === false ? false : null;
  document.getElementById('et-task').value = t.task || '';
  document.getElementById('et-priority').value = t.priority || 'normal';
  document.getElementById('et-note').value = t.note || '';
  // Restore dateKey (new format) or migrate legacy activity — MUST happen before privacy render
  _editTodoSelectedDateKey = t.dateKey || null;
  if (!_editTodoSelectedDateKey && t.activity && !t.activity.custom) {
    const idea = ideas.find(i => i.id === t.activity.id);
    const name = idea ? idea.name : (t.activity.name || '');
    if (name) {
      const matched = UPCOMING_DATES.find(u => u.venue && u.venue.toLowerCase() === name.toLowerCase());
      if (matched) _editTodoSelectedDateKey = _dateObjKey(matched);
    }
  }
  // Now _etIdeaIsPrivate() can correctly resolve via _editTodoSelectedDateKey
  _renderPrivacyBox('et-lock-icon', 'et-privacy-box', _effectivePrivate(_etIsPrivate, _etIdeaIsPrivate()), _etIsPrivate === null && _etIdeaIsPrivate());
  const u = _findDateByKey(_editTodoSelectedDateKey);
  _updateTodoDateBtn('et-date-btn', 'et-date-icon', 'et-date-label', u);
  onEditTodoTaskChange();
}

function onEditTodoTaskChange() {
  const task = (document.getElementById('et-task') || {}).value || '';
  const actWrap = document.getElementById('et-activity-wrap');
  const noteWrap = document.getElementById('et-note-wrap');
  const noteLabel = document.getElementById('et-note-label');
  const usesActivity = task === 'Make a reservation' || task === 'Buy tickets';
  const noteConfig = {
    'Buy something':'Buy what?',
    'Message':'What about?',
    'Plan a date':'For when? For what?',
    'Other':'Describe the to do'
  };
  if (actWrap) actWrap.style.display = usesActivity ? 'block' : 'none';
  if (noteWrap) noteWrap.style.display = (task in noteConfig) ? 'block' : 'none';
  if (noteLabel && noteConfig[task]) noteLabel.textContent = noteConfig[task];
  const etNoteEl = document.getElementById('et-note');
  if (etNoteEl && etNoteEl.tagName === 'TEXTAREA') etNoteEl.style.height = '36px';
  if (!usesActivity) {
    _editTodoSelectedActivity = null;
    _editTodoSelectedDateKey = null;
    _updateTodoDateBtn('et-date-btn', 'et-date-icon', 'et-date-label', null);
  }
}

function updateEditTodoNav() {
  const prev = document.getElementById('et-prev-btn');
  const next = document.getElementById('et-next-btn');
  if (prev) prev.style.opacity = _editTodoIdx === 0 ? '0.3' : '1';
  if (next) next.style.opacity = _editTodoIdx === todos.length - 1 ? '0.3' : '1';
}

function editTodoNav(dir) {
  const newIdx = _editTodoIdx + dir;
  if (newIdx < 0 || newIdx >= todos.length) return;
  _editTodoIdx = newIdx;
  _populateEditTodo(todos[_editTodoIdx]);
  updateEditTodoNav();
}

function closeEditTodo() {
  document.getElementById('edit-todo-overlay').style.display = 'none';
  _editTodoSelectedActivity = null;
  _editTodoSelectedDateKey = null;
}

function saveEditTodo() {
  const t = todos[_editTodoIdx];
  if (!t) return;
  const task = (document.getElementById('et-task') || {}).value || t.task;
  const priority = (document.getElementById('et-priority') || {}).value || t.priority;
  const note = ((document.getElementById('et-note') || {}).value || '').trim();
  const usesDate = task === 'Make a reservation' || task === 'Buy tickets';
  Object.assign(t, {
    task, priority,
    note: usesDate ? '' : note,
    dateKey: usesDate ? (_editTodoSelectedDateKey || null) : null,
    activity: null,
    customPlace: '',
    isPrivate: _etIsPrivate
  });
  saveTodos();
  closeEditTodo();
  navigate('todo');
}

function deleteTodoFromEdit() {
  todos.splice(_editTodoIdx, 1);
  saveTodos();
  closeEditTodo();
  navigate('todo');
}

function toggleTodoDone(id) {
  const t = todos.find(t => t.id === id);
  if (!t) return;
  t.done = !t.done;
  t.doneAt = t.done ? Date.now() : null;
  saveTodos();

  // Update only the specific row in-place so nothing shifts position
  const row = document.getElementById('todo-row-' + id);
  if (row) {
    row.outerHTML = _todoRow(t);
  }

  if (t.done) {
    _scheduleTodoDelete(id);
  } else {
    if (_todoDeleteTimers[id]) { clearTimeout(_todoDeleteTimers[id]); delete _todoDeleteTimers[id]; }
  }
}

// ── Home ──────────────────────────────────────────────
function _buildDateCardHtml(fd, idx) {
  const isFirstCard = idx === 0;
  const cc = isFirstCard ? BURGUNDY : ROSE;
  const cs = isFirstCard ? '0 2px 12px rgba(139,58,82,0.3)' : '0 2px 12px rgba(192,122,138,0.3)';
  const [dm, dd] = fd.dayShort.split(' ');
  const commute = _nextDateCommuteHtml(fd, cc);
  const locLabel = _dateLocationLabel(fd) || fd.neighborhood;
  const timePart = fd.time ? _shortTime(fd.time) : '';
  const inner = commute
    ? `<div style="display:flex;align-items:baseline;gap:7px;margin-bottom:2px"><div style="display:flex;align-items:center;gap:5px;min-width:0;flex-shrink:1;overflow:hidden">${activityIcon(fd.activity,14,'#fff')}<span style="font-size:15px;font-weight:700;color:#fff;letter-spacing:-0.01em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${fd.venue}</span></div>${timePart ? `<span style="font-size:12px;color:rgba(255,255,255,0.65);font-family:sans-serif;white-space:nowrap;flex-shrink:0;position:relative;bottom:2px">${timePart}</span>` : ''}</div>${commute}`
    : `<div style="display:flex;align-items:center;gap:7px;margin-bottom:2px">${activityIcon(fd.activity,14,'#fff')}<span style="font-size:15px;font-weight:700;color:#fff;letter-spacing:-0.01em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${fd.venue}</span></div><span style="font-size:12px;color:rgba(255,255,255,0.65);font-family:sans-serif">${timePart}${locLabel ? (timePart ? ' · ' : '') + locLabel : ''}</span>`;
  return `<div class="date-card-slide" onclick="openDateInfo(FUTURE_DATES[${idx}])">
    <div style="background:${cc};box-shadow:none;padding:12px 14px;min-height:70px;box-sizing:border-box;display:flex;align-items:center">
      <div style="display:flex;align-items:center;gap:14px;width:100%">
        <div style="width:40px;flex-shrink:0;display:flex;flex-direction:column;align-items:center">
          <span style="font-size:10px;font-family:sans-serif;font-weight:600;color:rgba(255,255,255,0.7);letter-spacing:0.06em;text-transform:uppercase">${dm}</span>
          <span style="font-size:22px;font-weight:700;color:#fff;line-height:1.1">${dd}</span>
        </div>
        <div style="width:1px;height:36px;background:rgba(255,255,255,0.25);flex-shrink:0"></div>
        <div style="flex:1;min-width:0;padding-right:52px">${inner}</div>
      </div>
    </div>
  </div>`;
}

function renderHome() {
  const savedIdeas = ideas.filter(i => !i.archived && !_isHiddenPrivate(i)).slice(0, 5);

  const visibleDates = FUTURE_DATES.filter(fd => !_isDateHiddenPrivate(fd._ref || fd));
  const dateBubbleHTML = visibleDates.length > 0 ? `
  <div id="date-cards-outer">
    <div id="date-cards-scroll">
      <div id="date-cards-inner">
        ${visibleDates.map((fd, i) => _buildDateCardHtml(fd, i)).join('')}
      </div>
    </div>
    <div id="date-cards-arrows">
      <button id="date-btn-prev" onclick="event.stopPropagation();prevDate()">
        <svg viewBox="0 0 24 24" width="16" height="16" stroke="#fff" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
      </button>
      <button id="date-btn-next" onclick="event.stopPropagation();nextDate()">
        <svg viewBox="0 0 24 24" width="16" height="16" stroke="#fff" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
    </div>
  </div>
  ${renderWeekStrip()}` : `<div style="padding:22px 20px 8px">
    <div id="next-date-card" style="background:${ROSE};box-shadow:0 2px 12px rgba(192,122,138,0.3)">
      <div style="display:flex;align-items:center;gap:14px;cursor:pointer" onclick="navigate('calendar')">
        <div style="flex:1;min-width:0">
          <span style="font-size:15px;font-weight:700;color:#fff">No upcoming dates</span><br>
          <span style="font-size:12px;color:rgba(255,255,255,0.75);font-family:sans-serif">Tap to plan one →</span>
        </div>
      </div>
    </div>
  </div>
  ${renderWeekStrip()}`;

  return `
  ${dateBubbleHTML}

  <div style="padding:24px 20px 0">
    <button onclick="navigate('out')" style="background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;gap:4px;margin-bottom:12px">
      <span class="section-label">Latest Ideas</span>
      <span style="font-size:11px;color:#9a8a7a;font-family:sans-serif;letter-spacing:0.05em;line-height:1">›</span>
    </button>
    <div style="display:flex;flex-direction:column;gap:8px">
      ${savedIdeas.map(item => renderQuickRow(item, 'latest')).join('')}
    </div>
  </div>

  ${(() => {
    const priorityOrder = { high: 0, normal: 1, low: 2 };
    const active = todos.filter(t => !t.done && !_isTodoHiddenPrivate(t)).sort((a,b) => {
      const pa = priorityOrder[a.priority ?? 'normal'] ?? 1;
      const pb = priorityOrder[b.priority ?? 'normal'] ?? 1;
      if (pa !== pb) return pa - pb;
      return (a.createdAt || 0) - (b.createdAt || 0);
    }).slice(0, 3);
    // Also include done todos that are pending deletion (in the 5s window)
    const pendingDone = todos.filter(t => t.done && _todoDeleteTimers[t.id]);
    const visible = [...active, ...pendingDone];
    if (visible.length === 0) return '';
    return '<div style="padding:36px 20px 32px">' +
      '<button onclick="navigate(\'todo\')" style="background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;gap:4px;margin-bottom:6px">' +
        '<span class="section-label">To Do</span>' +
        '<span style="font-size:11px;color:#9a8a7a;font-family:sans-serif;letter-spacing:0.05em;line-height:1">›</span>' +
      '</button>' +
      '<div style="padding:0 10px">' + visible.map(t => _todoRow(t)).join('') + '</div>' +
      '</div>';

  })()}`;
}

function renderWeekStrip() {
  const today = new Date(); today.setHours(0,0,0,0);

  // Map all FUTURE_DATES to timestamps → index
  const futureDateMap = {};
  FUTURE_DATES.forEach((fd, idx) => {
    const mNum = MONTH_NUMS[fd._ref.month] ?? 0;
    const dt = new Date(fd._ref.year || new Date().getFullYear(), mNum, fd._ref.day);
    dt.setHours(0,0,0,0);
    futureDateMap[dt.getTime()] = idx;
  });

  // Selected date timestamp
  let selectedTs = null;
  if (FUTURE_DATES[dateIdx]) {
    const fd = FUTURE_DATES[dateIdx];
    const mNum = MONTH_NUMS[fd._ref.month] ?? 0;
    const sel = new Date(fd._ref.year || new Date().getFullYear(), mNum, fd._ref.day);
    sel.setHours(0,0,0,0);
    selectedTs = sel.getTime();
  }

  // Sunday of today's week
  const todaySunday = new Date(today);
  todaySunday.setDate(today.getDate() - today.getDay());

  // Build exactly 4 weeks starting from today's Sunday
  const DAY_LABELS = ['S','M','T','W','T','F','S'];
  const weeks = [];
  for (let w = 0; w < 4; w++) {
    const week = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(todaySunday);
      d.setDate(todaySunday.getDate() + w * 7 + i);
      const ts = d.getTime();
      week.push({
        d, ts,
        label: DAY_LABELS[i],
        num: d.getDate(),
        isToday: ts === today.getTime(),
        isSelected: ts === selectedTs,
        hasFutureDate: futureDateMap[ts] !== undefined,
        fdIdx: futureDateMap[ts]
      });
    }
    weeks.push(week);
  }

  // Which week page to show initially: the one containing the selected date (or 0)
  let initPage = 0;
  weeks.forEach((week, wi) => {
    if (week.some(d => d.isSelected)) initPage = wi;
  });

  // Build pages HTML
  const pagesHtml = weeks.map(week => {
    const daysHtml = week.map(day => {
      const dotColor = day.hasFutureDate ? (day.fdIdx === 0 ? BURGUNDY : ROSE) : 'transparent';
      const _isDark = document.body.classList.contains('dark-mode');
      const numColor = day.isSelected ? '#fff' : day.isToday ? ROSE : (_isDark ? '#f0ede9' : '#2a1f1f');
      const numWeight = (day.isSelected || day.isToday) ? 700 : 400;
      const labelColor = day.isToday ? ROSE : '#b0a090';
      const labelWeight = day.isToday ? 700 : 400;
      const bgColor = day.isSelected ? ROSE : day.isToday ? 'rgba(192,122,138,0.15)' : 'transparent';
      const m = day.d.getMonth(), y = day.d.getFullYear(), dn = day.d.getDate();
      const clickHandler = day.hasFutureDate
        ? `selectWeekDate(${day.fdIdx})`
        : `showWeekTooltip(event,${dn},${m},${y})`;
      return `<div class="week-day" onclick="${clickHandler}">
          <span class="week-day-label" style="color:${labelColor};font-weight:${labelWeight}">${day.label}</span>
          <div class="week-day-num-wrap" style="background:${bgColor}">
            <span class="week-day-num" style="color:${numColor};font-weight:${numWeight}">${day.num}</span>
          </div>
          <div class="week-day-dot" style="background:${dotColor}"></div>
        </div>`;
    }).join('');
    return `<div class="week-page">${daysHtml}</div>`;
  }).join('');

  return `
  <div id="week-strip">
    <div id="week-strip-scroll" data-init-page="${initPage}">
      <div id="week-strip-inner">${pagesHtml}</div>
    </div>
    <div id="week-tooltip">
      <span onclick="closeWeekTooltip();openNewDateFromCal(_weekTooltipDay,_weekTooltipMonth,_weekTooltipYear)" style="color:${ROSE};cursor:pointer;font-size:14px;font-style:italic;text-decoration:none">Plan a date ›</span>
    </div>
  </div>`;
}

function toTitleCase(str) {
  return (str || '').replace(/\w\S*/g, w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase());
}

const CAT_LABELS = {
  restaurant:'Restaurant', bar:'Bar', cafe:'Cafe', movie:'Movie',
  museum:'Museum', bookstore:'Bookstore', livemusic:'Live Music',
  livejazz:'Live Jazz', concert:'Concert', livecomedy:'Live Comedy',
  theatre:'Theatre',
  venue:'Venue', park:'Park', other:'Other',
  'orderin':'Delivery', Cook:'Cook', Movie:'Movie', Game:'Game',
  Activity:'Activity', Other:'Other'
};
function catLabel(cat, type) {
  return catLabelForId(cat, type) || CAT_LABELS[cat] || toTitleCase(cat||'');
}



function _isDateHiddenPrivate(date) {
  if (typeof hidePrivate === 'undefined' || !hidePrivate) return false;
  // Explicit true = private; null = inherit from idea; explicit false = not private
  if (date.isPrivate === true) return true;
  if (date.isPrivate === false) return false;
  // null: inherit from linked idea
  const idea = ideas.find(i => (date.ideaId && i.id === date.ideaId) || (i.name && date.venue && i.name.toLowerCase() === date.venue.toLowerCase()));
  return !!(idea && idea.isPrivate);
}
function _isTodoHiddenPrivate(t) {
  if (typeof hidePrivate === 'undefined' || !hidePrivate) return false;
  if (t.isPrivate === true) return true;
  if (t.isPrivate === false) return false;
  // null: inherit from linked idea via dateKey (new format)
  if (t.dateKey) {
    const u = _findDateByKey(t.dateKey);
    if (u) {
      const idea = ideas.find(i => i.name && u.venue && i.name.toLowerCase() === u.venue.toLowerCase());
      if (idea && idea.isPrivate) return true;
    }
    return false;
  }
  // Legacy: activity object {id, name}
  if (t.activity && !t.activity.custom && t.activity.id) {
    const idea = ideas.find(i => i.id === t.activity.id);
    if (idea && idea.isPrivate) return true;
  }
  return false;
}

// ── Date / Todo lock state ───────────────────────────────────────────────────
// null = inherit from linked idea; true/false = explicitly overridden
let _dateIsPrivate = null;
let _edIsPrivate   = null;
let _tsIsPrivate   = null;
let _etIsPrivate   = null;

// Get the effective (display) private state: explicit value wins, else idea's isPrivate
function _effectivePrivate(explicitVal, ideaIsPrivate) {
  if (explicitVal !== null && explicitVal !== undefined) return !!explicitVal;
  return !!ideaIsPrivate;
}

// Get the linked idea's isPrivate for each context
function _dateIdeaIsPrivate() {
  return !!(selectedActivity && !selectedActivity.custom && selectedActivity.isPrivate);
}
function _edIdeaIsPrivate() {
  return !!(edSelectedActivity && !edSelectedActivity.custom && edSelectedActivity.isPrivate);
}


function toggleDatePrivate() {
  if (_dateIsPrivate === null && _dateIdeaIsPrivate()) return; // locked via idea, not changeable
  const effective = _effectivePrivate(_dateIsPrivate, _dateIdeaIsPrivate());
  _dateIsPrivate = !effective;
  if (_dateIsPrivate === _dateIdeaIsPrivate()) _dateIsPrivate = null;
  _renderPrivacyBox('date-lock-icon', 'date-privacy-box', _effectivePrivate(_dateIsPrivate, _dateIdeaIsPrivate()), _dateIsPrivate === null && _dateIdeaIsPrivate());
}
function toggleEdPrivate() {
  if (_edIsPrivate === null && _edIdeaIsPrivate()) return;
  const effective = _effectivePrivate(_edIsPrivate, _edIdeaIsPrivate());
  _edIsPrivate = !effective;
  if (_edIsPrivate === _edIdeaIsPrivate()) _edIsPrivate = null;
  _renderPrivacyBox('ed-lock-icon', 'ed-privacy-box', _effectivePrivate(_edIsPrivate, _edIdeaIsPrivate()), _edIsPrivate === null && _edIdeaIsPrivate());
}
function toggleTsPrivate() {
  if (_tsIsPrivate === null && _tsIdeaIsPrivate()) return;
  const effective = _effectivePrivate(_tsIsPrivate, _tsIdeaIsPrivate());
  _tsIsPrivate = !effective;
  if (_tsIsPrivate === _tsIdeaIsPrivate()) _tsIsPrivate = null;
  _renderPrivacyBox('ts-lock-icon', 'ts-privacy-box', _effectivePrivate(_tsIsPrivate, _tsIdeaIsPrivate()), _tsIsPrivate === null && _tsIdeaIsPrivate());
}
function toggleEtPrivate() {
  if (_etIsPrivate === null && _etIdeaIsPrivate()) return;
  const effective = _effectivePrivate(_etIsPrivate, _etIdeaIsPrivate());
  _etIsPrivate = !effective;
  if (_etIsPrivate === _etIdeaIsPrivate()) _etIsPrivate = null;
  _renderPrivacyBox('et-lock-icon', 'et-privacy-box', _effectivePrivate(_etIsPrivate, _etIdeaIsPrivate()), _etIsPrivate === null && _etIdeaIsPrivate());
}

function _renderPrivacyBox(iconBtnId, boxBtnId, isPrivate, inheritedPrivate) {
  const iconBtn = document.getElementById(iconBtnId);
  const box = document.getElementById(boxBtnId);
  const lockClosed = `<svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`;
  const lockOpen   = `<svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>`;
  if (iconBtn) {
    iconBtn.innerHTML = isPrivate ? lockClosed : lockOpen;
    // inherited private = gray (same as other icons); explicit private = rose; not private = gray
    iconBtn.style.color = isPrivate && !inheritedPrivate ? '#c07a8a' : '#9a8a7a';
    iconBtn.style.cursor = inheritedPrivate ? 'default' : 'pointer';
  }
  if (box) {
    if (inheritedPrivate) {
      // "Private" in normal text color + " (via date idea)" in gray
      box.innerHTML = `<span style="color:var(--text-primary)">Private</span><span style="color:var(--text-placeholder)"> (via date idea)</span>`;
    } else {
      box.textContent = isPrivate ? 'Private' : 'Not private';
      box.style.color = isPrivate ? 'var(--text-primary)' : 'var(--text-placeholder)';
    }
    box.style.cursor = inheritedPrivate ? 'default' : 'pointer';
    box.disabled = !!inheritedPrivate;
  }
}

// ── Tab-home toggle hide locked + toast ─────────────────────────────────────
let _toastTimer = null;
function toggleHideLocked() {
  hidePrivate = !hidePrivate;
  appSettings.hidePrivate = hidePrivate;
  saveSettings(appSettings);
  // Sync settings checkbox if open
  const cb = document.getElementById('settings-hide-private');
  if (cb) cb.checked = hidePrivate;
  // Show toast
  _showLockToast(hidePrivate);
  currentView = 'home';
  render();
}

function _showLockToast(isLocked) {
  let toast = document.getElementById('lock-toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'lock-toast';
    toast.style.cssText = 'position:fixed;bottom:98px;left:50%;transform:translateX(-50%);background:#fff;border-radius:14px;padding:10px 18px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(0,0,0,0.18);z-index:999;transition:opacity 0.3s ease;pointer-events:none';
    document.body.appendChild(toast);
  }
  const lockOpenSvg = '<svg viewBox="0 0 24 24" width="22" height="22" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>';
  const lockClosedSvg = '<svg viewBox="0 0 24 24" width="22" height="22" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>';
  toast.innerHTML = isLocked
    ? '<span style="color:#9a8a7a">' + lockClosedSvg + '</span>'
    : '<span style="color:#c07a8a">' + lockOpenSvg + '</span>';
  toast.style.opacity = '1';
  if (_toastTimer) clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => { toast.style.opacity = '0'; }, 1000);
}

function _isHiddenPrivate(idea) {
  return hidePrivate && idea && idea.isPrivate;
}

function _renderLockBtn(btnId, isPrivate) {
  const btn = document.getElementById(btnId);
  if (!btn) return;
  btn.innerHTML = isPrivate ? `<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>` : `<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>`;
  btn.style.color = isPrivate ? '#c07a8a' : '#9a8a7a';
}

let _ideaIsPrivate = false;
function toggleIdeaPrivate() {
  _ideaIsPrivate = !_ideaIsPrivate;
  _renderLockBtn('idea-lock-btn', _ideaIsPrivate);
}

let _pfIsPrivate = false;
function togglePfPrivate() {
  _pfIsPrivate = !_pfIsPrivate;
  _renderLockBtn('pf-lock-btn', _pfIsPrivate);
}
function _rebuildCatDropdown(type) {
  const elId = type === 'in' ? 'idea-cat-select-in' : 'idea-cat-select';
  const sel = document.getElementById(elId);
  if (!sel) return;
  const cats = type === 'in' ? IN_CATS : OUT_CATS;
  const prev = sel.value;
  sel.innerHTML = `<option value="__edit_cats__" style="color:#9a8a7a;font-style:italic">Edit categories…</option>`
    + cats.map(c => `<option value="${c.id}">${c.label}</option>`).join('');
  // Restore selection if still valid
  if (cats.find(c => c.id === prev)) sel.value = prev;
  else sel.value = cats[0] ? cats[0].id : '';
}

function itemSubLine(item) {
  const cat = (item.category || '').toLowerCase();
  const label = catLabel(item.category || '');
  const showType = item.showType !== false; // default true
  if (cat === 'restaurant' || cat === 'cafe') {
    const base = item.cuisine ? `${item.cuisine} ${label}` : label;
    return item.shortdesc ? `${base} • ${item.shortdesc}` : base;
  }
  if (!showType) return item.shortdesc || '';
  return item.shortdesc ? `${label} • ${item.shortdesc}` : label;
}

function renderQuickRow(item, navCtx) {
  const color = accentColor(item.type);
  const bg = item.type === 'out' ? BURGUNDY_BG : ROSE_BG;
  const _subColor = subColor(item.type);
  const sub = itemSubLine(item);
  const urls = getImageUrls(item);
  const imgPanel = urls.length ? `<div style="width:120px;flex-shrink:0;margin:-12px -14px -12px 0;border-left:1px solid var(--img-sep);border-radius:0 14px 14px 0;overflow:hidden;align-self:stretch;background:#6b2340;position:relative"><img src="${urls[0]}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;display:block" onerror="this.parentNode.style.background='#6b2340';this.style.display='none'"></div>` : '';
  return `
  <div class="quick-row" onclick="openDetail(${item.id},'${navCtx||'latest'}' )" style="cursor:pointer;overflow:hidden">
    <div style="flex:1;min-width:0">
      <div style="display:flex;align-items:center;gap:7px;margin-bottom:${sub?'4px':'0'}">
        ${ideaIcon(item, 14, color)}
        <div class="quick-row-name">${item.name}</div>
      </div>
      ${sub ? `<div class="quick-row-sub" style="color:${_subColor}">${sub}</div>` : ''}
    </div>
    ${imgPanel}
  </div>`;
}

// ── Catalog now handled inside renderIdeas ──────────
function renderCatalog(type) { return renderIdeas(); }

// ── Memories ────────────────────────────────────────
let _editingMemory = null;

function renderPastDates() {
  const memories = _computeMemories();
  const BROWN = '#9a8a7a';
  if (memories.length === 0) {
    return `<div style="padding:60px 20px;text-align:center;color:#b0a090;font-size:15px;font-style:italic">No memories yet.</div>`;
  }
  const rows = memories.map(d => {
    const sub = d.note
      ? d.note
      : (d.time && (_dateLocationLabel(d) || d.neighborhood) ? d.time + ' · ' + (_dateLocationLabel(d) || d.neighborhood) : d.time || _dateLocationLabel(d) || d.neighborhood || d.label || '');
    const safeId = String(d.id).replace(/'/g,"\\'");
    const imgUrls = _getMemoryImageUrls(d);
    const hasImg = imgUrls.length > 0;

    const cardContent = `
      <div class="upcoming-date-badge">
        <span class="upcoming-month" style="color:${BROWN}">${d.month}</span>
        <span class="upcoming-day-num" style="color:${BROWN}">${d.day}</span>
      </div>
      <div class="upcoming-divider"></div>
      <div class="upcoming-info">
        <div class="upcoming-venue-row">
          ${activityIcon(d.activity, 14, BROWN)}
          <span class="upcoming-venue" style="color:${BROWN}">${d.venue}</span>
        </div>
        <span class="upcoming-sub">${sub}</span>
      </div>`;

    if (hasImg) {
      return `<div onclick="openMemoryInfo('${safeId}')" style="background:var(--bg-card);border-radius:14px;border:1px solid var(--border);margin-bottom:8px;overflow:hidden;cursor:pointer">
        <div style="height:120px;overflow:hidden;background:#6b2340;position:relative">
          <img src="${imgUrls[0]}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;display:block" onerror="this.parentNode.style.background='#6b2340';this.style.display='none'">
        </div>
        <div class="upcoming-item" style="border:none;border-radius:0;margin-bottom:0">${cardContent}</div>
      </div>`;
    }
    return `<div class="upcoming-item" onclick="openMemoryInfo('${safeId}')">${cardContent}</div>`;
  }).join('');

  return `<div style="padding:20px 20px 80px">${rows}</div>`;
}

function openMemoryEdit(id) {
  const memories = _computeMemories();
  const d = memories.find(m => String(m.id) === String(id));
  if (!d) return;
  _editingMemory = d;
  edSelectedActivity = null;
  populateEditDateFields(d);
  // Disable nav arrows — memories don't chain-navigate like upcoming dates
  const prev = document.getElementById('ed-prev-btn');
  const next = document.getElementById('ed-next-btn');
  if (prev) { prev.style.opacity = '0.3'; prev.disabled = true; }
  if (next) { next.style.opacity = '0.3'; next.disabled = true; }
  document.getElementById('edit-date-overlay').style.display = 'flex';
}

function openMemoryInfo(id) {
  const memories = _computeMemories();
  const d = memories.find(m => String(m.id) === String(id));
  if (!d) return;
  _currentMemoryInfoId = String(id);
  const u = {
    venue: d.venue || d.name || '',
    day: d.day,
    month: d.month,
    year: d.year,
    time: d.time || '',
    label: d.label || '',
    neighborhood: d.neighborhood || '',
    address: d.address || d.neighborhood || '',
    subwayRoute: d.subwayRoute || '',
    walkDriveTime: d.walkDriveTime || '',
    about: d.note || '',
    activity: d.activity || '',
    _memoryImageUrls: _getMemoryImageUrls(d)
  };
  openDateInfo(u, true /* memoryMode */);
}

let _currentMemoryInfoId = null;

// ── Calendar ──────────────────────────────────────────
function renderCalendar() {
  const monthName = new Date(currentCalYear, currentCalMonth, 1).toLocaleString('default',{month:'long'});
  const daysInMonth = new Date(currentCalYear, currentCalMonth+1, 0).getDate();
  const firstDow = new Date(currentCalYear, currentCalMonth, 1).getDay();
  const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  // Real today
  const _now = new Date(); _now.setHours(0,0,0,0);
  const todayDay   = (_now.getFullYear()===currentCalYear && _now.getMonth()===currentCalMonth) ? _now.getDate() : null;
  const monthAbbr  = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][currentCalMonth];

  // Days in current month that have upcoming dates
  const datesThisMonth = UPCOMING_DATES.filter(u => u.month === monthAbbr && (u.year || 2026) === currentCalYear);
  const markedDays = datesThisMonth.map(u => u.day);

  // Days that are in the past (before today in this month)
  const isPastMonth = (currentCalYear < _now.getFullYear()) || (currentCalYear === _now.getFullYear() && currentCalMonth < _now.getMonth());
  const isFutureMonth = (currentCalYear > _now.getFullYear()) || (currentCalYear === _now.getFullYear() && currentCalMonth > _now.getMonth());

  let cells = '';
  for (let i=0;i<firstDow;i++) cells += '<div></div>';
  for (let d=1;d<=daysInMonth;d++) {
    const isSelected = d === selectedCalDay;
    const isMarked   = markedDays.includes(d);
    const isToday    = d === todayDay;
    const dayDate    = new Date(currentCalYear, currentCalMonth, d); dayDate.setHours(0,0,0,0);
    const isPastDay  = dayDate < _now;
    const cls = isSelected ? 'cal-day selected' : isToday ? 'cal-day today' : 'cal-day';
    const dotClass = isSelected ? 'cal-dot selected' : isPastDay ? 'cal-dot past' : 'cal-dot';
    cells += `
      <button class="${cls}" onclick="selectCalDay(${d})">
        ${d}
        ${isMarked ? `<div class="${dotClass}"></div>` : ''}
      </button>`;
  }

  // Selected date detail card
  const selDate = UPCOMING_DATES.find(u => u.month === monthAbbr && (u.year||2026) === currentCalYear && u.day === selectedCalDay);
  let selectedCardHTML = '';
  if (selDate) {
    const selDateObj = new Date(currentCalYear, currentCalMonth, selectedCalDay); selDateObj.setHours(0,0,0,0);
    const isPastSel = selDateObj < _now;
    const cardColor = isPastSel ? '#9a8a7a' : ROSE;
    const cardShadow = isPastSel ? '0 2px 12px rgba(154,138,122,0.3)' : '0 2px 12px rgba(192,122,138,0.3)';
    selectedCardHTML = `
      <div onclick="openDateInfo(UPCOMING_DATES.find(u=>u.month==='${monthAbbr}'&&(u.year||2026)===${currentCalYear}&&u.day===${selDate.day}))" style="display:flex;align-items:center;gap:14px;padding:12px 14px;min-height:64px;box-sizing:border-box;background:${cardColor};border-radius:14px;box-shadow:${cardShadow};margin-top:20px;cursor:pointer">
        <div style="width:40px;flex-shrink:0;display:flex;flex-direction:column;align-items:center">
          <span style="font-size:10px;font-family:sans-serif;font-weight:600;color:rgba(255,255,255,0.7);letter-spacing:0.06em;text-transform:uppercase">${selDate.month}</span>
          <span style="font-size:22px;font-weight:700;color:#fff;line-height:1.1">${selDate.day}</span>
        </div>
        <div style="width:1px;height:36px;background:rgba(255,255,255,0.25);flex-shrink:0"></div>
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:7px;margin-bottom:2px">
            ${activityIcon(selDate.activity,14,'#fff')}
            <span style="font-size:15px;font-weight:700;color:#fff;letter-spacing:-0.01em">${selDate.venue}</span>
          </div>
          <span style="font-size:12px;color:rgba(255,255,255,0.65);font-family:sans-serif">${selDate.time}${(_dateLocationLabel(selDate) || selDate.neighborhood) ? ' · ' + (_dateLocationLabel(selDate) || selDate.neighborhood) : ''}</span>
        </div>
        ${ICONS.chevRight(15,'rgba(255,255,255,0.7)')}
      </div>`;
  } else if (selectedCalDay) {
    const _selObj = new Date(currentCalYear, currentCalMonth, selectedCalDay); _selObj.setHours(0,0,0,0);
    const _tomorrow = new Date(_now); _tomorrow.setDate(_now.getDate() + 1);
    // End of today's week (Sunday) — week ends on Sunday, next week starts Monday
    const _endOfWeek = new Date(_now); _endOfWeek.setDate(_now.getDate() + (7 - _now.getDay()) % 7 || 7);
    const _DAY_NAMES = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const _noDateLabel = _selObj.getTime() === _now.getTime() ? 'today'
      : _selObj.getTime() === _tomorrow.getTime() ? 'tomorrow'
      : (_selObj > _tomorrow && _selObj <= _endOfWeek) ? _DAY_NAMES[_selObj.getDay()]
      : _calDayLabel(selectedCalDay, currentCalMonth, currentCalYear);
    selectedCardHTML = `
      <div style="margin-top:20px;min-height:64px;box-sizing:border-box;padding:12px 16px;border-radius:14px;display:flex;align-items:center;justify-content:center;color:#b0a090;font-size:14px;font-style:italic">
        No date ${_noDateLabel} · <span style="color:${ROSE};cursor:pointer" onclick="openNewDateFromCal(${selectedCalDay}, currentCalMonth, currentCalYear)">&nbsp;Plan one ›</span>
      </div>`;
  }

  // Upcoming list
  const upcomingHTML = UPCOMING_DATES
    .filter(u => {
      const dt = new Date((u.year||2026), MONTH_NUMS[u.month]||0, u.day); dt.setHours(0,0,0,0);
      return dt >= _now;
    })
    .filter(u => !_isDateHiddenPrivate(u))
    .sort((a,b) => new Date((a.year||2026),MONTH_NUMS[a.month]||0,a.day) - new Date((b.year||2026),MONTH_NUMS[b.month]||0,b.day))
    .map(u => {
      const isSelected = u.month === monthAbbr && (u.year||2026) === currentCalYear && u.day === selectedCalDay;
      const style = isSelected ? `border-color:${ROSE};` : '';
      return `
      <div class="upcoming-item" onclick="openDateInfo(UPCOMING_DATES.find(u=>u.month==='${u.month}'&&(u.year||2026)===${u.year||2026}&&u.day===${u.day}))" style="${style}">
        <div class="upcoming-date-badge">
          <span class="upcoming-month">${u.month}</span>
          <span class="upcoming-day-num">${u.day}</span>
        </div>
        <div class="upcoming-divider"></div>
        <div class="upcoming-info">
          <div class="upcoming-venue-row">
            ${activityIcon(u.activity,14,ROSE)}
            <span class="upcoming-venue">${u.venue}</span>
          </div>
          <span class="upcoming-sub">${u.time ? u.time + ((_dateLocationLabel(u) || u.neighborhood) ? ' · ' + (_dateLocationLabel(u) || u.neighborhood) : '') : (_dateLocationLabel(u) || u.neighborhood || '')}</span>
        </div>
      </div>`;
    }).join('');

  return `
  <div id="cal-wrap">
    <div id="cal-card">
      <div id="cal-header">
        <button class="cal-nav-btn" onclick="calPrev()">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="#b0a090" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <span id="cal-month-label">${monthName}</span>
        <button class="cal-nav-btn" onclick="calNext()">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="#b0a090" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </button>
      </div>
      <div id="cal-dow">${DOW.map(d=>`<div class="cal-dow-cell">${d}</div>`).join('')}</div>
      <div id="cal-grid">${cells}</div>
    </div>
    ${selectedCardHTML}
    <div id="cal-upcoming">
      <div class="section-label" style="margin-bottom:12px">Upcoming</div>
      ${upcomingHTML}
    </div>
    ${(() => {
      const past3 = _computeMemories().slice(0, 3);
      if (past3.length === 0) return '';
      const BROWN = '#9a8a7a';
      const rows = past3.map(d => {
        const sub = d.note
          ? d.note
          : (d.time && (_dateLocationLabel(d) || d.neighborhood) ? d.time + ' · ' + (_dateLocationLabel(d) || d.neighborhood) : d.time || _dateLocationLabel(d) || d.neighborhood || d.label || '');
        return `<div class="upcoming-item" onclick="openMemoryInfo('${String(d.id).replace(/'/g,"\\'")}')">
          <div class="upcoming-date-badge">
            <span class="upcoming-month" style="color:${BROWN}">${d.month}</span>
            <span class="upcoming-day-num" style="color:${BROWN}">${d.day}</span>
          </div>
          <div class="upcoming-divider"></div>
          <div class="upcoming-info">
            <div class="upcoming-venue-row">
              ${activityIcon(d.activity, 14, BROWN)}
              <span class="upcoming-venue" style="color:${BROWN}">${d.venue}</span>
            </div>
            <span class="upcoming-sub">${sub}</span>
          </div>
        </div>`;
      }).join('');
      return `<div id="cal-past" style="margin-top:28px">
        <button onclick="navigate('past')" style="background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;gap:4px;margin-bottom:12px">
          <span class="section-label">Past Dates</span>
          <span style="font-size:11px;color:#9a8a7a;font-family:sans-serif;letter-spacing:0.1em;line-height:1">›</span>
        </button>
        ${rows}
      </div>`;
    })()}
  </div>`;
}

// ── Calendar nav ──────────────────────────────────────
function calPrev() {
  if (currentCalMonth === 0) { currentCalMonth=11; currentCalYear--; }
  else currentCalMonth--;
  selectedCalDay = null;
  render();
}
function calNext() {
  if (currentCalMonth === 11) { currentCalMonth=0; currentCalYear++; }
  else currentCalMonth++;
  selectedCalDay = null;
  render();
}
function _calDayLabel(day, month, year) {
  // month is 0-indexed (0=Jan, 1=Feb...)
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${months[month] || ''} ${day}`;
}

function openNewDateFromCal(day, month, year) {
  // Build YYYY-MM-DD for the date input
  const yyyy = year;
  const mm = String(month + 1).padStart(2, '0');
  const dd = String(day).padStart(2, '0');
  const dateStr = `${yyyy}-${mm}-${dd}`;
  openSheet('date');
  // Pre-fill the date field after sheet opens
  setTimeout(() => {
    const dateInput = document.getElementById('date-day');
    if (dateInput) dateInput.value = dateStr;
    const textEl = document.getElementById('date-day-text');
    if (textEl) textEl.value = `${mm}/${dd}/${String(yyyy).slice(-2)}`;
    _buildPickerStrip('date');
    _initPickerStrip('date');
  }, 50);
}

function selectCalDay(day) {
  selectedCalDay = day;
  render();
}

// ── Short time formatter (9:00 pm → 9 pm, 9:30 pm → 9:30 pm) ──
function _shortTime(t) {
  if (!t) return t;
  return t.replace(/^(\d+):00\s*(am|pm)$/i, '$1 $2');
}

// ── Next date bubble commute helper ──────────────────
function _nextDateCommuteHtml(date, cardColor) {
  // Skip commute for "My place" In dates
  if (date.inLocation === 'my_place') return null;
  // Also skip for In ideas with no inLocation set (default is My place)
  const idea = ideas.find(i => i.name === date.venue);
  if (idea && idea.type === 'in' && !date.inLocation) return null;

  const subway = idea && idea.subwayRoute ? idea.subwayRoute.trim() : '';
  const walkdrive = idea && idea.walkDriveTime ? idea.walkDriveTime.trim() : '';

  let commuteMin = null;
  let commuteHtml = '';
  const textColor = cardColor || ROSE; // text inside circles matches card bg

  if (subway) {
    const timeMatch = subway.match(/~?\s*(\d+)\s*min/i);
    if (timeMatch) commuteMin = parseInt(timeMatch[1]);
    const toIdx = subway.toLowerCase().indexOf(' to ');
    const linesPart = toIdx >= 0 ? subway.substring(0, toIdx) : subway;
    const lines = [...new Set((linesPart.match(/\b[1-7ACEGJLNQRSWBDFMZ]\b/gi)||[]).map(l=>l.toUpperCase()))];
    const buses = [...new Set((linesPart.match(/\b[BMQ]\d+\b/gi)||[]).map(b=>b.toUpperCase()))];
    let badgesHtml = '';
    lines.forEach((line, i) => {
      if (i > 0) badgesHtml += `<span style="color:rgba(255,255,255,0.5);font-size:10px">›</span>`;
      badgesHtml += `<div style="width:14px;height:14px;border-radius:50%;background:rgba(255,255,255,0.7);position:relative;flex-shrink:0;display:inline-block"><span style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:${textColor};font-size:8px;font-weight:700;font-family:sans-serif;line-height:1;letter-spacing:0;white-space:nowrap">${line}</span></div>`;
    });
    buses.forEach((bus, i) => {
      if (lines.length || i > 0) badgesHtml += `<span style="color:rgba(255,255,255,0.5);font-size:10px">›</span>`;
      badgesHtml += `<div style="padding:1px 4px;border-radius:3px;background:rgba(255,255,255,0.7);color:${textColor};font-size:9px;font-weight:700;font-family:sans-serif">${bus}</div>`;
    });
    if (badgesHtml) commuteHtml = badgesHtml;
  } else if (walkdrive) {
    const walkMatch = walkdrive.match(/(\d+)\s*min\s*walk/i);
    const driveMatch = walkdrive.match(/(\d+)\s*min\s*drive/i);
    if (walkMatch || driveMatch) {
      if (walkMatch) commuteMin = parseInt(walkMatch[1]);
      else if (driveMatch) commuteMin = parseInt(driveMatch[1]);
      const personSvg = `<svg viewBox="0 0 24 24" width="11" height="11" fill="rgba(255,255,255,0.75)"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/></svg>`;
      const carSvg = `<svg viewBox="0 0 24 24" width="11" height="11" fill="rgba(255,255,255,0.75)"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>`;
      let wdHtml = '';
      if (walkMatch) wdHtml += `<span style="display:flex;align-items:center;gap:2px;color:rgba(255,255,255,0.75);font-size:11px;font-family:sans-serif">${personSvg}${walkMatch[1]} min</span>`;
      if (walkMatch && driveMatch) wdHtml += `<span style="color:rgba(255,255,255,0.4);font-size:11px">/</span>`;
      if (driveMatch) wdHtml += `<span style="display:flex;align-items:center;gap:2px;color:rgba(255,255,255,0.75);font-size:11px;font-family:sans-serif">${carSvg}${driveMatch[1]} min</span>`;
      commuteHtml = wdHtml;
    }
  }

  if (!commuteHtml) return null;

  // Determine travel mode and destination for Maps link
  const dest = idea && idea.address ? idea.address.trim() : (date.venue || '');
  let travelMode = 'transit'; // default for subway
  if (!subway && walkdrive) {
    const walkMatch2 = walkdrive.match(/(\d+)\s*min\s*walk/i);
    const driveMatch2 = walkdrive.match(/(\d+)\s*min\s*drive/i);
    travelMode = walkMatch2 ? 'walking' : 'driving';
  }
  const mapsOnclick = (homeAddress && dest)
    ? `event.stopPropagation();_openExternal('https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(homeAddress)}&destination=${encodeURIComponent(dest)}&travelmode=${travelMode}')`
    : '';
  const mapsCursor = mapsOnclick ? 'cursor:pointer' : '';

  // Compute "Leave by" time
  let leaveByHtml = '';
  if (commuteMin && date.time) {
    const parsed = parseTimeInput(date.time);
    const m = parsed.match(/(\d+):(\d+)\s*(am|pm)/i);
    if (m) {
      let h = parseInt(m[1]), mn = parseInt(m[2]);
      const isPm = m[3].toLowerCase() === 'pm';
      if (isPm && h !== 12) h += 12;
      if (!isPm && h === 12) h = 0;
      const totalMin = h * 60 + mn - commuteMin - 10; // extra 10 min buffer
      const lh = Math.floor(((totalMin % 1440) + 1440) % 1440 / 60);
      const lm = ((totalMin % 1440) + 1440) % 1440 % 60;
      const suf = lh >= 12 ? 'pm' : 'am';
      const lh12 = lh === 0 ? 12 : lh > 12 ? lh - 12 : lh;
      const leaveTimeStr = lm === 0 ? `${lh12} ${suf}` : `${lh12}:${String(lm).padStart(2,'0')} ${suf}`;
      leaveByHtml = `<span style="color:rgba(255,255,255,0.55);font-size:11px;font-family:sans-serif">Leave by ${leaveTimeStr}</span>`;
    }
  }

  return `<div style="display:flex;align-items:center;gap:5px;flex-wrap:wrap;margin-top:4px;${mapsCursor}" ${mapsOnclick ? `onclick="${mapsOnclick}"` : ''}>${commuteHtml}${leaveByHtml ? '<span style="color:rgba(255,255,255,0.3);font-size:11px;margin:0 1px">·</span>' + leaveByHtml : ''}</div>`;
}

// ── Date bubble nav ───────────────────────────────────
function prevDate() { if(dateIdx>0){dateIdx--;_scrollDateCards(true);} }
function nextDate() { if(dateIdx<FUTURE_DATES.length-1){dateIdx++;_scrollDateCards(true);} }

function _updateDateCardsUI() {
  const canPrev = dateIdx > 0;
  const canNext = dateIdx < FUTURE_DATES.length - 1;
  const prev = document.getElementById('date-btn-prev');
  const next = document.getElementById('date-btn-next');
  if (prev) prev.style.opacity = canPrev ? '1' : '0.3';
  if (next) next.style.opacity = canNext ? '1' : '0.3';
}

function _scrollDateCards(animate) {
  const scroll = document.getElementById('date-cards-scroll');
  if (!scroll) return;
  const w = scroll.offsetWidth;
  if (!w) return;
  if (animate) {
    // Smooth animated scroll
    scroll.style.scrollSnapType = 'none';
    const start = scroll.scrollLeft;
    const end = dateIdx * w;
    const duration = 200; // ms
    const startTime = performance.now();
    const ease = t => t < 0.5 ? 2*t*t : -1+(4-2*t)*t;
    function step(now) {
      const t = Math.min((now - startTime) / duration, 1);
      scroll.scrollLeft = start + (end - start) * ease(t);
      if (t < 1) requestAnimationFrame(step);
      else {
        scroll.scrollLeft = end;
        requestAnimationFrame(() => { scroll.style.scrollSnapType = 'x mandatory'; });
        // Animate week strip to correct page
        const ws = document.getElementById('week-strip');
        if (ws) { _weekStripAnimate = true; ws.outerHTML = renderWeekStrip(); setTimeout(_initWeekStrip, 0); }
      }
    }
    requestAnimationFrame(step);
  } else {
    scroll.style.visibility = 'hidden';
    scroll.style.scrollSnapType = 'none';
    scroll.scrollLeft = dateIdx * w;
    requestAnimationFrame(() => {
      scroll.scrollLeft = dateIdx * w;
      scroll.style.scrollSnapType = 'x mandatory';
      scroll.style.visibility = '';
    });
  }
  _updateDateCardsUI();
}

function _initDateCardsScroll() {
  const outer = document.getElementById('date-cards-outer');
  const scroll = document.getElementById('date-cards-scroll');
  if (!scroll || !outer) return;
  const w = outer.offsetWidth;
  if (!w) return;
  // Set each slide to outer container width
  scroll.querySelectorAll('.date-card-slide').forEach(s => { s.style.width = w + 'px'; });
  // Scroll to current dateIdx without animation — hide during reposition to prevent flash
  scroll.style.visibility = 'hidden';
  scroll.style.scrollSnapType = 'none';
  scroll.scrollLeft = dateIdx * w;
  requestAnimationFrame(() => {
    scroll.scrollLeft = dateIdx * w; // set again in case browser reset it
    scroll.style.scrollSnapType = 'x mandatory';
    scroll.style.visibility = '';
  });
  _updateDateCardsUI();
  // Listen for swipe to update dateIdx + week strip
  if (scroll._dateScrollHandler) scroll.removeEventListener('scroll', scroll._dateScrollHandler);
  let _scrollEndTimer = null;
  scroll._dateScrollHandler = () => {
    clearTimeout(_scrollEndTimer);
    _scrollEndTimer = setTimeout(() => {
      const newIdx = Math.round(scroll.scrollLeft / w);
      if (newIdx !== dateIdx && newIdx >= 0 && newIdx < FUTURE_DATES.length) {
        dateIdx = newIdx;
        _updateDateCardsUI();
        // Re-render week strip in place without full page re-render
        const ws = document.getElementById('week-strip');
        if (ws) {
          _weekStripAnimate = true;
          ws.outerHTML = renderWeekStrip();
          setTimeout(_initWeekStrip, 0);
        }
      }
    }, 80);
  };
  scroll.addEventListener('scroll', scroll._dateScrollHandler, { passive: true });
}

function _initCalSwipe() {
  const card = document.getElementById('cal-card');
  if (!card) return;
  let startX = 0, startY = 0, dragging = false, fired = false;

  function onStart(x, y) {
    startX = x; startY = y; dragging = true; fired = false;
  }
  function onMove(x) {
    if (!dragging || fired) return;
    const dx = x - startX;
    if (Math.abs(dx) > 30) {
      fired = true; dragging = false;
      dx < 0 ? calNext() : calPrev();
    }
  }
  function onEnd() { dragging = false; }

  // Touch
  card.addEventListener('touchstart', e => {
    onStart(e.touches[0].clientX, e.touches[0].clientY);
  }, { passive: true });
  card.addEventListener('touchmove', e => {
    onMove(e.touches[0].clientX);
  }, { passive: true });
  card.addEventListener('touchend', onEnd, { passive: true });

  // Mouse (desktop drag)
  card.addEventListener('mousedown', e => { onStart(e.clientX, e.clientY); });
  card.addEventListener('mousemove', e => { if (dragging) onMove(e.clientX); });
  card.addEventListener('mouseup', onEnd);
  card.addEventListener('mouseleave', onEnd);
}

// ── Week strip interactions ────────────────────────────
let _weekTooltipDay = 0, _weekTooltipMonth = 0, _weekTooltipYear = 0;
let _weekTooltipOpenKey = null; // tracks which day tooltip is open for

let _weekStripAnimate = false; // set true before re-render to animate the page transition
function _initWeekStrip() {
  const scroll = document.getElementById('week-strip-scroll');
  if (!scroll) return;
  const pages = scroll.querySelectorAll('.week-page');
  if (!pages.length) return;
  const w = scroll.offsetWidth;
  pages.forEach(p => { p.style.width = w + 'px'; });
  const page = parseInt(scroll.getAttribute('data-init-page') || '0');
  scroll.style.scrollSnapType = 'none';
  scroll.style.scrollBehavior = 'auto';
  if (_weekStripAnimate && page > 0) {
    // Start from page 0 (where the re-rendered strip begins) and animate to target page
    scroll.scrollLeft = 0;
    _weekStripAnimate = false;
    requestAnimationFrame(() => {
      const start = 0;
      const end = page * w;
      const duration = 300;
      const startTime = performance.now();
      const ease = t => t < 0.5 ? 2*t*t : -1+(4-2*t)*t;
      function step(now) {
        const t = Math.min((now - startTime) / duration, 1);
        scroll.scrollLeft = start + (end - start) * ease(t);
        if (t < 1) requestAnimationFrame(step);
        else {
          scroll.scrollLeft = end;
          requestAnimationFrame(() => { scroll.style.scrollSnapType = 'x mandatory'; });
        }
      }
      requestAnimationFrame(step);
    });
  } else {
    _weekStripAnimate = false;
    scroll.scrollLeft = page * w;
    requestAnimationFrame(() => { scroll.style.scrollSnapType = 'x mandatory'; });
  }
  scroll.addEventListener('scroll', closeWeekTooltip, { passive: true });
}

function selectWeekDate(idx) {
  closeWeekTooltip();
  if (idx < 0 || idx >= FUTURE_DATES.length) return;
  dateIdx = idx;
  const main = document.getElementById('main-content');
  if (main) {
    main.innerHTML = renderHome();
    setTimeout(() => { _initDateCardsScroll(); _initWeekStrip(); }, 0);
  }
}

function showWeekTooltip(e, day, month, year) {
  e.stopPropagation();
  const tt = document.getElementById('week-tooltip');
  if (!tt) return;

  const key = `${year}-${month}-${day}`;

  // Toggle: if this tooltip is already open for the same cell, close it
  if (_weekTooltipOpenKey === key && tt.style.display === 'block') {
    closeWeekTooltip();
    return;
  }

  _weekTooltipDay = day;
  _weekTooltipMonth = month;
  _weekTooltipYear = year;
  _weekTooltipOpenKey = key;

  // Position tooltip BELOW the clicked cell (15px closer to cell), caret points UP
  const strip = document.getElementById('week-strip');
  const cell = e.currentTarget;
  if (!strip || !cell) return;

  tt.style.display = 'block';

  const stripRect = strip.getBoundingClientRect();
  const cellRect = cell.getBoundingClientRect();

  const cellCenterX = cellRect.left - stripRect.left + cellRect.width / 2;
  const cellBottom = cellRect.bottom - stripRect.top;

  const ttW = tt.offsetWidth || 120;
  let left = cellCenterX - ttW / 2;
  // Clamp within strip
  if (left < 4) left = 4;
  if (left + ttW > stripRect.width - 4) left = stripRect.width - ttW - 4;
  tt.style.left = left + 'px';
  tt.style.top = (cellBottom + 6 - 15) + 'px';

  // Point caret at cell center
  const caretOffset = cellCenterX - left;
  tt.style.setProperty('--caret-left', caretOffset + 'px');

  // Dismiss on outside click
  setTimeout(() => {
    document.addEventListener('click', closeWeekTooltip, { once: true });
  }, 0);
}

function closeWeekTooltip() {
  _weekTooltipOpenKey = null;
  const tt = document.getElementById('week-tooltip');
  if (tt) tt.style.display = 'none';
}

// ══════════════════════════════════════════════════════
// POPUP DATE PICKER CAROUSEL  (New Date + Edit Date)
// ══════════════════════════════════════════════════════
let _pickerTooltipKey = { date: null, ed: null };

function _pickerYMD(prefix) {
  // Returns {y,m,d} from the hidden field, or null
  const val = (document.getElementById(prefix + '-day') || {}).value || '';
  if (!val) return null;
  const parts = val.split('-').map(Number);
  if (parts.length !== 3) return null;
  return { y: parts[0], m: parts[1] - 1, d: parts[2] };
}

function _buildPickerStrip(prefix) {
  const today = new Date(); today.setHours(0,0,0,0);
  const DAY_LABELS = ['S','M','T','W','T','F','S'];

  // Map UPCOMING_DATES timestamps → date object (for rose dots + tooltip)
  const scheduledMap = {}; // ts → UPCOMING_DATES entry
  UPCOMING_DATES.forEach(u => {
    const mNum = MONTH_NUMS[u.month];
    if (mNum === undefined) return;
    const dt = new Date(u.year || today.getFullYear(), mNum, u.day);
    dt.setHours(0,0,0,0);
    scheduledMap[dt.getTime()] = u;
  });

  // Currently selected date ts
  const sel = _pickerYMD(prefix);
  const selectedTs = sel ? new Date(sel.y, sel.m, sel.d).setHours(0,0,0,0) : null;

  // Sunday of today's week
  const sunday = new Date(today);
  sunday.setDate(today.getDate() - today.getDay());

  // 4 weeks
  const weeks = [];
  for (let w = 0; w < 4; w++) {
    const week = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(sunday);
      d.setDate(sunday.getDate() + w * 7 + i);
      const ts = d.getTime();
      week.push({ d, ts, label: DAY_LABELS[i], num: d.getDate(),
        isToday: ts === today.getTime(),
        isSelected: ts === selectedTs,
        scheduled: scheduledMap[ts] || null });
    }
    weeks.push(week);
  }

  // Which page to start on (page containing selected, or 0)
  let initPage = 0;
  weeks.forEach((week, wi) => { if (week.some(d => d.isSelected)) initPage = wi; });

  const pagesHtml = weeks.map(week => {
    const daysHtml = week.map(day => {
      const isSelected = day.isSelected;
      const dotColor = day.scheduled ? ROSE : 'transparent';
      const _isDark2 = document.body.classList.contains('dark-mode');
      const numColor = isSelected ? '#fff' : day.isToday ? ROSE : (_isDark2 ? '#f0ede9' : '#2a1f1f');
      const numWeight = (isSelected || day.isToday) ? 700 : 400;
      const labelColor = day.isToday ? ROSE : '#b0a090';
      const bgColor = isSelected ? ROSE : day.isToday ? 'rgba(192,122,138,0.15)' : 'transparent';
      const y = day.d.getFullYear(), m = day.d.getMonth(), dn = day.d.getDate();
      const onclick = day.scheduled
        ? `pickerClickScheduled('${prefix}',event,${y},${m},${dn})`
        : `pickerClickEmpty('${prefix}',${y},${m},${dn})`;
      return `<div class="week-day" onclick="${onclick}">
        <span class="week-day-label" style="color:${labelColor};font-weight:${numWeight}">${day.label}</span>
        <div class="week-day-num-wrap" style="background:${bgColor}">
          <span class="week-day-num" style="color:${numColor};font-weight:${numWeight}">${day.num}</span>
        </div>
        <div class="week-day-dot" style="background:${dotColor}"></div>
      </div>`;
    }).join('');
    return `<div class="week-page">${daysHtml}</div>`;
  }).join('');

  const inner = document.getElementById(prefix + '-picker-inner');
  if (inner) inner.innerHTML = pagesHtml;

  const scroll = document.getElementById(prefix + '-picker-scroll');
  if (scroll) scroll.setAttribute('data-init-page', initPage);
}

function _initPickerStrip(prefix, targetPage) {
  const scroll = document.getElementById(prefix + '-picker-scroll');
  if (!scroll) return;
  const pages = scroll.querySelectorAll('.week-page');
  if (!pages.length) return;
  const w = scroll.offsetWidth;
  if (!w) return;
  pages.forEach(p => { p.style.width = w + 'px'; });
  const page = targetPage !== undefined ? targetPage : parseInt(scroll.getAttribute('data-init-page') || '0');

  // Temporarily disable snap, set position, re-enable — prevents iOS half-page glitch
  scroll.style.scrollSnapType = 'none';
  scroll.scrollLeft = page * w;
  requestAnimationFrame(() => {
    scroll.style.scrollSnapType = 'x mandatory';
  });

  // Attach scroll listener only once
  if (!scroll._pickerScrollHandler) {
    scroll._pickerScrollHandler = () => _closePickerTooltip(prefix);
    scroll.addEventListener('scroll', scroll._pickerScrollHandler, { passive: true });
  }
}

function _pickerSetDay(prefix, yyyy, mm, dd) {
  // mm is 0-based
  const pad = n => String(n).padStart(2,'0');
  const hiddenVal = `${yyyy}-${pad(mm+1)}-${pad(dd)}`;
  const displayVal = `${pad(mm+1)}/${pad(dd)}/${String(yyyy).slice(-2)}`;
  const hidden = document.getElementById(prefix + '-day');
  const text = document.getElementById(prefix + '-day-text');
  if (hidden) hidden.value = hiddenVal;
  if (text) text.value = displayVal;

  // Update selected circle visually WITHOUT touching scroll position.
  // Walk all day cells and update bgColor/numColor based on new selection.
  const scroll = document.getElementById(prefix + '-picker-scroll');
  if (!scroll) return;
  const selTs = new Date(yyyy, mm, dd).setHours(0,0,0,0);
  const today = new Date(); today.setHours(0,0,0,0);
  const todayTs = today.getTime();

  scroll.querySelectorAll('.week-day').forEach(cell => {
    const onclick = cell.getAttribute('onclick') || '';
    // Extract y,m,d from onclick="pickerClickScheduled('prefix',event,y,m,d)" or pickerClickEmpty
    const coordMatch = onclick.match(/,(\d+),(\d+),(\d+)\)$/);
    if (!coordMatch) return;
    const cy = parseInt(coordMatch[1]), cm = parseInt(coordMatch[2]), cd = parseInt(coordMatch[3]);
    const cellTs = new Date(cy, cm, cd).setHours(0,0,0,0);
    const isSelected = cellTs === selTs;
    const isToday = cellTs === todayTs;
    const numWrap = cell.querySelector('.week-day-num-wrap');
    const numSpan = cell.querySelector('.week-day-num');
    const labelSpan = cell.querySelector('.week-day-label');
    if (numWrap) numWrap.style.background = isSelected ? ROSE : isToday ? 'rgba(192,122,138,0.15)' : 'transparent';
    if (numSpan) {
      const _dm = document.body.classList.contains('dark-mode');
      numSpan.style.color = isSelected ? '#fff' : isToday ? ROSE : (_dm ? '#f0ede9' : '#2a1f1f');
      numSpan.style.fontWeight = (isSelected || isToday) ? '700' : '400';
    }
    if (labelSpan) labelSpan.style.fontWeight = (isSelected || isToday) ? '700' : '400';
  });
}

function pickerClickEmpty(prefix, y, m, d) {
  _closePickerTooltip(prefix);
  _pickerSetDay(prefix, y, m, d);
}

function pickerClickScheduled(prefix, e, y, m, d) {
  e.stopPropagation();
  e.preventDefault();

  const key = `${y}-${m}-${d}`;
  const tt = document.getElementById(prefix + '-picker-tooltip');

  // Capture geometry BEFORE _pickerSetDay re-renders the strip
  const wrap = document.getElementById(prefix + '-picker-wrap');
  const cell = e.currentTarget;
  const wrapRect = wrap ? wrap.getBoundingClientRect() : null;
  const cellRect = cell ? cell.getBoundingClientRect() : null;

  // Toggle if same day and tooltip already open
  if (tt && _pickerTooltipKey[prefix] === key && tt.style.display === 'block') {
    _pickerSetDay(prefix, y, m, d);
    _closePickerTooltip(prefix);
    return;
  }

  // Set the date (this re-renders the strip)
  _pickerSetDay(prefix, y, m, d);

  if (!tt || !wrapRect || !cellRect) return;

  // Find the scheduled date
  const u = UPCOMING_DATES.find(u2 => {
    const uMNum = MONTH_NUMS[u2.month];
    const uyr = u2.year || new Date().getFullYear();
    return uMNum === m && u2.day === d && uyr === y;
  });
  if (!u) { _closePickerTooltip(prefix); return; }

  _pickerTooltipKey[prefix] = key;

  const iconHtml = activityIcon(u.activity, 14, '#9a8a7a');
  const timeHtml = u.time ? `<span style="font-size:12px;color:#9a8a7a;font-family:sans-serif;margin-left:4px">${_shortTime(u.time)}</span>` : '';
  tt.innerHTML = `<div style="display:flex;align-items:center;gap:6px">${iconHtml}<span style="font-size:14px;font-family:sans-serif;color:#2a1f1f">${u.venue}</span>${timeHtml}</div>`;

  // Position using pre-captured rects (before DOM rebuild)
  const cellCenterX = cellRect.left - wrapRect.left + cellRect.width / 2;
  const cellBottom = cellRect.bottom - wrapRect.top;

  tt.style.display = 'block';
  const ttW = tt.offsetWidth || 140;
  let left = cellCenterX - ttW / 2;
  if (left < 4) left = 4;
  if (left + ttW > wrapRect.width - 4) left = wrapRect.width - ttW - 4;
  tt.style.left = left + 'px';
  tt.style.top = (cellBottom - 9) + 'px';
  tt.style.setProperty('--caret-left', (cellCenterX - left) + 'px');

  // Dismiss on outside click — use a flag to skip the immediate event bubble
  let skipFirst = true;
  const dismiss = () => {
    if (skipFirst) { skipFirst = false; return; }
    _closePickerTooltip(prefix);
    document.removeEventListener('click', dismiss);
  };
  document.addEventListener('click', dismiss);
}

function _closePickerTooltip(prefix) {
  _pickerTooltipKey[prefix] = null;
  const tt = document.getElementById(prefix + '-picker-tooltip');
  if (tt) tt.style.display = 'none';
}

// Parse user-typed date strings → YYYY-MM-DD string or ''
function parseDateText(raw) {
  if (!raw || !raw.trim()) return '';
  const s = raw.trim();
  const now = new Date();
  const curY = now.getFullYear();
  const MONTHS = ['january','february','march','april','may','june',
                  'july','august','september','october','november','december'];
  const MONTHS3 = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];

  let y = null, m = null, d = null; // m is 0-based

  // Try YYYY-MM-DD (already formatted)
  let match = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  if (match) { y = +match[1]; m = +match[2]-1; d = +match[3]; }

  // MM/DD/YY or MM/DD/YYYY
  if (!match) {
    match = s.match(/^(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?$/);
    if (match) { m = +match[1]-1; d = +match[2]; y = match[3] ? (match[3].length===2 ? 2000 + +match[3] : +match[3]) : null; }
  }

  // MM-DD or MM-DD-YYYY
  if (!match) {
    match = s.match(/^(\d{1,2})-(\d{1,2})(?:-(\d{2,4}))?$/);
    if (match) { m = +match[1]-1; d = +match[2]; y = match[3] ? (match[3].length===2 ? 2000 + +match[3] : +match[3]) : null; }
  }

  // "Month DD" or "Month DD YYYY" or "Month DD, YYYY"
  if (!match) {
    const monthPattern = '(' + MONTHS.join('|') + '|' + MONTHS3.join('|') + ')';
    const rx = new RegExp('^' + monthPattern + '[\\s,]+' + '(\\d{1,2})' + '(?:[\\s,]+(\\d{2,4}))?$', 'i');
    match = s.match(rx);
    if (match) {
      const mn = match[1].toLowerCase();
      m = MONTHS.indexOf(mn) >= 0 ? MONTHS.indexOf(mn) : MONTHS3.indexOf(mn);
      d = +match[2];
      y = match[3] ? (match[3].length===2 ? 2000 + +match[3] : +match[3]) : null;
    }
  }

  // "DD Month" or "DD Month YYYY"
  if (!match) {
    const monthPattern = '(' + MONTHS.join('|') + '|' + MONTHS3.join('|') + ')';
    const rx = new RegExp('^(\\d{1,2})[\\s,]+' + monthPattern + '(?:[\\s,]+(\\d{2,4}))?$', 'i');
    match = s.match(rx);
    if (match) {
      d = +match[1];
      const mn = match[2].toLowerCase();
      m = MONTHS.indexOf(mn) >= 0 ? MONTHS.indexOf(mn) : MONTHS3.indexOf(mn);
      y = match[4] ? (match[4].length===2 ? 2000 + +match[4] : +match[4]) : null;
    }
  }

  if (m === null || d === null) return '';
  if (m < 0 || m > 11 || d < 1 || d > 31) return '';

  // If no year given: use current year; if that date is in the past, use next year
  if (y === null) {
    const attempt = new Date(curY, m, d); attempt.setHours(0,0,0,0);
    const todayMid = new Date(); todayMid.setHours(0,0,0,0);
    y = attempt < todayMid ? curY + 1 : curY;
  }

  const pad = n => String(n).padStart(2,'0');
  return `${y}-${pad(m+1)}-${pad(d)}`;
}

function finalizePickerText(prefix) {
  const textEl = document.getElementById(prefix + '-day-text');
  const hiddenEl = document.getElementById(prefix + '-day');
  if (!textEl || !hiddenEl) return;
  const parsed = parseDateText(textEl.value);
  if (parsed) {
    hiddenEl.value = parsed;
    const [yyyy, mm, dd] = parsed.split('-').map(Number);
    const pad = n => String(n).padStart(2,'0');
    textEl.value = `${pad(mm)}/${pad(dd)}/${String(yyyy).slice(-2)}`;
    _buildPickerStrip(prefix);
    _initPickerStrip(prefix);
  } else {
    hiddenEl.value = '';
  }
}

// ═══════════════════════════════════════════════════════
// NEW IDEA / NEW DATE SHEET
// ═══════════════════════════════════════════════════════

const catMemory = { out: 'restaurant', in: 'orderin' };
let sheetMode = 'idea'; // 'idea' | 'date'

function openSheet(type) {
  // type = 'out' | 'in' | 'date'
  if (type === 'date') {
    sheetMode = 'date';
  _dateIsPrivate = null;
  _renderPrivacyBox('date-lock-icon', 'date-privacy-box', false, false);
    selectedActivity = null;
  } else {
    sheetMode = 'idea';
    ideaType = type || 'out';
    selectedCategory = catMemory[ideaType];
    _ideaCustomIconKey = null;
    document.getElementById('idea-name').value = '';
  _populateImgContainer('idea-image-fields', []);
  _wireImgIconBtn('idea-img-icon-btn', () => (document.getElementById('idea-name')||{value:''}).value.trim());
  _updateImgCountBox('idea-image-fields', 'idea-img-count-box');
  _updateImgCountBox('idea-image-fields', 'idea-img-count-box-in');
    document.getElementById('idea-address').value = '';
    if (document.getElementById('idea-neighborhood')) document.getElementById('idea-neighborhood').value = '';
    document.getElementById('idea-note-short').value = '';
    document.getElementById('idea-note-long').value = '';
    const inSd = document.getElementById('idea-in-shortdesc');
    if (inSd) inSd.value = '';
  }
  renderSheetUI();
  document.getElementById('idea-sheet').style.display = 'flex';
  sheetOpen = true;
  document.getElementById('btn-new-circle').style.background = '#a05268';
  document.getElementById('btn-new-icon-plus').style.display = 'none';
  document.getElementById('btn-new-icon-check').style.display = 'block';
  setTimeout(() => { document.getElementById('sheet-overlay').style.display = 'block'; }, 0);
}

function switchSheetType(type) {
  // Toggle Out/In within the New Idea sheet without closing
  if (type === ideaType) return;
  catMemory[ideaType] = selectedCategory;
  ideaType = type;
  const newCats = type === 'out' ? OUT_CATS : IN_CATS;
  const remembered = catMemory[type];
  const catIds = newCats.map(c => c.id);
  selectedCategory = catIds.includes(remembered) ? remembered : (newCats[0] ? newCats[0].id : '');
  renderSheetUI();
}

function switchSheetContext(view) {
  // Called when nav tab tapped while a sheet (idea or todo) is open
  if (view === 'out' || view === 'in') view = 'ideas'; if (ideasFilter === 'favs') ideasFilter = 'all';
  currentView = view;
  render();
  if (view === 'todo') {
    // Close idea sheet, open todo sheet
    document.getElementById('idea-sheet').style.display = 'none';
    sheetOpen = false;
    sheetMode = 'idea';
    openTodoAdd();
  } else {
    // Close todo sheet, open appropriate idea/date sheet
    const ts = document.getElementById('todo-sheet');
    if (ts && ts.style.display === 'block') {
      ts.style.display = 'none';
      _todoSelectedActivity = null;
      // Don't reset btn-new — we're about to re-open a sheet
    }
    if (view === 'calendar') { sheetMode = 'date'; _dateIsPrivate = null; _renderPrivacyBox('date-lock-icon', 'date-privacy-box', _effectivePrivate(_dateIsPrivate, _dateIdeaIsPrivate()), false); }
    else sheetMode = 'idea';
    // Ensure idea sheet is shown
    document.getElementById('sheet-overlay').style.display = 'block';
    document.getElementById('idea-sheet').style.display = 'flex';
    sheetOpen = true;
    document.getElementById('btn-new-circle').style.background = '#a05268';
    document.getElementById('btn-new-icon-plus').style.display = 'none';
    document.getElementById('btn-new-icon-check').style.display = 'block';
    renderSheetUI();
  }
}

function closeSheet() {
  document.getElementById('sheet-overlay').style.display = 'none';
  document.getElementById('idea-sheet').style.display = 'none';
  sheetOpen = false;
  window._editingIdeaId = null;
  sheetMode = 'idea';
  document.getElementById('btn-new-circle').style.background = ROSE;
  document.getElementById('btn-new-icon-plus').style.display = 'block';
  document.getElementById('btn-new-icon-check').style.display = 'none';
}

function handleNewBtn() {
  if (sheetOpen) {
    if (sheetMode === 'date') saveNewDate();
    else saveNewIdea();
    return;
  }
  const _tsEl = document.getElementById('todo-sheet');
  if (_tsEl && _tsEl.style.display === 'block') { saveTodoFromSheet(); return; }
  if (currentView === 'ideas') {
    openSheet(ideasFilter === 'in' ? 'in' : 'out');
  } else if (currentView === 'calendar') {
    openSheet('date');
  } else if (currentView === 'home') {
    currentView = 'ideas';
    render();
    openSheet('out');
  } else if (currentView === 'todo') {
    const _ts = document.getElementById('todo-sheet');
    if (_ts && _ts.style.display === 'block') { closeTodoSheet(); return; }
    openTodoAdd();
    return;
  } else {
    openSheet('out');
  }
}

function setCategory(cat) {
  selectedCategory = cat;
  catMemory[ideaType] = cat;
  // sync to dropdown if sheet is open
  const isOut = ideaType === 'out';
  const sel = document.getElementById(isOut ? 'idea-cat-select' : 'idea-cat-select-in');
  if (sel) sel.value = cat;
  updateIdeaCatIcon();
  if (isOut) onIdeaSheetCategoryChange();
}

function renderSheetUI() {
  if (sheetMode === 'date') {
    renderDateSheetUI();
    return;
  }
  const isOut = ideaType === 'out';
  document.getElementById('sheet-title').textContent = 'New Idea';

  // Show toggle, update active button
  const toggle = document.getElementById('sheet-type-toggle');
  if (toggle) {
    toggle.style.display = 'flex';
    const outBtn = document.getElementById('stoggle-out');
    const inBtn  = document.getElementById('stoggle-in');
    if (outBtn && inBtn) {
      const _dm = document.body.classList.contains('dark-mode');
      const _tabActiveBg = _dm ? '#9a8a7a' : '#fff';
      const _tabActiveColor = _dm ? '#f0ede9' : '#2a1f1f';
      const activeStyle = `background:${_tabActiveBg};color:${_tabActiveColor};box-shadow:0 1px 3px rgba(0,0,0,0.1)`;
      const inactiveStyle = 'background:transparent;color:#9a8a7a';
      outBtn.style.cssText = `padding:3px 10px;border:none;border-radius:5px;font-family:sans-serif;font-size:12px;font-weight:600;cursor:pointer;${isOut?activeStyle:inactiveStyle}`;
      inBtn.style.cssText  = `padding:3px 10px;border:none;border-radius:5px;font-family:sans-serif;font-size:12px;font-weight:600;cursor:pointer;${!isOut?activeStyle:inactiveStyle}`;
    }
  }

  document.getElementById('idea-fields').style.display = 'block';
  document.getElementById('date-fields').style.display = 'none';

  // Show/hide the right category dropdown
  const outCatRow = document.getElementById('idea-cat-out-row');
  const inCatRow  = document.getElementById('idea-cat-in-row');
  outCatRow.style.display = isOut ? 'flex' : 'none';
  inCatRow.style.display  = isOut ? 'none' : 'flex';

  // Name placeholder
  document.getElementById('idea-name').placeholder = isOut ? 'Place / activity' : 'Activity';

  // Out/In only sections
  document.getElementById('out-fields-wrap').style.display = isOut ? 'block' : 'none';
  if (isOut) document.getElementById('idea-images-wrap').style.display = 'flex';
  document.getElementById('in-fields-wrap').style.display = isOut ? 'none' : 'flex';
  // idea-fields must stretch to fill body height so In textarea can expand
  const ideaFields = document.getElementById('idea-fields');
  ideaFields.style.display = 'flex';
  ideaFields.style.flexDirection = 'column';
  ideaFields.style.flex = isOut ? '' : '1';
  ideaFields.style.minHeight = isOut ? '' : '0';

  // Rebuild category dropdown options from current OUT_CATS/IN_CATS
  _rebuildCatDropdown('out');
  _rebuildCatDropdown('in');

  // Sync dropdown value to selectedCategory
  const sel = isOut
    ? document.getElementById('idea-cat-select')
    : document.getElementById('idea-cat-select-in');
  const cats = isOut ? OUT_CATS : IN_CATS;
  const catIds = cats.map(c => c.id);
  sel.value = catIds.includes(selectedCategory) ? selectedCategory : cats[0].id;
  selectedCategory = sel.value;

  // Init showtype: Other → unchecked, else → checked
  const showtypeId = isOut ? 'idea-showtype' : 'idea-showtype-in';
  const showtypeEl = document.getElementById(showtypeId);
  if (showtypeEl && !window._editingIdeaId) {
    showtypeEl.checked = (selectedCategory || '').toLowerCase() !== 'other';
  }

  updateIdeaCatIcon();
  if (isOut) onIdeaSheetCategoryChange();
  // Heart button: default to saved for new ideas, preserve state for edits
  if (!window._editingIdeaId) window._ideaSaved = false;
  renderIdeaHeartBtn();
}

function toggleIdeaHeart() {
  window._ideaSaved = !window._ideaSaved;
  renderIdeaHeartBtn();
}

function renderIdeaHeartBtn() {
  const btn = document.getElementById('idea-heart-btn');
  if (!btn) return;
  btn.innerHTML = ICONS.heart(18, ROSE, window._ideaSaved);
}

function onIdeaCatSelectChange() {
  const isOut = ideaType === 'out';
  const sel = isOut
    ? document.getElementById('idea-cat-select')
    : document.getElementById('idea-cat-select-in');
  if (sel.value === '__edit_cats__') {
    // Restore previous selection, then open Edit Categories
    sel.value = selectedCategory;
    openEditCategories(ideaType);
    return;
  }
  selectedCategory = sel.value;
  catMemory[ideaType] = selectedCategory;
  _ideaCustomIconKey = null; // clear custom icon when category changes
  updateIdeaCatIcon();
  // Auto-manage showtype: Other → uncheck, else → check
  const showtypeId = isOut ? 'idea-showtype' : 'idea-showtype-in';
  const showtypeEl = document.getElementById(showtypeId);
  if (showtypeEl) {
    const isOther = (selectedCategory || '').toLowerCase() === 'other';
    showtypeEl.checked = !isOther;
  }
  if (isOut) onIdeaSheetCategoryChange();
}

function updateIdeaCatIcon() {
  const isOut = ideaType === 'out';
  const btnId = isOut ? 'idea-cat-icon-btn' : 'idea-cat-icon-in-btn';
  const iconEl = document.getElementById(btnId);
  if (!iconEl) return;
  const defaultKey = _ideaDefaultIconKey(selectedCategory);
  const isCustom = _ideaCustomIconKey && _ideaCustomIconKey !== defaultKey;
  const iconKey = isCustom ? _ideaCustomIconKey : defaultKey;
  const _dm = document.body.classList.contains('dark-mode');
  const color = isCustom ? (_dm ? ROSE : BURGUNDY) : '#9a8a7a';
  iconEl.innerHTML = ICONS[iconKey] ? ICONS[iconKey](18, color) : activityIcon(selectedCategory, 18, color);
}

function onIdeaSheetCategoryChange() {
  const cat = (selectedCategory || '').toLowerCase();
  const showCuisine = cat === 'restaurant' || cat === 'cafe';
  document.getElementById('cuisine-wrap').style.display = showCuisine ? 'flex' : 'none';
  const sdWrap = document.getElementById('idea-shortdesc-wrap');
  if (sdWrap) sdWrap.style.display = ideaType === 'out' ? 'flex' : 'none';
  const aboutWrap = document.getElementById('idea-about-wrap');
  if (aboutWrap) aboutWrap.style.display = ideaType === 'out' ? 'flex' : 'none';
  document.getElementById('reservation-wrap').style.display = ideaType === 'out' ? 'block' : 'none';
  const resEl = document.getElementById('idea-reservation');
  if (resEl && ideaType === 'out') {
    const resyDefault = ['restaurant','bar','livejazz'].includes(cat);
    if (!window._editingIdeaId) resEl.value = resyDefault ? 'resy' : 'website';
  }
  onIdeaReservationChange();
}

function onIdeaReservationChange() {
  const el = document.getElementById('idea-reservation');
  if (!el) return;
  const v = el.value;
  document.getElementById('idea-website-wrap').style.display = v === 'website' ? 'block' : 'none';
  document.getElementById('idea-eventbrite-wrap').style.display = v === 'eventbrite' ? 'block' : 'none';
  if (v === 'website' || v === 'eventbrite') {
    const inputId = v === 'website' ? 'idea-website-url' : 'idea-eventbrite-url';
    const inp = document.getElementById(inputId);
    const scrollEl = document.getElementById('idea-sheet-body');
    setTimeout(() => {
      if (scrollEl) scrollEl.scrollTop = scrollEl.scrollHeight;
      if (inp) { inp.focus(); inp.select(); }
    }, 50);
  }
}

function renderDateSheetUI() {
  document.getElementById('sheet-title').textContent = 'New Date';
  const toggle = document.getElementById('sheet-type-toggle');
  if (toggle) toggle.style.display = 'none';
  document.getElementById('idea-fields').style.display = 'none';
  document.getElementById('date-fields').style.display = 'block';
  // Reset activity button
  document.getElementById('date-activity-icon').innerHTML = '';
  document.getElementById('date-activity-icon').style.display = 'none';
  document.getElementById('date-activity-label').textContent = 'Date ideas…';
  document.getElementById('date-activity-label').style.fontSize = '16px';
  document.getElementById('date-activity-label').style.color = 'var(--text-placeholder)';
  document.getElementById('date-activity-btn').style.borderColor = document.body.classList.contains('dark-mode') ? 'var(--border)' : '#ede9e2';
  document.getElementById('date-custom-wrap').style.display = 'none';
  const _daib3 = document.getElementById('date-activity-info-btn'); if (_daib3) _daib3.style.display = 'none';
  document.getElementById('date-custom-name').value = '';
  // Hide location until Custom is selected
  document.getElementById('date-location-text-wrap').style.display = 'none';
  document.getElementById('date-neighborhood-wrap').style.display = 'none';
  document.getElementById('date-note').value = '';
  populateDateImageFields([]);
  const _fillDay = selectedCalDay || new Date().getDate();
  const _fillMonth = selectedCalDay ? currentCalMonth : new Date().getMonth();
  const _fillYear  = selectedCalDay ? currentCalYear  : new Date().getFullYear();
  const mm = String(_fillMonth + 1).padStart(2, '0');
  const dd = String(_fillDay).padStart(2, '0');
  const _hiddenVal = `${_fillYear}-${mm}-${dd}`;
  const _displayVal = `${mm}/${dd}/${String(_fillYear).slice(-2)}`;
  document.getElementById('date-day').value = _hiddenVal;
  const _textEl = document.getElementById('date-day-text');
  if (_textEl) _textEl.value = _displayVal;
  document.getElementById('date-time-select').value = '';
  setTimeout(() => { _buildPickerStrip('date'); _initPickerStrip('date'); }, 0);
}


function renderIdeaSubwayBadges() {
  const val = document.getElementById('idea-subway').value;
  const wrap = document.getElementById('idea-subway-badges');
  if (!wrap) return;
  if (!val.trim()) { wrap.innerHTML=''; wrap.style.marginTop='0'; return; }
  const toIdx = val.toLowerCase().indexOf(' to ');
  const linesPart = toIdx >= 0 ? val.substring(0, toIdx) : val;
  const lines = [...new Set((linesPart.match(/\b[1-7ACEGJLNQRSWBDFMZ]\b/gi)||[]).map(l=>l.toUpperCase()))];
  const buses = [...new Set((linesPart.match(/\b[BMQ]\d+\b/gi)||[]).map(b=>b.toUpperCase()))];
  const timeMatch = val.match(/~?\s*(\d+)\s*min/i);
  const stationMatch = val.match(/to\s+(.+?)\s*~?\s*\d+\s*min/i);
  if (!lines.length && !buses.length) { wrap.innerHTML=''; wrap.style.marginTop='0'; return; }
  let html = '';
  lines.forEach((line, i) => {
    const bg = MTA_COLORS[line]||'#808183';
    const tc = ['N','Q','R','W'].includes(line)?'#1F2937':'#fff';
    if(i>0) html+=`<span style="color:#b0a090;font-size:11px">›</span>`;
    html+=`<div style="width:20px;height:20px;border-radius:50%;background:${bg};display:flex;align-items:center;justify-content:center;color:${tc};font-size:11px;font-weight:700;font-family:sans-serif">${line}</div>`;
  });
  if(lines.length&&buses.length) html+=`<span style="color:#b0a090;font-size:11px">›</span>`;
  buses.forEach((bus,i)=>{
    if(i>0) html+=`<span style="color:#b0a090;font-size:11px">›</span>`;
    html+=`<div style="padding:2px 6px;border-radius:3px;background:#2e58ad;color:#fff;font-size:11px;font-weight:700;font-family:sans-serif">${bus}</div>`;
  });
  const station = stationMatch?stationMatch[1].trim():null;
  const time = timeMatch?timeMatch[1]:null;
  if(station||time) html+=`<span style="color:#9a8a7a;font-size:12px;font-family:sans-serif">${station&&time?station+' · '+time+' min':station||time+' min'}</span>`;
  wrap.style.marginTop='8px';
  wrap.innerHTML = html;
}

function renderIdeaWalkDriveBadges() {
  const val = document.getElementById('idea-walkdrive').value;
  const wrap = document.getElementById('idea-walkdrive-badges');
  if (!wrap) return;
  if (!val.trim()) { wrap.innerHTML=''; wrap.style.marginTop='0'; return; }
  const walkMatch = val.match(/(\d+)\s*min\s*walk/i);
  const driveMatch = val.match(/(\d+)\s*min\s*drive/i);
  if (!walkMatch && !driveMatch) { wrap.innerHTML=''; wrap.style.marginTop='0'; return; }
  const personSvg = `<svg viewBox="0 0 24 24" width="13" height="13" fill="#9a8a7a"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/></svg>`;
  const carSvg = `<svg viewBox="0 0 24 24" width="13" height="13" fill="#9a8a7a"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>`;
  let html = '';
  if(walkMatch) html+=`<span style="display:flex;align-items:center;gap:3px;font-size:12px;color:#9a8a7a;font-family:sans-serif">${personSvg}${walkMatch[1]} min</span>`;
  if(walkMatch&&driveMatch) html+=`<span style="color:#c8bfb6">/</span>`;
  if(driveMatch) html+=`<span style="display:flex;align-items:center;gap:3px;font-size:12px;color:#9a8a7a;font-family:sans-serif">${carSvg}${driveMatch[1]} min</span>`;
  wrap.style.marginTop='8px';
  wrap.innerHTML = html;
}

// Edit Idea modal badge renderers (pf- fields)
function renderSubwayBadges() {
  const val = (document.getElementById('pf-subway')||{}).value || '';
  const wrap = document.getElementById('pf-subway-badges');
  if (!wrap) return;
  if (!val.trim()) { wrap.innerHTML=''; wrap.style.marginTop='0'; return; }
  const toIdx = val.toLowerCase().indexOf(' to ');
  const linesPart = toIdx >= 0 ? val.substring(0, toIdx) : val;
  const lines = [...new Set((linesPart.match(/\b[1-7ACEGJLNQRSWBDFMZ]\b/gi)||[]).map(l=>l.toUpperCase()))];
  const buses = [...new Set((linesPart.match(/\b[BMQ]\d+\b/gi)||[]).map(b=>b.toUpperCase()))];
  const timeMatch = val.match(/~?\s*(\d+)\s*min/i);
  const stationMatch = val.match(/to\s+(.+?)\s*~?\s*\d+\s*min/i);
  if (!lines.length && !buses.length) { wrap.innerHTML=''; wrap.style.marginTop='0'; return; }
  let html = '';
  lines.forEach((line, i) => {
    const bg = MTA_COLORS[line]||'#808183';
    const tc = ['N','Q','R','W'].includes(line)?'#1F2937':'#fff';
    if(i>0) html+=`<span style="color:#b0a090;font-size:11px">›</span>`;
    html+=`<div style="width:20px;height:20px;border-radius:50%;background:${bg};display:flex;align-items:center;justify-content:center;color:${tc};font-size:11px;font-weight:700;font-family:sans-serif">${line}</div>`;
  });
  if(lines.length&&buses.length) html+=`<span style="color:#b0a090;font-size:11px">›</span>`;
  buses.forEach((bus,i)=>{
    if(i>0) html+=`<span style="color:#b0a090;font-size:11px">›</span>`;
    html+=`<div style="padding:2px 6px;border-radius:3px;background:#2e58ad;color:#fff;font-size:11px;font-weight:700;font-family:sans-serif">${bus}</div>`;
  });
  const station = stationMatch?stationMatch[1].trim():null;
  const time = timeMatch?timeMatch[1]:null;
  if(station||time) html+=`<span style="color:#9a8a7a;font-size:12px;font-family:sans-serif">${station&&time?station+' · '+time+' min':station||time+' min'}</span>`;
  wrap.style.marginTop='8px';
  wrap.innerHTML = html;
}

function renderWalkDriveBadges() {
  const val = (document.getElementById('pf-walkdrive')||{}).value || '';
  const wrap = document.getElementById('pf-walkdrive-badges');
  if (!wrap) return;
  if (!val.trim()) { wrap.innerHTML=''; wrap.style.marginTop='0'; return; }
  const walkMatch = val.match(/(\d+)\s*min\s*walk/i);
  const driveMatch = val.match(/(\d+)\s*min\s*drive/i);
  if (!walkMatch && !driveMatch) { wrap.innerHTML=''; wrap.style.marginTop='0'; return; }
  const personSvg = `<svg viewBox="0 0 24 24" width="13" height="13" fill="#9a8a7a"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/></svg>`;
  const carSvg = `<svg viewBox="0 0 24 24" width="13" height="13" fill="#9a8a7a"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>`;
  let html = '';
  if(walkMatch) html+=`<span style="display:flex;align-items:center;gap:3px;font-size:12px;color:#9a8a7a;font-family:sans-serif">${personSvg}${walkMatch[1]} min</span>`;
  if(walkMatch&&driveMatch) html+=`<span style="color:#c8bfb6">/</span>`;
  if(driveMatch) html+=`<span style="display:flex;align-items:center;gap:3px;font-size:12px;color:#9a8a7a;font-family:sans-serif">${carSvg}${driveMatch[1]} min</span>`;
  wrap.style.marginTop='8px';
  wrap.innerHTML = html;
}

function ideaMapsAddress() {
  const addr = document.getElementById('idea-address').value.trim();
  const name = document.getElementById('idea-name').value.trim();
  const q = addr || name;
  if (q) _openExternal(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`);
}
function ideaTransitDirections() {
  const dest = document.getElementById('idea-address').value.trim();
  if (!dest || !homeAddress) return;
  _openExternal(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(homeAddress)}&destination=${encodeURIComponent(dest)}&travelmode=transit`);
}
function ideaWalkingDirections() {
  const dest = document.getElementById('idea-address').value.trim();
  if (!dest || !homeAddress) return;
  _openExternal(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(homeAddress)}&destination=${encodeURIComponent(dest)}&travelmode=walking`);
}
function ideaOpenReservation() {
  const name = document.getElementById('idea-name').value.trim();
  if (!name) return;
  const res = document.getElementById('idea-reservation').value;
  const date = new Date().toISOString().split('T')[0];
  const slug = name.toLowerCase().replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,'-');
  const q = encodeURIComponent(name+' New York City');
  if (res==='opentable') _openExternal(`https://www.opentable.com/s?term=${encodeURIComponent(name)}&covers=2&dateTime=${date}T19:00`);
  else if (res==='eventbrite') { const url=document.getElementById('idea-eventbrite-url').value.trim(); _openExternal(url||`https://www.google.com/search?q=${encodeURIComponent(name+' eventbrite')}`); }
  else if (res==='website') _openExternal(`https://www.google.com/search?q=${encodeURIComponent(name)}`);
  else _openExternal(`https://resy.com/cities/new-york-ny/venues/${slug}?query=${q}&date=${date}&seats=2`);
}

// ── Edit Idea modal helpers ──
function markPlaceChanged() { /* no-op — changes are saved on savePlace() */ }

function onPlaceTypeChange() {
  const sel = document.getElementById('pf-type');
  if (sel.value === '__edit_cats__') {
    // Restore previous selection, open Edit Categories for the right type
    const isOut = !(IN_CATS.find(c => c.id === (window._pfPrevCat || '')));
    sel.value = window._pfPrevCat || (isOut ? OUT_CATS[0].id : IN_CATS[0].id);
    openEditCategories(isOut ? 'out' : 'in');
    return;
  }
  window._pfPrevCat = sel.value;
  _pfCustomIconKey = null; // clear custom icon when category changes
  _updatePfTypeIcon();
  const cuisineTypes = ['restaurant','cafe'];
  const socialTypes = ['restaurant','bar','cafe','livemusic','venue'];
  const pfCuisine = document.getElementById('pf-cuisine-wrap');
  const pfShortdesc = document.getElementById('pf-shortdesc-wrap');
  const pfReservation = document.getElementById('pf-reservation-wrap');
  if (pfCuisine) pfCuisine.style.display = cuisineTypes.includes(sel.value) ? 'flex' : 'none';
  if (pfShortdesc) pfShortdesc.style.display = 'flex';
  const pfAbout = document.getElementById('pf-about-wrap');
  if (pfAbout) pfAbout.style.display = 'flex';
  if (pfReservation) pfReservation.style.display = 'block';
}

function onReservationChange() {
  const res = (document.getElementById('pf-reservation')||{}).value;
  const webWrap = document.getElementById('pf-website-wrap');
  if (webWrap) webWrap.style.display = res === 'website' ? 'block' : 'none';
  const wrap = document.getElementById('pf-eventbrite-wrap');
  if (wrap) wrap.style.display = res === 'eventbrite' ? 'block' : 'none';
  if (res === 'website' || res === 'eventbrite') {
    const inputId = res === 'website' ? 'pf-website-url' : 'pf-eventbrite-url';
    const inp = document.getElementById(inputId);
    const scrollEl = document.getElementById('places-form-body');
    setTimeout(() => {
      if (scrollEl) scrollEl.scrollTop = scrollEl.scrollHeight;
      if (inp) { inp.focus(); inp.select(); }
    }, 50);
  }
}

function openPlaceMapsAddress() {
  const addr = (document.getElementById('pf-address')||{}).value || '';
  const name = (document.getElementById('pf-name')||{}).value || '';
  const q = addr.trim() || name.trim();
  if (q) _openExternal(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`);
}

function openTransitDirections() {
  const dest = (document.getElementById('pf-address')||{}).value.trim();
  if (!dest || !homeAddress) return;
  _openExternal(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(homeAddress)}&destination=${encodeURIComponent(dest)}&travelmode=transit`);
}

function openWalkingDirections() {
  const dest = (document.getElementById('pf-address')||{}).value.trim();
  if (!dest || !homeAddress) return;
  _openExternal(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(homeAddress)}&destination=${encodeURIComponent(dest)}&travelmode=walking`);
}

function openReservationLink() {
  const name = (document.getElementById('pf-name')||{}).value.trim();
  if (!name) return;
  const res = (document.getElementById('pf-reservation')||{}).value;
  const date = new Date().toISOString().split('T')[0];
  const slug = name.toLowerCase().replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,'-');
  const q = encodeURIComponent(name+' New York City');
  if (res==='opentable') _openExternal(`https://www.opentable.com/s?term=${encodeURIComponent(name)}&covers=2&dateTime=${date}T19:00`);
  else if (res==='eventbrite') { const url=(document.getElementById('pf-eventbrite-url')||{}).value||''; _openExternal(url||`https://www.google.com/search?q=${encodeURIComponent(name+' eventbrite')}`); }
  else if (res==='website') _openExternal(`https://www.google.com/search?q=${encodeURIComponent(name)}`);
  else _openExternal(`https://resy.com/cities/new-york-ny/venues/${slug}?query=${q}&date=${date}&seats=2`);
}

function saveNewIdea() {
  const name = document.getElementById('idea-name').value.trim();
  if (!name) return;
  const isOut = ideaType === 'out';
  const address   = isOut ? document.getElementById('idea-address').value.trim() : '';
  const neighborhood = isOut ? (document.getElementById('idea-neighborhood') || {value:''}).value.trim() : '';
  const cuisine   = isOut ? document.getElementById('idea-cuisine').value.trim() : '';
  const shortdesc = isOut
    ? (document.getElementById('idea-shortdesc') || {value:''}).value.trim()
    : (document.getElementById('idea-in-shortdesc') || {value:''}).value.trim();
  const showType  = isOut
    ? (document.getElementById('idea-showtype') || {checked:true}).checked
    : (document.getElementById('idea-showtype-in') || {checked:true}).checked;
  const subway    = isOut ? document.getElementById('idea-subway').value.trim() : '';
  const walkdrive = isOut ? document.getElementById('idea-walkdrive').value.trim() : '';
  const about     = isOut
    ? document.getElementById('idea-about').value.trim()
    : document.getElementById('idea-note-long').value.trim();

  // Custom icon key (from New Idea sheet icon picker)
  const defaultIconKey = _ideaDefaultIconKey(selectedCategory);
  const customIconKey = (_ideaCustomIconKey && _ideaCustomIconKey !== defaultIconKey) ? _ideaCustomIconKey : undefined;

  const resEl     = document.getElementById('idea-reservation');
  const reservation = (isOut && resEl) ? resEl.value : '';
  const eventbriteUrl = (isOut && reservation === 'eventbrite') ? document.getElementById('idea-eventbrite-url').value.trim() : '';
  const websiteUrl = (isOut && reservation === 'website') ? document.getElementById('idea-website-url').value.trim() : '';
  const note = isOut
    ? document.getElementById('idea-note-short').value.trim()
    : '';

  const isPrivate = !!_ideaIsPrivate;
  if (window._editingIdeaId) {
    const item = ideas.find(i=>i.id===window._editingIdeaId);
    const _editImgUrls = collectNewIdeaImageUrls();
    if (item) Object.assign(item, { name, address, neighborhood, cuisine, shortdesc, showType, subwayRoute: subway, walkDriveTime: walkdrive, about, reservation, eventbriteUrl, websiteUrl, note, category: selectedCategory, saved: window._ideaSaved, imageUrls: _editImgUrls, isPrivate, customIconKey });
    window._editingIdeaId = null;
  } else {
    const _newImgUrls = collectNewIdeaImageUrls();
    ideas.unshift({ id: Date.now(), type: ideaType, category: selectedCategory, name, address, neighborhood, cuisine, shortdesc, showType, subwayRoute: subway, walkDriveTime: walkdrive, about, reservation, eventbriteUrl, websiteUrl, note, saved: !!window._ideaSaved, imageUrls: _newImgUrls, isPrivate, customIconKey });
  }
  saveIdeas(ideas);
  closeSheet();
  render();
}

let selectedActivity = null; // saved idea item, or { custom: true }, or null
let pickerFilter = 'all';
let pickerSearch = '';

function openIdeasPicker() {
  pickerFilter = 'all';
  pickerSearch = '';
  renderPickerBody();
  setPickerTabUI('all');
  document.getElementById('ideas-picker-overlay').style.display = 'flex';
  // Clear search input if present
  const si = document.getElementById('picker-search-input');
  if (si) si.value = '';
  const sc = document.getElementById('picker-search-clear');
  if (sc) sc.style.display = 'none';
}

function closeIdeasPicker() {
  document.getElementById('ideas-picker-overlay').style.display = 'none';
}

function setPickerFilter(f) {
  pickerFilter = f;
  setPickerTabUI(f);
  renderPickerBody();
}
function setPickerSearch(val) {
  pickerSearch = val;
  const sc = document.getElementById('picker-search-clear');
  if (sc) sc.style.display = val ? 'flex' : 'none';
  renderPickerBody();
}

function setPickerTabUI(active) {
  const _dm = document.body.classList.contains('dark-mode');
  const _activeBg = _dm ? '#9a8a7a' : '#fff';
  const _activeColor = _dm ? '#f0ede9' : '#2a1f1f';
  const heartSvg = (fill, stroke) => `<svg viewBox="0 0 24 24" width="13" height="13" stroke="${stroke}" stroke-width="2" fill="${fill}" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>`;
  ['all','out','in','favs'].forEach(f => {
    const btn = document.getElementById('ptab-' + f);
    if (!btn) return;
    if (f === active) {
      btn.style.background = _activeBg;
      btn.style.color = _activeColor;
      btn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.10)';
      if (f === 'favs') btn.innerHTML = heartSvg(_activeColor, _activeColor);
    } else {
      btn.style.background = 'transparent';
      btn.style.color = '#9a8a7a';
      btn.style.boxShadow = 'none';
      if (f === 'favs') btn.innerHTML = heartSvg('none', '#9a8a7a');
    }
  });
}

function renderPickerBody() {
  const q = (pickerSearch || '').trim().toLowerCase();
  const showOut = pickerFilter !== 'in' && pickerFilter !== 'favs' || pickerFilter === 'favs';
  const showIn  = pickerFilter !== 'out' && pickerFilter !== 'favs' || pickerFilter === 'favs';
  const includeArchived = ideasPickerContext === 'editdate' && !!_editingMemory;
  let pool = ideas.filter(i => includeArchived ? true : !i.archived);
  if (pickerFilter === 'favs') pool = pool.filter(i => i.saved);
  if (q) pool = pool.filter(i => i.name && i.name.toLowerCase().includes(q));
  // Update clear button visibility
  const sc = document.getElementById('picker-search-clear');
  if (sc) sc.style.display = q ? 'flex' : 'none';
  const outPool = pickerFilter === 'out' || pickerFilter === 'favs' || pickerFilter === 'all' ? pool.filter(i => i.type === 'out') : [];
  const inPool  = pickerFilter === 'in'  || pickerFilter === 'favs' || pickerFilter === 'all' ? pool.filter(i => i.type === 'in')  : [];
  const outIdeas = showOut ? outPool : [];
  const inIdeas  = showIn  ? inPool  : [];

  // Custom row — same quick-row style as Date Ideas screen cards
  const customRow = `
    <div onclick="selectCustomActivity()" class="quick-row" style="cursor:pointer;overflow:hidden;border-style:dashed;margin-bottom:8px">
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;gap:7px">
          <svg viewBox="0 0 24 24" width="14" height="14" stroke="#b0a090" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          <div class="quick-row-name" style="color:#b0a090">Custom</div>
        </div>
        <div class="quick-row-sub">Enter a one-off activity</div>
      </div>
    </div>`;

  function pickerCard(item, type) {
    const accent = accentColor(type);
    const _subColor = subColor(type);
    const sub = itemSubLine(item);
    const urls = getImageUrls(item);
    const imgPanel = urls.length
      ? '<div style="width:120px;flex-shrink:0;margin:-12px -14px -12px 0;border-left:1px solid var(--img-sep);border-radius:0 14px 14px 0;overflow:hidden;align-self:stretch;background:#6b2340;position:relative"><img src="' + urls[0] + '" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;display:block" onerror="this.parentNode.style.background=\'#6b2340\';this.style.display=\'none\'"></div>'
      : '';
    const subHtml = sub ? '<div class="quick-row-sub" style="color:' + _subColor + '">' + sub + '</div>' : '';
    return '<div onclick="selectActivity(' + item.id + ')" class="quick-row" style="cursor:pointer;overflow:hidden;margin-bottom:8px">'
      + '<div style="flex:1;min-width:0">'
      + '<div style="display:flex;align-items:center;gap:7px;margin-bottom:' + (sub ? '4px' : '0') + '">'
      + ideaIcon(item, 14, accent)
      + '<div class="quick-row-name">' + item.name + '</div>'
      + '</div>'
      + subHtml
      + '</div>'
      + imgPanel
      + '</div>';
  }

  function section(items, type) {
    if (!items.length) return '';
    const accent = accentColor(type);
    const label = type === 'out' ? 'Going Out' : 'Staying In';
    return '<div style="font-size:11px;font-weight:700;color:' + accent + ';letter-spacing:0.08em;text-transform:uppercase;font-family:sans-serif;margin:0 0 8px">' + label + '</div>'
      + items.map(function(item){ return pickerCard(item, type); }).join('')
      + '<div style="height:8px"></div>';
  }

  document.getElementById('ideas-picker-body').innerHTML =
    customRow + section(outIdeas, 'out') + section(inIdeas, 'in');
}

function selectCustomActivity() {
  const plusIcon = `<svg viewBox="0 0 24 24" width="16" height="16" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`;

  if (ideasPickerContext === 'editdate') {
    edSelectedActivity = { custom: true };
    document.getElementById('ed-activity-icon').innerHTML = plusIcon;
    document.getElementById('ed-activity-icon').style.display = '';
    document.getElementById('ed-activity-label').textContent = 'Custom';
    document.getElementById('ed-activity-label').style.color = '#9a8a7a';
    document.getElementById('ed-activity-btn').style.borderColor = '#b0a090';
    document.getElementById('ed-custom-wrap').style.display = 'flex';
    document.getElementById('ed-custom-name').value = '';
    document.getElementById('ed-location-wrap').style.display = 'block';
    _updateInLocationVisibility('ed', false);
    closeIdeasPicker();
    ideasPickerContext = 'sheet';
    setTimeout(() => document.getElementById('ed-custom-name').focus(), 100);
    return;
  }

  selectedActivity = { custom: true };
  document.getElementById('date-activity-icon').innerHTML = plusIcon;
  document.getElementById('date-activity-icon').style.display = '';
  document.getElementById('date-activity-label').textContent = 'Custom';
  document.getElementById('date-activity-label').style.color = '#9a8a7a';
  document.getElementById('date-activity-btn').style.borderColor = '#b0a090';
  const _daib2 = document.getElementById('date-activity-info-btn'); if (_daib2) _daib2.style.display = 'none';
  document.getElementById('date-custom-wrap').style.display = 'flex';
  document.getElementById('date-custom-name').value = '';
  document.getElementById('date-custom-name').focus();
  showLocationText('');
  document.getElementById('date-neighborhood-wrap').style.display = 'flex';
  document.getElementById('date-neighborhood').value = '';
  document.getElementById('date-note').value = '';
  _updateInLocationVisibility('date', false);
  closeIdeasPicker();
}

function selectActivity(id) {
  const item = ideas.find(i => i.id === id);
  if (!item) return;
  const accent = accentColor(item.type);

  if (ideasPickerContext === 'editdate') {
    edSelectedActivity = item;
    _edIsPrivate = null;
    document.getElementById('ed-activity-icon').innerHTML = ideaIcon(item, 16, accent);
    document.getElementById('ed-activity-icon').style.display = '';
    document.getElementById('ed-activity-label').textContent = item.name;
    document.getElementById('ed-activity-label').style.fontSize = '';
    document.getElementById('ed-activity-label').style.color = document.body.classList.contains('dark-mode') ? 'var(--text-primary)' : '#2a1f1f';
    document.getElementById('ed-activity-btn').style.borderColor = accent;
    document.getElementById('ed-custom-wrap').style.display = 'none';
    document.getElementById('ed-location-wrap').style.display = 'none';
    _updateInLocationVisibility('ed', item.type === 'in');
    _edUpdateActivityEditBtn(true);
    // Refresh privacy box — reset explicit override, inherit from new idea
    _renderPrivacyBox('ed-lock-icon', 'ed-privacy-box', _effectivePrivate(_edIsPrivate, _edIdeaIsPrivate()), _edIsPrivate === null && _edIdeaIsPrivate());
    closeIdeasPicker();
    ideasPickerContext = 'sheet';
    return;
  }

  selectedActivity = item;
  _dateIsPrivate = null;
  document.getElementById('date-activity-icon').innerHTML = ideaIcon(item, 16, accent);
  document.getElementById('date-activity-icon').style.display = '';
  document.getElementById('date-activity-label').textContent = item.name;
  document.getElementById('date-activity-label').style.fontSize = '';
  document.getElementById('date-activity-label').style.color = document.body.classList.contains('dark-mode') ? 'var(--text-primary)' : '#2a1f1f';
  document.getElementById('date-activity-btn').style.borderColor = accent;
  const _daib = document.getElementById('date-activity-info-btn');
  if (_daib) { _daib.style.display = 'flex'; _daib.dataset.ideaId = item.id; }
  document.getElementById('date-custom-wrap').style.display = 'none';
  // Hide out/custom location fields
  document.getElementById('date-location-text-wrap').style.display = 'none';
  document.getElementById('date-neighborhood-wrap').style.display = 'none';
  // Show In-location for In activities
  _updateInLocationVisibility('date', item.type === 'in');
  // Never auto-fill note
  document.getElementById('date-note').value = '';
  // Refresh privacy box — reset explicit override, inherit from new idea
  _renderPrivacyBox('date-lock-icon', 'date-privacy-box', _effectivePrivate(_dateIsPrivate, _dateIdeaIsPrivate()), _dateIsPrivate === null && _dateIdeaIsPrivate());
  closeIdeasPicker();
}

function showLocationText(val) {
  document.getElementById('date-location-text-wrap').style.display = 'flex';
  document.getElementById('date-location-text').value = val;
}

function showLocationSelect() {
  document.getElementById('date-location-text-wrap').style.display = 'none';
}

// Show/hide the In-location fields; prefix is 'date' or 'ed'
function _updateInLocationVisibility(prefix, show) {
  const wrap = document.getElementById(prefix + '-in-location-wrap');
  if (!wrap) return;
  wrap.style.display = show ? 'block' : 'none';
  if (show) {
    // Update partner option label with current pronoun
    const partnerOpt = document.getElementById(prefix + '-in-partner-option');
    if (partnerOpt) partnerOpt.textContent = partnerPlaceLabel();
    // Reset to default if switching to In
    const sel = document.getElementById(prefix + '-in-location-select');
    if (sel && sel.value === '') sel.value = 'my_place';
    // Sync Other address field visibility
    const otherWrap = document.getElementById(prefix + '-in-location-other-wrap');
    if (otherWrap) otherWrap.style.display = (sel && sel.value === 'other') ? 'block' : 'none';
  }
}

function onDateInLocationChange() {
  const sel = document.getElementById('date-in-location-select');
  const otherWrap = document.getElementById('date-in-location-other-wrap');
  if (otherWrap) otherWrap.style.display = sel && sel.value === 'other' ? 'flex' : 'none';
}

function onEdInLocationChange() {
  const sel = document.getElementById('ed-in-location-select');
  const otherWrap = document.getElementById('ed-in-location-other-wrap');
  if (otherWrap) otherWrap.style.display = sel && sel.value === 'other' ? 'flex' : 'none';
}

// Read ed in-location fields and apply to date object u
function _applyEdInLocation(u) {
  const wrap = document.getElementById('ed-in-location-wrap');
  if (!wrap || wrap.style.display === 'none') return;
  const sel = document.getElementById('ed-in-location-select');
  if (!sel) return;
  u.inLocation = sel.value;
  if (sel.value === 'other') {
    u.inLocationOther = (document.getElementById('ed-in-location-other') || {}).value?.trim() || '';
  } else {
    u.inLocationOther = '';
  }
}

function parseTimeInput(raw) {
  let s = raw.trim().toLowerCase().replace(/\s+/g, '');
  if (!s) return '';

  let forcePM = null;
  if (s.endsWith('pm') || s.endsWith('p'))       { forcePM = true;  s = s.replace(/p(m)?$/, ''); }
  else if (s.endsWith('am') || s.endsWith('a'))  { forcePM = false; s = s.replace(/a(m)?$/, ''); }

  s = s.replace(':', '');

  let h, m;
  if      (s.length <= 2) { h = parseInt(s, 10); m = 0; }
  else if (s.length === 3) { h = parseInt(s[0], 10);     m = parseInt(s.slice(1), 10); }
  else if (s.length === 4) { h = parseInt(s.slice(0,2), 10); m = parseInt(s.slice(2), 10); }
  else return raw;

  if (isNaN(h) || isNaN(m) || h > 23 || m > 59) return raw;

  // Default: assume PM for any 12-hour value (1–12) unless AM explicitly given
  if (forcePM === null) forcePM = (h >= 1 && h <= 12);

  if (forcePM && h < 12)  h += 12;
  if (!forcePM && h === 12) h = 0;

  const suffix = h >= 12 ? 'pm' : 'am';
  const h12 = h === 0 ? 12 : h > 12 ? h - 12 : h;
  return `${h12}:${String(m).padStart(2,'0')} ${suffix}`;
}

function formatTimeInput(el) {
  // Live: only clean up on blur, don't interrupt typing
}

function finalizeTime(el) {
  const parsed = parseTimeInput(el.value);
  if (parsed) el.value = parsed;
}

function saveNewDate() {
  // Must have an activity selected
  if (!selectedActivity) return;
  const isCustom = selectedActivity.custom;
  let venue = '';
  let activity = '';
  let neighborhood = '';
  if (isCustom) {
    venue = document.getElementById('date-custom-name').value.trim();
    if (!venue) return;
    activity = 'Other';
    const locText = document.getElementById('date-location-text').value.trim();
    const neighText = document.getElementById('date-neighborhood').value.trim();
    const locSel = document.getElementById('date-location-select');
    const locVal = locText || (locSel && locSel.style.display === 'block' ? locSel.value : '') || '';
    // Use explicit neighborhood if entered, else parse from address
    neighborhood = neighText || _neighborhoodFromAddress(locVal) || locVal;
  } else {
    venue = selectedActivity.name || '';
    activity = selectedActivity.category || 'Other';
    neighborhood = _ideaNeighborhood(selectedActivity);
  }

  // In-activity location
  let inLocation = '', inLocationOther = '';
  if (selectedActivity && !selectedActivity.custom) {
    const idea = ideas.find(i => i.id === selectedActivity.id);
    if (idea && idea.type === 'in') {
      const sel = document.getElementById('date-in-location-select');
      inLocation = sel ? sel.value : 'my_place';
      if (inLocation === 'other') {
        inLocationOther = (document.getElementById('date-in-location-other') || {}).value?.trim() || '';
      }
    }
  }

  // Parse date
  const dayVal = document.getElementById('date-day').value; // YYYY-MM-DD
  if (!dayVal) return;
  const [yyyy, mm, dd] = dayVal.split('-').map(Number);
  const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const monthName = MONTH_NAMES[mm - 1] || 'Jan';
  const isFeb = mm === 2;

  // Parse time
  const timeVal = document.getElementById('date-time-select').value.trim();

  // Note
  const note = document.getElementById('date-note').value.trim();

  // Images
  const imageUrls = collectDateImageUrls();

  // Build date object
  const newDate = {
    day: dd, month: monthName, year: yyyy,
    activity, venue, neighborhood,
    time: timeVal || '',
    note,
    imageUrls: imageUrls.length ? imageUrls : undefined,
    inLocation: inLocation || undefined,
    inLocationOther: inLocationOther || undefined,
    isFeb,
    isPrivate: _dateIsPrivate,  // null = inherit from idea
    id: 'd_' + Date.now()
  };

  // Insert sorted by date
  UPCOMING_DATES.push(newDate);
  UPCOMING_DATES.sort((a, b) => {
    const da = new Date(a.year||2026, MONTH_NUMS[a.month]||0, a.day);
    const db = new Date(b.year||2026, MONTH_NUMS[b.month]||0, b.day);
    return da - db;
  });
  saveDates(UPCOMING_DATES);
  FUTURE_DATES = buildFutureDates();
  dateIdx = 0;
  _dateIsPrivate = null;
  _renderPrivacyBox('date-lock-icon', 'date-privacy-box', false, false);

  // Reset form
  selectedActivity = null;
  document.getElementById('date-activity-label').textContent = 'Date ideas…';
  document.getElementById('date-activity-label').style.fontSize = '16px';
  document.getElementById('date-activity-label').style.color = 'var(--text-placeholder)';
  document.getElementById('date-activity-icon').innerHTML = '';
  document.getElementById('date-activity-icon').style.display = 'none';
  document.getElementById('date-activity-btn').style.borderColor = document.body.classList.contains('dark-mode') ? 'var(--border)' : '#ede9e2';
  document.getElementById('date-custom-wrap').style.display = 'none';
  const _daib4 = document.getElementById('date-activity-info-btn'); if (_daib4) _daib4.style.display = 'none';
  populateDateImageFields([]);
  closeSheet();
  render();
}

// ═══════════════════════════════════════════════════════
// DETAIL MODAL
// ═══════════════════════════════════════════════════════
let detailItemId = null;
let currentDateInfo = null;
let _diImgIdx = 0;
let _diImgUrlsActive = [];

function diImgNav(dir, e) {
  if (e) e.stopPropagation();
  const urls = _diImgUrlsActive;
  if (!urls.length) return;
  _diImgIdx = (_diImgIdx + dir + urls.length) % urls.length;
  const el = document.getElementById('di-img-el');
  if (el) el.src = urls[_diImgIdx];
}

let _detailNavList = [];   // ordered idea IDs for swiping in Idea Info
let _featuredNavOrder = []; // current rendered order of Featured carousel
let _diNavList = [];       // ordered date objects for swiping in Date Info

// ── Info popup swipe navigation ──
function _attachInfoSwipe(elId, onSwipeLeft, onSwipeRight) {
  const el = document.getElementById(elId);
  if (!el) return;
  if (el._swipeStart) {
    el.removeEventListener('touchstart', el._swipeStart, { passive: true });
    el.removeEventListener('touchend', el._swipeEnd);
  }
  let sx = 0, sy = 0;
  el._swipeStart = e => { sx = e.touches[0].clientX; sy = e.touches[0].clientY; };
  el._swipeEnd = e => {
    const dx = e.changedTouches[0].clientX - sx;
    const dy = e.changedTouches[0].clientY - sy;
    if (Math.abs(dx) < 40 || Math.abs(dx) < Math.abs(dy) * 1.2) return;
    if (dx < 0) onSwipeLeft(); else onSwipeRight();
  };
  el.addEventListener('touchstart', el._swipeStart, { passive: true });
  el.addEventListener('touchend', el._swipeEnd);
}

function openDetail(id, navContext) {
  const item = ideas.find(i=>i.id===id);
  if (!item) return;
  detailItemId = id;
  _detailImgIdx = 0;
  const isOut = item.type === 'out';
  // Build nav list based on context
  if (navContext === 'featured') {
    // Use the actual rendered order from the Featured carousel
    _detailNavList = _featuredNavOrder.length ? [..._featuredNavOrder] : ideas.filter(i => !i.archived && !_isHiddenPrivate(i) && i.saved).map(i => i.id);
  } else if (navContext === 'latest') {
    _detailNavList = ideas.filter(i => !i.archived).map(i => i.id);
  } else if (navContext === 'out') {
    _detailNavList = ideas.filter(i => !i.archived && i.type === 'out').sort((a,b)=>a.name.localeCompare(b.name)).map(i => i.id);
  } else if (navContext === 'in') {
    _detailNavList = ideas.filter(i => !i.archived && i.type === 'in').sort((a,b)=>a.name.localeCompare(b.name)).map(i => i.id);
  } else if (navContext === 'newdate') {
    // All Out (alpha) + All In (alpha), respecting hidePrivate
    const byName = (a,b) => a.name.localeCompare(b.name);
    const outIds = ideas.filter(i => !i.archived && i.type === 'out' && !_isHiddenPrivate(i)).sort(byName).map(i => i.id);
    const inIds  = ideas.filter(i => !i.archived && i.type === 'in'  && !_isHiddenPrivate(i)).sort(byName).map(i => i.id);
    _detailNavList = outIds.concat(inIds);
  } else if (!navContext && _detailNavList.length === 0) {
    _detailNavList = ideas.filter(i => !i.archived).map(i => i.id);
  }

  // Title — links to Google Maps search for venue name
  const mapsSearchUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.name)}`;
  const titleEl = document.getElementById('detail-title');
  titleEl.textContent = item.name;
  titleEl.href = mapsSearchUrl;

  // Heart — gray outline when not saved, rose when saved (both In and Out)
  const heartBtn = document.getElementById('detail-heart-btn');
  const heartColor = item.saved ? ROSE : (document.body.classList.contains('dark-mode') ? '#524e4c' : '#ddd8d0');
  heartBtn.innerHTML = ICONS.heart(15, heartColor, false);

  // Subtitle
  const subtitle = document.getElementById('detail-subtitle');
  const cat = (item.category || '').toLowerCase();
  const label = catLabel(item.category || '');
  const showType = item.showType !== false;
  let subtitleText = '';
  if (cat === 'restaurant' || cat === 'cafe') {
    const base = item.cuisine ? `${item.cuisine} ${label}` : label;
    subtitleText = item.shortdesc ? `${base} • ${item.shortdesc}` : base;
  } else if (!showType) {
    subtitleText = item.shortdesc || '';
  } else {
    subtitleText = item.shortdesc ? `${label} • ${item.shortdesc}` : label;
  }
  subtitle.textContent = subtitleText;
  subtitle.style.display = subtitleText ? 'block' : 'none';

  // Seed 3-dot menu fav icon state
  updateDetailMenuFav();

  // Directions URL from home address
  const origin = encodeURIComponent(homeAddress || '');
  const dest = encodeURIComponent(item.address || item.name);
  const directionsUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=transit`;

  const plainRowTop = (iconHtml, content) =>
    `<div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:14px">
      <div style="margin-top:2px;flex-shrink:0">${iconHtml}</div>
      <span style="font-size:14px;font-family:sans-serif;color:#9a8a7a;line-height:1.5">${content}</span>
    </div>`;

  const pinIcon = `<svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>`;
  const infoIcon = `<svg viewBox="0 0 24 24" width="18" height="18" stroke="#9a8a7a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><circle cx="12" cy="12" r="10"/><line x1="12" y1="17" x2="12" y2="11"/><circle cx="12" cy="7" r="1.2" fill="#9a8a7a" stroke="none"/></svg>`;

  let body = '';

  // Image banner — write into separate slot above padded content
  const bannerSlot = document.getElementById('detail-banner');
  const bannerHtml = detailImageBanner(item);
  bannerSlot.innerHTML = bannerHtml;
  bannerSlot.style.display = bannerHtml ? 'block' : 'none';
  // Hide/show header buttons depending on whether image overlay has them
  const hdrBtns = document.getElementById('detail-header-btns');
  if (hdrBtns) hdrBtns.style.display = bannerHtml ? 'none' : 'flex';

  // Address — pin + text both link to directions from home
  if (isOut && item.address) {
    body += `<div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;margin-top:20px">
      <a href="${directionsUrl}" target="_blank" rel="noopener" style="display:flex;flex-shrink:0">${pinIcon}</a>
      <a href="${directionsUrl}" target="_blank" rel="noopener" style="font-size:14px;font-family:sans-serif;color:#9a8a7a;text-decoration:none">${item.address}</a>
    </div>`;
  }

  // About / description
  if (item.about) body += plainRowTop(infoIcon, item.about);

  // Bottom action buttons row
  const hasReservation = item.reservation && item.reservation !== 'none';
  if (item.archived) {
    const arrowIcon = `<svg viewBox="0 0 24 24" width="14" height="14" stroke="#c07a8a" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round" style="display:block;flex-shrink:0"><polyline points="15 18 9 12 15 6"/></svg>`;
    body += `<div style="margin-top:40px;display:flex;align-items:center;justify-content:center;gap:10px">
      <button onclick="unarchiveIdeaFromDetail(${item.id})" style="display:flex;align-items:center;gap:7px;padding:7px 16px;border:1.5px solid #c07a8a;border-radius:7px;font-family:sans-serif;font-size:13px;font-weight:600;color:#c07a8a;background:none;cursor:pointer;line-height:1">${arrowIcon}Unarchive</button>
    </div>`;
  } else if (isOut || hasReservation || _detailFromPopup) {
    const calIcon = `<svg viewBox="0 0 24 24" width="14" height="14" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="display:block;flex-shrink:0;vertical-align:middle;position:relative;top:-1px"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`;
    const resIcon = `<svg viewBox="0 0 24 24" width="14" height="14" stroke="#c07a8a" stroke-width="3.5" fill="none" stroke-linecap="round" stroke-linejoin="round" style="display:block;flex-shrink:0"><polyline points="20 6 9 17 4 12"/></svg>`;
    // Look up any upcoming date for this idea to include date/time in reservation URL
    const _ideaUpcoming = UPCOMING_DATES.find(u =>
      (u.ideaId && u.ideaId === item.id) ||
      (u.venue && item.name && u.venue.toLowerCase() === item.name.toLowerCase())
    );
    const _ideaDateStr = _ideaUpcoming ? _todoDateStr(_ideaUpcoming) : '';
    const _ideaTimeStr = _ideaUpcoming ? _todoTimeStr(_ideaUpcoming.time) : '';

    let leftBtn = '';
    if (hasReservation) {
      const resUrl = _buildResUrl(item.name, item.reservation, _ideaDateStr, _ideaTimeStr, item.eventbriteUrl, item.websiteUrl);
      const isWebsite = item.reservation === 'website';
      if (isWebsite && !resUrl) {
        // website with no URL — no button
      } else {
        const btnLabel = (item.reservation === 'resy' || item.reservation === 'opentable') ? 'Reserve' : 'Tickets';
        leftBtn = `<button onclick="_openExternal('${resUrl}')" style="display:flex;align-items:center;gap:7px;height:34px;padding:0 16px;border:1.5px solid #c07a8a;border-radius:17px;font-family:sans-serif;font-size:13px;font-weight:600;color:#c07a8a;background:none;cursor:pointer;line-height:1">${resIcon}${btnLabel}</button>`;
      }
    }

    let rightBtn = '';
    if (isOut || _detailFromPopup) {
      if (_detailFromPopup) {
        rightBtn = `<button onclick="selectIdeaFromDetail(${item.id})" style="display:flex;align-items:center;gap:7px;height:34px;padding:0 16px;border:none;border-radius:17px;font-family:sans-serif;font-size:13px;font-weight:600;color:#fff;background:#c07a8a;cursor:pointer;line-height:1">${calIcon}Select</button>`;
      } else if (isOut) {
        rightBtn = `<button onclick="planDateFromIdea(${item.id})" style="display:flex;align-items:center;gap:7px;height:34px;padding:0 16px;border:none;border-radius:17px;font-family:sans-serif;font-size:13px;font-weight:600;color:#fff;background:#c07a8a;cursor:pointer;line-height:1">${calIcon}Plan a Date</button>`;
      }
    }

    body += `<div style="margin-top:40px;display:flex;align-items:center;justify-content:center;gap:10px">
      ${leftBtn}${rightBtn}
    </div>`;
  }

  document.getElementById('detail-body').innerHTML = body;
  document.getElementById('detail-overlay').style.display = 'flex';
  document.body.classList.add('overlay-open');
  // Attach swipe navigation to the padded body (not the image banner)
  _attachInfoSwipe('detail-padded',
    () => { // swipe left → next idea
      const idx = _detailNavList.indexOf(detailItemId);
      if (idx < _detailNavList.length - 1) openDetail(_detailNavList[idx + 1]);
    },
    () => { // swipe right → prev idea
      const idx = _detailNavList.indexOf(detailItemId);
      if (idx > 0) openDetail(_detailNavList[idx - 1]);
    }
  );
}

function closeDetail() {
  const overlay = document.getElementById('detail-overlay');
  overlay.style.display = 'none';
  // Restore z-index if opened from popup context
  if (_detailFromPopup) {
    overlay.style.zIndex = '200';
    _detailFromPopup = false;
  }
  document.body.classList.remove('overlay-open');
  detailItemId = null;
}

function selectIdeaFromDetail(ideaId) {
  // Called when "Select" is tapped from detail popup opened on top of New Date sheet
  const item = ideas.find(i => i.id === ideaId);
  if (!item) return;
  closeDetail(); // closes detail, restores z-index
  // Apply to New Date sheet (same logic as selectActivity default branch)
  const accent = accentColor(item.type);
  selectedActivity = item;
  _dateIsPrivate = null;
  document.getElementById('date-activity-icon').innerHTML = ideaIcon(item, 16, accent);
  document.getElementById('date-activity-icon').style.display = '';
  document.getElementById('date-activity-label').textContent = item.name;
  document.getElementById('date-activity-label').style.fontSize = '';
  document.getElementById('date-activity-label').style.color = document.body.classList.contains('dark-mode') ? 'var(--text-primary)' : '#2a1f1f';
  document.getElementById('date-activity-btn').style.borderColor = accent;
  const _daib = document.getElementById('date-activity-info-btn');
  if (_daib) { _daib.style.display = 'flex'; _daib.dataset.ideaId = item.id; }
  document.getElementById('date-custom-wrap').style.display = 'none';
  document.getElementById('date-location-text-wrap').style.display = 'none';
  document.getElementById('date-neighborhood-wrap').style.display = 'none';
  _updateInLocationVisibility('date', item.type === 'in');
  document.getElementById('date-note').value = '';
  _renderPrivacyBox('date-lock-icon', 'date-privacy-box', _effectivePrivate(_dateIsPrivate, _dateIdeaIsPrivate()), _dateIsPrivate === null && _dateIdeaIsPrivate());
}

function planDateFromIdea(ideaId) {
  closeDetail();
  navigate('calendar');
  setTimeout(() => {
    renderDateSheetUI();
    const item = ideas.find(i => i.id === ideaId);
    if (item) {
      selectedActivity = item;
      const accent = accentColor(item.type);
      document.getElementById('date-activity-icon').innerHTML = ideaIcon(item, 16, accent);
      document.getElementById('date-activity-icon').style.display = '';
      document.getElementById('date-activity-label').textContent = item.name;
      document.getElementById('date-activity-label').style.fontSize = '';
      document.getElementById('date-activity-label').style.color = document.body.classList.contains('dark-mode') ? 'var(--text-primary)' : '#2a1f1f';
      document.getElementById('date-custom-wrap').style.display = 'none';
      document.getElementById('date-location-text-wrap').style.display = 'none';
      document.getElementById('date-neighborhood-wrap').style.display = 'none';
    }
    sheetMode = 'date';
  _dateIsPrivate = null;
  _renderPrivacyBox('date-lock-icon', 'date-privacy-box', _effectivePrivate(_dateIsPrivate, _dateIdeaIsPrivate()), _dateIsPrivate === null && _dateIdeaIsPrivate());
    sheetOpen = true;
    document.getElementById('idea-sheet').style.display = 'flex';
    document.getElementById('btn-new-circle').style.background = '#a05268';
    document.getElementById('btn-new-icon-plus').style.display = 'none';
    document.getElementById('btn-new-icon-check').style.display = 'block';
    setTimeout(() => { document.getElementById('sheet-overlay').style.display = 'block'; }, 0);
  }, 50);
}

function updateDetailMenuFav() {} // no-op, kept for safety

function closeDateInfo() {
  document.getElementById('date-info-overlay').style.display = 'none';
  document.body.classList.remove('overlay-open');
  currentDateInfo = null;
}

// Shared helpers for badge rendering
function buildSubwayBadgesHtml(subwayRoute) {
  let html = '';
  const toIdx = subwayRoute.toLowerCase().indexOf(' to ');
  const linesPart = toIdx >= 0 ? subwayRoute.substring(0, toIdx) : subwayRoute;
  const lines = [...new Set((linesPart.match(/\b[1-7ACEGJLNQRSWBDFMZ]\b/gi)||[]).map(l=>l.toUpperCase()))];
  const buses = [...new Set((linesPart.match(/\b[BMQ]\d+\b/gi)||[]).map(b=>b.toUpperCase()))];
  const timeMatch = subwayRoute.match(/~?\s*(\d+)\s*min/i);
  const stationMatch = subwayRoute.match(/to\s+(.+?)\s*~?\s*\d+\s*min/i);
  lines.forEach((line,i) => {
    const bg = MTA_COLORS[line]||'#808183';
    const tc = ['N','Q','R','W'].includes(line)?'#1F2937':'#fff';
    if(i>0) html+=`<span style="color:#b0a090;font-size:11px">›</span>`;
    html+=`<div style="width:20px;height:20px;border-radius:50%;background:${bg};display:flex;align-items:center;justify-content:center;color:${tc};font-size:11px;font-weight:700;font-family:sans-serif">${line}</div>`;
  });
  if(lines.length&&buses.length) html+=`<span style="color:#b0a090;font-size:11px">›</span>`;
  buses.forEach((bus,i)=>{
    if(i>0) html+=`<span style="color:#b0a090;font-size:11px">›</span>`;
    html+=`<div style="padding:2px 6px;border-radius:3px;background:#2e58ad;color:#fff;font-size:11px;font-weight:700;font-family:sans-serif">${bus}</div>`;
  });
  const station = stationMatch?stationMatch[1].trim():null;
  const time = timeMatch?timeMatch[1]:null;
  if(station||time) html+=`<span style="color:#9a8a7a;font-size:12px;font-family:sans-serif">${station&&time?station+' · '+time+' min':station||time+' min'}</span>`;
  return html;
}

function buildWalkDriveBadgesHtml(walkDriveTime) {
  let html = '';
  const walkMatch = walkDriveTime.match(/(\d+)\s*min\s*walk/i);
  const driveMatch = walkDriveTime.match(/(\d+)\s*min\s*drive/i);
  const personSvg = `<svg viewBox="0 0 24 24" width="13" height="13" fill="#9a8a7a"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/></svg>`;
  const carSvg = `<svg viewBox="0 0 24 24" width="13" height="13" fill="#9a8a7a"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>`;
  if(walkMatch) html+=`<span style="display:flex;align-items:center;gap:3px;font-size:12px;color:#9a8a7a;font-family:sans-serif">${personSvg}${walkMatch[1]} min</span>`;
  if(walkMatch&&driveMatch) html+=`<span style="color:#c8bfb6;font-size:12px">/</span>`;
  if(driveMatch) html+=`<span style="display:flex;align-items:center;gap:3px;font-size:12px;color:#9a8a7a;font-family:sans-serif">${carSvg}${driveMatch[1]} min</span>`;
  return html;
}


function openReserveLink(url, dateKey) {
  _openExternal(url);
  _reservedDateKeys.add(dateKey);
  _saveReserved();
  const btn = document.getElementById('di-reserve-btn');
  if (btn) {
    const chk = `<svg viewBox="0 0 24 24" width="16" height="16" stroke="#c07a8a" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`;
    btn.outerHTML = `<button id="di-reserve-btn" onclick="unreserveDate('${dateKey}')" style="display:flex;align-items:center;justify-content:center;width:26px;height:26px;border:1.5px solid #c07a8a;border-radius:50%;background:none;cursor:pointer"><svg viewBox="0 0 24 24" width="11" height="11" stroke="#c07a8a" stroke-width="3.5" fill="none" stroke-linecap="round" stroke-linejoin="round" style="display:block"><polyline points="20 6 9 17 4 12"/></svg></button>`;
  }
}

function unreserveDate(dateKey) {
  _reservedDateKeys.delete(dateKey);
  _saveReserved();
  if (currentDateInfo) openDateInfo(currentDateInfo);
}

function openDateInfo(u, memoryMode) {
  if (!u) return;
  // Normalize: if object uses dayShort:"Feb 28" instead of day/month, extract them
  if (!u.day && u.dayShort) {
    const parts = u.dayShort.split(' ');
    u = Object.assign({}, u, { month: parts[0], day: parseInt(parts[1]) });
  }
  currentDateInfo = u;

  // Image banner — in memoryMode use memory's own image URLs (own first, then idea's); else use matched idea's images
  const diBanner = document.getElementById('di-banner');
  const matchedIdeaForBanner = ideas.find(i => i.name && u.venue && i.name.toLowerCase() === u.venue.toLowerCase());
  const diImgUrls = memoryMode
    ? (u._memoryImageUrls && u._memoryImageUrls.length ? u._memoryImageUrls : (matchedIdeaForBanner ? (matchedIdeaForBanner.imageUrls || []).filter(Boolean) : []))
    : (matchedIdeaForBanner ? (matchedIdeaForBanner.imageUrls || []).filter(Boolean) : []);
  _diImgIdx = 0;
  _diImgUrlsActive = diImgUrls;
  // Build chronological nav list for date swiping
  _diNavList = [...UPCOMING_DATES].sort((a, b) => {
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const ya = a.year || 2026, yb = b.year || 2026;
    if (ya !== yb) return ya - yb;
    const ma = months.indexOf(a.month), mb = months.indexOf(b.month);
    if (ma !== mb) return ma - mb;
    return (a.day || 0) - (b.day || 0);
  });
  if (diImgUrls.length) {
    const pillStyle = 'background:rgba(0,0,0,0.38);border-radius:20px;display:flex;align-items:center;gap:2px;padding:3px 4px;opacity:0;transition:opacity 0.2s';
    const btn3Style = 'background:none;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:5px 4px;line-height:0';
    const btnXStyle = 'background:none;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:4px 5px;line-height:0';
    const slides = diImgUrls.map(u => `<div style="flex-shrink:0;width:100%;height:200px;scroll-snap-align:start;scroll-snap-stop:always;background:#6b2340"><img src="${u}" style="width:100%;height:100%;object-fit:cover;object-position:center;display:block" onerror="this.parentNode.style.background='#6b2340';this.style.display='none'"></div>`).join('');
    const arrowsPill = diImgUrls.length > 1 ? `
      <div id="di-pill-arrows" style="position:absolute;top:10px;left:10px;${pillStyle}">
        <button onclick="diImgNav(-1,event)" style="${btn3Style}">
          <svg viewBox="0 0 24 24" width="13" height="13" stroke="#fff" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <button onclick="diImgNav(1,event)" style="${btn3Style}">
          <svg viewBox="0 0 24 24" width="13" height="13" stroke="#fff" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </button>
      </div>` : '';
    const dotAction = memoryMode ? `openMemoryEdit(_currentMemoryInfoId);event.stopPropagation()` : `editDateFromInfo();event.stopPropagation()`;
    const controlsPill = `
      <div id="di-pill-controls" style="position:absolute;top:10px;right:10px;${pillStyle}">
        <button onclick="${dotAction}" style="${btn3Style}">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="#fff"><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg>
        </button>
        <button onclick="closeDateInfo();event.stopPropagation()" style="${btnXStyle}">
          <svg viewBox="0 0 24 24" width="16" height="16" stroke="#fff" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>`;
    diBanner.style.cssText = 'display:block;height:200px;border-radius:20px 20px 0 0;flex-shrink:0;position:relative;overflow:hidden';
    diBanner.innerHTML = `<div id="di-img-scroll" style="display:flex;height:200px;overflow-x:scroll;overflow-y:hidden;scrollbar-width:none;-ms-overflow-style:none;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;border-radius:20px 20px 0 0">${slides}</div>${arrowsPill}${controlsPill}`;
    diBanner.onmouseenter = () => { ['di-pill-arrows','di-pill-controls'].forEach(id => { const p=document.getElementById(id); if(p) p.style.opacity='1'; }); };
    diBanner.onmouseleave = () => { ['di-pill-arrows','di-pill-controls'].forEach(id => { const p=document.getElementById(id); if(p) p.style.opacity='0'; }); };
    const hdrBtns = document.getElementById('di-header-btns');
    if (hdrBtns) hdrBtns.style.display = 'none';
  } else {
    diBanner.style.display = 'none';
    diBanner.innerHTML = '';
    diBanner.onmouseenter = null;
    diBanner.onmouseleave = null;
    const hdrBtns = document.getElementById('di-header-btns');
    if (hdrBtns) hdrBtns.style.display = 'flex';
  }

  // Title in header
  const name = u.venue || u.name || 'Date';
  const diTitle = document.getElementById('di-title');
  if (!diTitle) return;
  diTitle.textContent = name;
  if (matchedIdeaForBanner) {
    diTitle.style.cursor = 'pointer';
    diTitle.style.textDecoration = '';
    diTitle.onclick = () => { closeDateInfo(); openDetail(matchedIdeaForBanner.id); };
  } else {
    diTitle.style.cursor = '';
    diTitle.style.textDecoration = '';
    diTitle.onclick = null;
  }

  // Wire header 3-dot button based on memoryMode
  const diEditBtn = document.getElementById('di-edit-btn');
  if (diEditBtn) {
    diEditBtn.onclick = memoryMode
      ? () => { closeDateInfo(); openMemoryEdit(_currentMemoryInfoId); }
      : () => editDateFromInfo();
  }

  // Heart next to title (rose, outline — no saved state for scheduled dates)

  // Subtitle: use matched idea's subtitle logic
  const subtitle = document.getElementById('di-subtitle');
  if (matchedIdeaForBanner) {
    const sub = itemSubLine(matchedIdeaForBanner);
    if (sub) { subtitle.textContent = sub; subtitle.style.display = 'block'; }
    else { subtitle.style.display = 'none'; }
  } else {
    const catVal = u.category || u.activity || '';
    if (catVal) { subtitle.textContent = catVal; subtitle.style.display = 'block'; }
    else { subtitle.style.display = 'none'; }
  }

  // Time + Date combined (e.g. "Sat Feb 7, 7:30pm")
  const timeRow = document.getElementById('di-time-row');
  if (u.time || u.day) {
    let dateTimeStr = '';
    if (u.day && u.month) {
      const monthNums = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
      const guessedYear = (monthNums[u.month] < new Date().getMonth() - 2) ? new Date().getFullYear()+1 : new Date().getFullYear();
      const displayYear = memoryMode ? (u.year || guessedYear) : null;
      const d = new Date(displayYear || guessedYear, monthNums[u.month] || 0, u.day);
      const dow = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
      dateTimeStr = memoryMode
        ? `${dow} ${u.month} ${u.day}, ${displayYear}`
        : `${dow} ${u.month} ${u.day}`;
    }
    if (u.time) dateTimeStr += (dateTimeStr ? ', ' : '') + u.time;
    document.getElementById('di-time').textContent = dateTimeStr;
    timeRow.style.display = 'flex';
  } else { timeRow.style.display = 'none'; }

  // Address — links to directions from home
  const addrVal = u.address || u.neighborhood || '';
  const addrRow = document.getElementById('di-address-row');
  if (addrVal) {
    const origin = encodeURIComponent(homeAddress || '');
    const dest = encodeURIComponent(addrVal);
    const dirUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=transit`;
    document.getElementById('di-address-pin-link').href = dirUrl;
    const addrLink = document.getElementById('di-address');
    addrLink.textContent = addrVal;
    addrLink.href = dirUrl;
    addrRow.style.display = 'flex';
  } else { addrRow.style.display = 'none'; }

  // Commute — pull from matched idea (subwayRoute / walkDriveTime live on idea, not date)
  const commuteIdea = ideas.find(i => i.name && u.venue && i.name.toLowerCase() === u.venue.toLowerCase());
  const skipCommute = u.inLocation === 'my_place' || (commuteIdea && commuteIdea.type === 'in' && !u.inLocation);
  const subwayVal = !skipCommute && commuteIdea ? (commuteIdea.subwayRoute || '') : '';
  const wdVal = !skipCommute && commuteIdea ? (commuteIdea.walkDriveTime || '') : '';
  const commuteRow = document.getElementById('di-commute-row');
  const commuteInner = document.getElementById('di-commute-inner');
  const leaveByRow = document.getElementById('di-leaveby-row');
  const dest = commuteIdea && commuteIdea.address ? commuteIdea.address.trim() : (u.address || u.venue || '');
  const origin = encodeURIComponent(homeAddress || '');
  const destEnc = encodeURIComponent(dest);
  function _mapsUrl(mode) { return `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destEnc}&travelmode=${mode}`; }

  let commuteMin = null;
  let commuteHtml = '';

  if (subwayVal) {
    const m = subwayVal.match(/~?\s*(\d+)\s*min/i);
    if (m) commuteMin = parseInt(m[1]);
    // Build subway badges as a clickable block (transit directions)
    const url = _mapsUrl('transit');
    const cursor = dest ? 'cursor:pointer' : '';
    const onclick = dest ? `onclick="event.stopPropagation();_openExternal('${url}')"` : '';
    commuteHtml += `<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;${cursor}" ${onclick}>${buildSubwayBadgesHtml(subwayVal)}</div>`;
  }

  if (wdVal) {
    const wm = wdVal.match(/(\d+)\s*min\s*walk/i);
    const dm = wdVal.match(/(\d+)\s*min\s*drive/i);
    if (!commuteMin) {
      if (wm) commuteMin = parseInt(wm[1]);
      else if (dm) commuteMin = parseInt(dm[1]);
    }
    const personSvg = `<svg viewBox="0 0 24 24" width="13" height="13" fill="#9a8a7a"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/></svg>`;
    const carSvg = `<svg viewBox="0 0 24 24" width="13" height="13" fill="#9a8a7a"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>`;
    if (wm && dm) {
      // Walk and drive: separate clickable spans
      const walkUrl = _mapsUrl('walking'), driveUrl = _mapsUrl('driving');
      const wc = dest ? `onclick="event.stopPropagation();_openExternal('${walkUrl}')" style="display:flex;align-items:center;gap:3px;font-size:12px;color:#9a8a7a;font-family:sans-serif;cursor:pointer"` : `style="display:flex;align-items:center;gap:3px;font-size:12px;color:#9a8a7a;font-family:sans-serif"`;
      const dc = dest ? `onclick="event.stopPropagation();_openExternal('${driveUrl}')" style="display:flex;align-items:center;gap:3px;font-size:12px;color:#9a8a7a;font-family:sans-serif;cursor:pointer"` : `style="display:flex;align-items:center;gap:3px;font-size:12px;color:#9a8a7a;font-family:sans-serif"`;
      commuteHtml += `<span ${wc}>${personSvg}${wm[1]} min</span><span style="color:#c8bfb6;font-size:12px">/</span><span ${dc}>${carSvg}${dm[1]} min</span>`;
    } else if (wm) {
      const walkUrl = _mapsUrl('walking');
      const wc = dest ? `onclick="event.stopPropagation();_openExternal('${walkUrl}')" style="display:flex;align-items:center;gap:3px;font-size:12px;color:#9a8a7a;font-family:sans-serif;cursor:pointer"` : `style="display:flex;align-items:center;gap:3px;font-size:12px;color:#9a8a7a;font-family:sans-serif"`;
      commuteHtml += `<span ${wc}>${personSvg}${wm[1]} min</span>`;
    } else if (dm) {
      const driveUrl = _mapsUrl('driving');
      const dc = dest ? `onclick="event.stopPropagation();_openExternal('${driveUrl}')" style="display:flex;align-items:center;gap:3px;font-size:12px;color:#9a8a7a;font-family:sans-serif;cursor:pointer"` : `style="display:flex;align-items:center;gap:3px;font-size:12px;color:#9a8a7a;font-family:sans-serif"`;
      commuteHtml += `<span ${dc}>${carSvg}${dm[1]} min</span>`;
    }
  }

  if (commuteHtml) {
    commuteInner.innerHTML = commuteHtml;
    commuteRow.style.display = 'block';
  } else {
    commuteRow.style.display = 'none';
  }

  // Leave by
  if (commuteMin && u.time) {
    const parsed = parseTimeInput(u.time);
    const tm = parsed.match(/(\d+):(\d+)\s*(am|pm)/i);
    if (tm) {
      let h = parseInt(tm[1]), mn = parseInt(tm[2]);
      if (tm[3].toLowerCase() === 'pm' && h !== 12) h += 12;
      if (tm[3].toLowerCase() === 'am' && h === 12) h = 0;
      const totalMin = h * 60 + mn - commuteMin - 10;
      const norm = ((totalMin % 1440) + 1440) % 1440;
      const lh = Math.floor(norm / 60), lm = norm % 60;
      const suf = lh >= 12 ? 'pm' : 'am';
      const lh12 = lh === 0 ? 12 : lh > 12 ? lh - 12 : lh;
      const leaveStr = lm === 0 ? `${lh12} ${suf}` : `${lh12}:${String(lm).padStart(2,'0')} ${suf}`;
      document.getElementById('di-leaveby-time').textContent = leaveStr;
      leaveByRow.style.display = 'block';
    } else { leaveByRow.style.display = 'none'; }
  } else { leaveByRow.style.display = 'none'; }

  // About
  const aboutVal = u.about || u.note || '';
  const aboutRow = document.getElementById('di-about-row');
  if (aboutVal) {
    document.getElementById('di-about').textContent = aboutVal;
    aboutRow.style.display = 'flex';
  } else { aboutRow.style.display = 'none'; }

  // Action buttons: Reserve + Edit Date (hidden in memoryMode)
  const btnsWrap = document.getElementById('di-btns-wrap');
  if (memoryMode) {
    btnsWrap.innerHTML = '';
    btnsWrap.style.display = 'none';
  } else {
  const matchedIdea = ideas.find(i => i.name && u.venue && i.name.toLowerCase() === u.venue.toLowerCase());
  const hasRes = matchedIdea && matchedIdea.reservation && matchedIdea.reservation !== 'none';
  const resIcon = `<svg viewBox="0 0 24 24" width="14" height="14" stroke="#c07a8a" stroke-width="3.5" fill="none" stroke-linecap="round" stroke-linejoin="round" style="display:block;flex-shrink:0"><polyline points="20 6 9 17 4 12"/></svg>`;
  const calIconDi = `<svg viewBox="0 0 24 24" width="14" height="14" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" style="display:block;flex-shrink:0;vertical-align:middle;position:relative;top:-1px"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`;

  let leftBtnDi = '';
  if (hasRes) {
    const resDateParam = (u.day && u.month) ? _todoDateStr(u) : '';
    const resTimeParam = u.time ? _todoTimeStr(u.time) : '';
    const resUrl2 = _buildResUrl(u.venue, matchedIdea.reservation, resDateParam, resTimeParam, matchedIdea.eventbriteUrl, matchedIdea.websiteUrl);
    if (matchedIdea.reservation !== 'website' || resUrl2) {
      const _dk = _dateKey(u);
      const _alreadyReserved = _reservedDateKeys.has(_dk);
      const _diLabel = (matchedIdea.reservation === 'resy' || matchedIdea.reservation === 'opentable') ? 'Reserve' : 'Tickets';
      leftBtnDi = _alreadyReserved
        ? `<button id="di-reserve-btn" onclick="unreserveDate('${_dk}')" style="display:flex;align-items:center;justify-content:center;width:26px;height:26px;border:1.5px solid #c07a8a;border-radius:50%;background:none;cursor:pointer"><svg viewBox="0 0 24 24" width="11" height="11" stroke="#c07a8a" stroke-width="3.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></button>`
        : `<button id="di-reserve-btn" onclick="openReserveLink('${resUrl2.replace(/'/g,"'")}','${_dk}')" style="display:flex;align-items:center;gap:7px;height:34px;padding:0 16px;border:none;border-radius:17px;font-family:sans-serif;font-size:13px;font-weight:600;color:#fff;background:#c07a8a;cursor:pointer;line-height:1"><svg viewBox="0 0 24 24" width="14" height="14" stroke="#fff" stroke-width="3.5" fill="none" stroke-linecap="round" stroke-linejoin="round" style="display:block;flex-shrink:0"><polyline points="20 6 9 17 4 12"/></svg>${_diLabel}</button>`;
    }
  }

  if (leftBtnDi) {
    btnsWrap.innerHTML = leftBtnDi;
    btnsWrap.style.display = 'flex';
  } else {
    btnsWrap.style.display = 'none';
  }
  }

  document.getElementById('date-info-overlay').style.display = 'flex';
  document.body.classList.add('overlay-open');
  // Attach swipe navigation to the padded body (not the image banner)
  _attachInfoSwipe('di-padded',
    () => { // swipe left → next date (later)
      const cur = currentDateInfo;
      const idx = _diNavList.findIndex(d => d.month === cur.month && d.day === cur.day && (d.year||2026) === (cur.year||2026));
      if (idx >= 0 && idx < _diNavList.length - 1) openDateInfo(_diNavList[idx + 1]);
    },
    () => { // swipe right → prev date (earlier)
      const cur = currentDateInfo;
      const idx = _diNavList.findIndex(d => d.month === cur.month && d.day === cur.day && (d.year||2026) === (cur.year||2026));
      if (idx > 0) openDateInfo(_diNavList[idx - 1]);
    }
  );
}

function toggleSavedCurrent() {
  if (!detailItemId) return;
  const item = ideas.find(i=>i.id===detailItemId);
  if (!item) return;
  item.saved = !item.saved;
  saveIdeas(ideas);
  const heartColor = item.saved ? ROSE : (document.body.classList.contains('dark-mode') ? '#524e4c' : '#ddd8d0');
  const heartBtn = document.getElementById('detail-heart-btn');
  if (heartBtn) heartBtn.innerHTML = ICONS.heart(15, heartColor, false);
  if (currentView === 'ideas') _renderIdeasBody();
  else render();
}

function toggleSaved(id) {
  const item = ideas.find(i=>i.id===id);
  if (item) { item.saved = !item.saved; saveIdeas(ideas); render(); }
}

function deleteIdea(id) {
  ideas = ideas.filter(i=>i.id!==id);
  saveIdeas(ideas);
  closeDetail();
  render();
}

let edSelectedActivity = null;
let ideasPickerContext = 'sheet'; // 'sheet' or 'editdate'
let edDateIdx = 0;

function editDateFromInfo() {
  if (!currentDateInfo) return;
  const u = currentDateInfo;
  closeDateInfo();
  openEditDateModal(u);
}

function openEditDateModal(u) {
  edSelectedActivity = null;

  // Find index in UPCOMING_DATES
  edDateIdx = UPCOMING_DATES.findIndex(d => d.day === u.day && d.month === u.month);
  if (edDateIdx < 0) edDateIdx = 0;
  updateEditDateNav();

  populateEditDateFields(u);
  document.getElementById('edit-date-overlay').style.display = 'flex';
}

function updateEditDateNav() {
  const hasMultiple = UPCOMING_DATES.length > 1;
  const atFirst = edDateIdx === 0;
  const atLast = edDateIdx === UPCOMING_DATES.length - 1;
  const prev = document.getElementById('ed-prev-btn');
  const next = document.getElementById('ed-next-btn');
  if (prev) { prev.style.opacity = (!hasMultiple || atFirst) ? '0.3' : '1'; prev.disabled = !hasMultiple || atFirst; }
  if (next) { next.style.opacity = (!hasMultiple || atLast) ? '0.3' : '1'; next.disabled = !hasMultiple || atLast; }
}

function editDateNav(dir) {
  const newIdx = edDateIdx + dir;
  if (newIdx < 0 || newIdx >= UPCOMING_DATES.length) return;
  edDateIdx = newIdx;
  updateEditDateNav();
  populateEditDateFields(UPCOMING_DATES[edDateIdx]);
}

function populateEditDateFields(u) {
  // Pre-fill activity from matched idea
  const matched = ideas.find(i => i.name && u.venue &&
    i.name.toLowerCase() === u.venue.toLowerCase());
  if (matched) {
    edSelectedActivity = matched;
    const accent = accentColor(matched.type);
    document.getElementById('ed-activity-icon').innerHTML = activityIcon(matched.category, 16, accent);
    document.getElementById('ed-activity-icon').style.display = '';
    document.getElementById('ed-activity-label').textContent = matched.name;
    document.getElementById('ed-activity-label').style.fontSize = '';
    document.getElementById('ed-activity-label').style.color = document.body.classList.contains('dark-mode') ? 'var(--text-primary)' : '#2a1f1f';
    document.getElementById('ed-activity-btn').style.borderColor = accent;
    document.getElementById('ed-custom-wrap').style.display = 'none';
    document.getElementById('ed-location-wrap').style.display = 'none';
    _updateInLocationVisibility('ed', matched.type === 'in');
    if (matched.type === 'in') {
      const sel = document.getElementById('ed-in-location-select');
      if (sel) sel.value = u.inLocation || 'my_place';
      onEdInLocationChange();
      const otherInp = document.getElementById('ed-in-location-other');
      if (otherInp) otherInp.value = u.inLocationOther || '';
    }
    _edUpdateActivityEditBtn(true);
  } else if (u.venue) {
    edSelectedActivity = { custom: true };
    document.getElementById('ed-activity-icon').innerHTML = '';
    document.getElementById('ed-activity-icon').style.display = 'none';
    document.getElementById('ed-activity-label').textContent = u.venue;
    document.getElementById('ed-activity-label').style.fontSize = '';
    document.getElementById('ed-activity-label').style.color = '#2a1f1f';
    document.getElementById('ed-custom-name').value = u.venue;
    document.getElementById('ed-custom-wrap').style.display = 'flex';
    document.getElementById('ed-location-wrap').style.display = 'block';
    _updateInLocationVisibility('ed', false);
    _edUpdateActivityEditBtn(false);
  } else {
    edSelectedActivity = null;
    document.getElementById('ed-activity-label').textContent = 'Date ideas…';
    document.getElementById('ed-activity-label').style.fontSize = '16px';
    document.getElementById('ed-activity-label').style.color = 'var(--text-placeholder)';
    document.getElementById('ed-activity-icon').innerHTML = '';
    document.getElementById('ed-activity-icon').style.display = 'none';
    document.getElementById('ed-custom-wrap').style.display = 'none';
    document.getElementById('ed-location-wrap').style.display = 'none';
    _updateInLocationVisibility('ed', false);
    _edUpdateActivityEditBtn(false);
  }

  // Pre-fill date
  const monthNums = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
  const mNum = monthNums[u.month];
  if (u.day && mNum !== undefined) {
    const yr = u.year || new Date().getFullYear();
    const pad = n => String(n).padStart(2,'0');
    const hiddenVal = `${yr}-${pad(mNum+1)}-${pad(u.day)}`;
    document.getElementById('ed-day').value = hiddenVal;
    const edText = document.getElementById('ed-day-text');
    if (edText) edText.value = `${pad(mNum+1)}/${pad(u.day)}/${String(yr).slice(-2)}`;
  } else {
    document.getElementById('ed-day').value = '';
    const edText = document.getElementById('ed-day-text');
    if (edText) edText.value = '';
  }
  setTimeout(() => { _buildPickerStrip('ed'); _initPickerStrip('ed'); }, 0);

  document.getElementById('ed-time').value = u.time || '';
  // For custom activity: ed-location = address stored in u.address, ed-neighborhood = u.neighborhood
  // For idea activity: location wrap is hidden, so values don't matter but pre-fill anyway
  document.getElementById('ed-location').value = u.address || '';
  if (document.getElementById('ed-neighborhood')) {
    document.getElementById('ed-neighborhood').value = u.neighborhood || '';
  }
  _edIsPrivate = u.isPrivate === true ? true : u.isPrivate === false ? false : null;
  _renderPrivacyBox('ed-lock-icon', 'ed-privacy-box', _effectivePrivate(_edIsPrivate, _edIdeaIsPrivate()), _edIsPrivate === null && _edIdeaIsPrivate());
  document.getElementById('ed-note').value = u.note || '';
  populateEdImageFields(u.imageUrls || []);
}

function openIdeasPickerForEdit() {
  ideasPickerContext = 'editdate';
  // Reuse existing picker but route callback back to edit modal
  openIdeasPicker();
}

function _edUpdateActivityEditBtn(visible) {
  const btn = document.getElementById('ed-activity-edit-btn');
  if (btn) btn.style.display = visible ? 'flex' : 'none';
}

function edEditActivityIdea(e) {
  if (e) e.stopPropagation();
  if (!edSelectedActivity || edSelectedActivity.custom) return;
  // Open Edit Idea on top of Edit Date (don't close Edit Date)
  window._editIdeaFromEditDate = true;
  const overlay = document.getElementById('places-overlay');
  if (overlay) overlay.style.zIndex = '420';
  openEditIdeaModal(edSelectedActivity.id);
}

// Open Idea Info (detail) on top of a popup (New Date / New To Do / Edit To Do)
let _detailFromPopup = false;
function openDetailFromActivity(infoBtnId, e) {
  if (e) e.stopPropagation();
  const btn = document.getElementById(infoBtnId);
  if (!btn) return;
  const ideaId = parseInt(btn.dataset.ideaId);
  if (!ideaId) return;
  _detailFromPopup = true;
  const overlay = document.getElementById('detail-overlay');
  if (overlay) overlay.style.zIndex = '600';
  openDetail(ideaId, 'newdate');
}

function closeEditDate() {
  document.getElementById('edit-date-overlay').style.display = 'none';
  ideasPickerContext = 'sheet';
  _editingMemory = null;
}

function saveEditDate() {
  const note = ((document.getElementById('ed-note') || {}).value || '').trim();
  const imageUrls = collectEdImageUrls();
  // Extract year from the date picker value (YYYY-MM-DD)
  const edDayVal = (document.getElementById('ed-day') || {}).value || '';
  const pickedYear = edDayVal ? parseInt(edDayVal.split('-')[0]) : null;
  const timeVal = ((document.getElementById('ed-time') || {}).value || '').trim();

  if (_editingMemory) {
    // Memory-mode: only update note/images/year
    let saved = {};
    try { saved = JSON.parse(localStorage.getItem('ll_memories') || '{}'); } catch(e) {}
    const extra = pickedYear ? { note, imageUrls, year: pickedYear } : { note, imageUrls };
    saved[String(_editingMemory.id)] = { ...(saved[String(_editingMemory.id)] || {}), ...extra };
    localStorage.setItem('ll_memories', JSON.stringify(saved));

    // Also update UPCOMING_DATES entry if it exists
    const u = UPCOMING_DATES.find(d => d.id === _editingMemory.id);
    if (u) {
      if (timeVal) u.time = timeVal;
      if (note) u.note = note;
      if (pickedYear && edDayVal) {
        const [,mm,dd] = edDayVal.split('-').map(Number);
        const MNAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        u.month = MNAMES[mm-1]; u.day = dd; u.year = pickedYear;
      }
      // Update venue/neighborhood if activity changed
      const isCustom = edSelectedActivity && edSelectedActivity.custom;
      if (edSelectedActivity && !isCustom) {
        u.venue = edSelectedActivity.name;
        u.activity = edSelectedActivity.category;
        u.neighborhood = _ideaNeighborhood(edSelectedActivity);
        _applyEdInLocation(u);
      } else if (isCustom) {
        const cName = ((document.getElementById('ed-custom-name') || {}).value || '').trim();
        const locText = ((document.getElementById('ed-location') || {}).value || '').trim();
        const neighText = ((document.getElementById('ed-neighborhood') || {}).value || '').trim();
        if (cName) u.venue = cName;
        u.neighborhood = neighText || _neighborhoodFromAddress(locText) || locText;
      }
      saveDates(UPCOMING_DATES);
      FUTURE_DATES = buildFutureDates();
    }
  } else {
    // Future/upcoming date mode — update via edDateIdx
    const u = UPCOMING_DATES[edDateIdx];
    if (u) {
      if (timeVal) u.time = timeVal;
      if (note !== undefined) u.note = note;
      if (pickedYear && edDayVal) {
        const [,mm,dd] = edDayVal.split('-').map(Number);
        const MNAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        u.month = MNAMES[mm-1]; u.day = dd; u.year = pickedYear;
      }
      // Update venue/neighborhood if activity changed
      const isCustom = edSelectedActivity && edSelectedActivity.custom;
      if (edSelectedActivity && !isCustom) {
        u.venue = edSelectedActivity.name;
        u.activity = edSelectedActivity.category;
        u.neighborhood = _ideaNeighborhood(edSelectedActivity);
        _applyEdInLocation(u);
      } else if (isCustom) {
        const cName = ((document.getElementById('ed-custom-name') || {}).value || '').trim();
        const locText = ((document.getElementById('ed-location') || {}).value || '').trim();
        const neighText = ((document.getElementById('ed-neighborhood') || {}).value || '').trim();
        if (cName) u.venue = cName;
        u.neighborhood = neighText || _neighborhoodFromAddress(locText) || locText;
      }
      u.isPrivate = _edIsPrivate;  // null = inherit from idea
      saveDates(UPCOMING_DATES);
      FUTURE_DATES = buildFutureDates();
      if (dateIdx >= FUTURE_DATES.length) dateIdx = Math.max(0, FUTURE_DATES.length - 1);
    }
  }
  closeEditDate();
  render();
  // Refresh Date Info popup if open — re-open with updated data
  if (currentDateInfo && _currentMemoryInfoId) {
    openMemoryInfo(_currentMemoryInfoId);
  }
}

function deleteEditDate() {
  if (_editingMemory && _editingMemory.id) {
    // Memory/past-date mode: remove by id
    const idx = UPCOMING_DATES.findIndex(u => u.id === _editingMemory.id);
    if (idx !== -1) {
      UPCOMING_DATES.splice(idx, 1);
      saveDates(UPCOMING_DATES);
      FUTURE_DATES = buildFutureDates();
      if (dateIdx >= FUTURE_DATES.length) dateIdx = Math.max(0, FUTURE_DATES.length - 1);
    }
  } else {
    // Upcoming date mode: remove by edDateIdx
    if (edDateIdx >= 0 && edDateIdx < UPCOMING_DATES.length) {
      UPCOMING_DATES.splice(edDateIdx, 1);
      u.isPrivate = _edIsPrivate;  // null = inherit from idea
      saveDates(UPCOMING_DATES);
      FUTURE_DATES = buildFutureDates();
      if (dateIdx >= FUTURE_DATES.length) dateIdx = Math.max(0, FUTURE_DATES.length - 1);
    }
  }
  closeEditDate();
  render();
}

function editIdea(id) {
  closeDetail();
  // Filter to same-type ideas for nav
  const item = ideas.find(i=>i.id===id);
  if (!item) return;
  openEditIdeaModal(id);
}

function openEditIdeaModal(id) {
  const item = ideas.find(i=>i.id===id);
  if (!item) return;
  // Store current edit id
  window._editModalId = id;
  // Build nav list: ideas of the same type
  window._editModalList = ideas.filter(i=>i.type===item.type).map(i=>i.id);

  populateEditModal(item);
  updateEditModalNav();
  document.getElementById('places-overlay').style.display = 'flex';
}

function populateEditModal(item) {
  const isOut = item.type === 'out';
  // Title
  document.getElementById('places-modal-title').textContent = 'Edit Idea';

  // Heart
  document.getElementById('places-heart-btn').innerHTML = ICONS.heart(18, ROSE, item.saved);

  // Selector — show all ideas of same type
  const sel = document.getElementById('places-select');
  const list = ideas.filter(i=>i.type===item.type);
  sel.innerHTML = '';
  list.forEach(i => {
    const o = document.createElement('option');
    o.value = i.id;
    o.textContent = i.name + (i.saved ? ' ♥︎' : '');
    sel.appendChild(o);
  });
  sel.value = item.id;

  // Swap pf-type options based on Out vs In — built from cats + Edit sentinel
  const typeSelect = document.getElementById('pf-type');
  window._pfTypeMode = isOut ? 'out' : 'in';
  _rebuildPfTypeSelect(isOut ? 'out' : 'in');
  typeSelect.value = item.category || (isOut ? OUT_CATS[0].id : IN_CATS[0].id);
  window._pfPrevCat = typeSelect.value;

  // Type icon — load custom icon key and display
  _pfCustomIconKey = item.customIconKey || null;
  _updatePfTypeIcon();

  // Name field: update placeholder based on type
  document.getElementById('pf-name').placeholder = isOut ? 'Place / activity' : 'Activity';
  const pfNameIcon = document.getElementById('pf-name-icon');
  if (pfNameIcon) pfNameIcon.innerHTML = isOut ? ICONS.building(18,'#9a8a7a') : ICONS.sofa(18,'#9a8a7a');

  // Form fields
  _pfIsPrivate = !!item.isPrivate;
  _renderLockBtn('pf-lock-btn', _pfIsPrivate);
  document.getElementById('pf-name').value = item.name || '';
  document.getElementById('pf-cuisine').value = item.cuisine || '';
  document.getElementById('pf-address').value = item.address || '';
  if (document.getElementById('pf-neighborhood')) document.getElementById('pf-neighborhood').value = item.neighborhood || '';
  document.getElementById('pf-subway').value = item.subwayRoute || '';
  document.getElementById('pf-walkdrive').value = item.walkDriveTime || '';
  document.getElementById('pf-about').value = item.about || '';
  document.getElementById('pf-reservation').value = item.reservation || 'resy';
  document.getElementById('pf-eventbrite-url').value = item.eventbriteUrl || '';
  const pfWebUrl = document.getElementById('pf-website-url');
  if (pfWebUrl) { pfWebUrl.value = item.websiteUrl || ''; }
  const pfWebWrap = document.getElementById('pf-website-wrap');
  if (pfWebWrap) pfWebWrap.style.display = (item.reservation === 'website') ? 'block' : 'none';

  // Show/hide Out-only fields
  if (document.getElementById('pf-shortdesc')) document.getElementById('pf-shortdesc').value = item.shortdesc || '';
  const pfShowType = document.getElementById('pf-showtype');
  if (pfShowType) pfShowType.checked = item.showType !== false;
  const cuisineTypes2 = ['restaurant','cafe'];
  const pfCuisine = document.getElementById('pf-cuisine-wrap');
  const pfShortdesc = document.getElementById('pf-shortdesc-wrap');
  const pfAddress = document.getElementById('pf-address-row');
  const pfReservation = document.getElementById('pf-reservation-wrap');
  if (pfCuisine) pfCuisine.style.display = (isOut && cuisineTypes2.includes(item.category)) ? 'flex' : 'none';
  if (pfShortdesc) pfShortdesc.style.display = 'flex';
  const pfAbout = document.getElementById('pf-about-wrap');
  if (pfAbout) pfAbout.style.display = 'flex';
  if (pfAddress) pfAddress.style.display = isOut ? 'flex' : 'none';
  const pfNeighRow = document.getElementById('pf-neighborhood-row');
  if (pfNeighRow) pfNeighRow.style.display = isOut ? 'flex' : 'none';
  if (pfReservation) pfReservation.style.display = isOut ? 'block' : 'none';

  // Subway/walkdrive rows only for Out
  ['pf-subway-row','pf-walkdrive-row'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = isOut ? 'block' : 'none';
  });

  onReservationChange();
  renderSubwayBadges();
  renderWalkDriveBadges();
  const imagesWrap = document.getElementById('pf-images-wrap');
  if (imagesWrap) imagesWrap.style.display = 'flex';
  populatePfImageFields(item);

  // Remove / Unarchive btn
  const removeBtn = document.getElementById('places-delete-btn');
  removeBtn.disabled = false;
  removeBtn.style.opacity = '1';
  if (item.archived) {
    removeBtn.textContent = 'Unarchive';
    removeBtn.onclick = () => {
      item.archived = false;
      saveIdeas(ideas);
      closePlaces();
      render();
    };
  } else {
    removeBtn.textContent = 'Remove';
    removeBtn.onclick = promptRemoveIdea;
  }
}

function updateEditModalNav() {
  const list = window._editModalList || [];
  const hasMultiple = list.length > 1;
  document.getElementById('places-prev-btn').style.opacity = hasMultiple ? '1' : '0.3';
  document.getElementById('places-next-btn').style.opacity = hasMultiple ? '1' : '0.3';
  document.getElementById('places-prev-btn').disabled = !hasMultiple;
  document.getElementById('places-next-btn').disabled = !hasMultiple;
}

function handlePlaceSelect(val) {
  const id = parseInt(val);
  window._editModalId = id;
  window._editModalList = ideas.filter(i => {
    const cur = ideas.find(x=>x.id===id);
    return cur && i.type === cur.type;
  }).map(i=>i.id);
  const item = ideas.find(i=>i.id===id);
  if (item) populateEditModal(item);
}

function togglePlaceTopChoice() {
  const id = window._editModalId;
  const item = ideas.find(i=>i.id===id);
  if (!item) return;
  item.saved = !item.saved;
  saveIdeas(ideas);
  document.getElementById('places-heart-btn').innerHTML = ICONS.heart(18, ROSE, item.saved);
  // Refresh selector label
  const sel = document.getElementById('places-select');
  const opt = sel.querySelector(`option[value="${id}"]`);
  if (opt) opt.textContent = item.name + (item.saved ? ' ♥︎' : '');
  render();
}

function savePlace() {
  const id = window._editModalId;
  const item = ideas.find(i=>i.id===id);
  if (!item) return;
  const isOut = item.type === 'out';
  const oldName = item.name; // capture before overwrite
  item.name          = document.getElementById('pf-name').value.trim() || item.name;
  item.category      = document.getElementById('pf-type').value;
  const _defaultIconForSave = _ideaDefaultIconKey(item.category);
  item.customIconKey = (_pfCustomIconKey && _pfCustomIconKey !== _defaultIconForSave) ? _pfCustomIconKey : undefined;
  item.about         = document.getElementById('pf-about').value.trim();
  item.note          = item.about;
  item.shortdesc     = (document.getElementById('pf-shortdesc') || {value:''}).value.trim();
  item.showType      = (document.getElementById('pf-showtype') || {checked:true}).checked;
  if (isOut) {
    item.cuisine      = document.getElementById('pf-cuisine').value.trim();
    const newAddr     = document.getElementById('pf-address').value.trim();
    const newNeigh    = (document.getElementById('pf-neighborhood') || {value:''}).value.trim();
    const addrChanged = newAddr !== item.address || newNeigh !== (item.neighborhood || '');
    item.address      = newAddr;
    item.neighborhood = newNeigh;
    item.subwayRoute  = document.getElementById('pf-subway').value.trim();
    item.walkDriveTime= document.getElementById('pf-walkdrive').value.trim();
    item.reservation  = document.getElementById('pf-reservation').value;
    item.eventbriteUrl= document.getElementById('pf-eventbrite-url').value.trim();
    item.websiteUrl   = item.reservation === 'website' ? (document.getElementById('pf-website-url')||{value:''}).value.trim() : '';

    // Sync address/name/neighborhood change to any UPCOMING_DATES referencing this idea
    if (addrChanged || item.name !== oldName) {
      UPCOMING_DATES.forEach(u => {
        if (u.venue === oldName) {
          if (item.name !== oldName) u.venue = item.name;
          if (addrChanged) u.neighborhood = _ideaNeighborhood(item);
        }
      });
      saveDates(UPCOMING_DATES);
      FUTURE_DATES = buildFutureDates();
    }
  }
  item.isPrivate = !!_pfIsPrivate;
  item.imageUrls = collectPfImageUrls();
  saveIdeas(ideas);
  const savedId = id;
  const fromEditDate = !!window._editIdeaFromEditDate;
  closePlaces();
  render();
  // Re-open Idea Info popup only if not coming from Edit Date context
  if (!fromEditDate) openDetail(savedId);
}

function promptRemoveIdea() {
  document.getElementById('remove-confirm-overlay').style.display = 'flex';
}

function closeRemoveConfirm() {
  document.getElementById('remove-confirm-overlay').style.display = 'none';
}

function confirmArchiveIdea() {
  const id = window._editModalId;
  if (!id) return;
  const item = ideas.find(i => i.id === id);
  if (item) { item.archived = true; saveIdeas(ideas); }
  closeRemoveConfirm();
  closePlaces();
  render();
}

function unarchiveIdeaFromDetail(id) {
  const item = ideas.find(i => i.id === id);
  if (item) { item.archived = false; saveIdeas(ideas); }
  closeDetail();
  render();
}

function confirmDeleteIdea() {
  const id = window._editModalId;
  deleteIdea(id);
  closeRemoveConfirm();
  closePlaces();
}

function deletePlace() {
  const id = window._editModalId;
  deleteIdea(id);
  closePlaces();
}

function renderArchive() {
  const archived = ideas.filter(i => i.archived);
  if (!archived.length) {
    return `<div style="padding:60px 20px;text-align:center;color:#b0a090;font-size:15px;font-style:italic">No archived ideas yet.</div>`;
  }
  const out = archived.filter(i => i.type === 'out');
  const inIdeas = archived.filter(i => i.type === 'in');
  const byName = (a,b) => a.name.localeCompare(b.name);

  function section(items, type) {
    if (!items.length) return '';
    const accent = accentColor(type);
    const label = type === 'out' ? 'Going Out' : 'Staying In';
    return `<div style="margin-bottom:20px">
      <div style="font-size:11px;font-weight:700;letter-spacing:.08em;color:#b0a090;font-family:sans-serif;text-transform:uppercase;margin-bottom:8px">${label}</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        ${items.sort(byName).map(item => renderQuickRow(item)).join('')}
      </div>
    </div>`;
  }

  return `<div style="padding:12px 20px 80px">${section(out,'out')}${section(inIdeas,'in')}</div>`;
}


function placesNav(dir) {
  const list = window._editModalList || [];
  if (list.length < 2) return;
  const idx = list.indexOf(window._editModalId);
  let next;
  if (dir === -1) next = idx <= 0 ? list.length - 1 : idx - 1;
  else            next = idx >= list.length - 1 ? 0 : idx + 1;
  window._editModalId = list[next];
  const item = ideas.find(i=>i.id===window._editModalId);
  if (item) populateEditModal(item);
  document.getElementById('places-select').value = window._editModalId;
}

// ═══════════════════════════════════════════════════════
// SETTINGS
// ═══════════════════════════════════════════════════════
function openSettings() {
  document.getElementById('settings-home-address').value = homeAddress;
  const hpCb = document.getElementById('settings-hide-private');
  if (hpCb) hpCb.checked = hidePrivate;
  document.getElementById('settings-partner-address').value = partnerAddress;
  document.getElementById('settings-pronouns').value = partnerPronouns;
  const customWrap = document.getElementById('settings-pronouns-custom-wrap');
  if (customWrap) customWrap.style.display = partnerPronouns === 'other' ? 'block' : 'none';
  if (partnerPronouns === 'other') document.getElementById('settings-pronouns-custom').value = partnerPronounsCustom;
  document.getElementById('settings-overlay').style.display = 'flex';
  // Sync radio buttons to current appearance
  setTimeout(() => _applyAppearance(_appearance), 0);
}
function onPronounsChange() {
  const val = document.getElementById('settings-pronouns').value;
  const wrap = document.getElementById('settings-pronouns-custom-wrap');
  if (wrap) wrap.style.display = val === 'other' ? 'block' : 'none';
}
function closeSettings() {
  document.getElementById('settings-overlay').style.display = 'none';
}
function saveSettingsData() {
  homeAddress = document.getElementById('settings-home-address').value.trim();
  appSettings.homeAddress = homeAddress;
  partnerAddress = document.getElementById('settings-partner-address').value.trim();
  appSettings.partnerAddress = partnerAddress;
  partnerPronouns = document.getElementById('settings-pronouns').value;
  appSettings.partnerPronouns = partnerPronouns;
  if (partnerPronouns === 'other') {
    partnerPronounsCustom = document.getElementById('settings-pronouns-custom').value.trim();
    appSettings.partnerPronounsCustom = partnerPronounsCustom;
  }
  const hpEl = document.getElementById('settings-hide-private');
  if (hpEl) { hidePrivate = hpEl.checked; appSettings.hidePrivate = hidePrivate; }
  // Save appearance
  localStorage.setItem('duet_appearance', _appearance);
  saveSettings(appSettings);
  // Update "Her place" option label in location dropdowns
  _updatePartnerPlaceOptions();
  closeSettings();
}
function _updatePartnerPlaceOptions() {
  const label = partnerPlaceLabel();
  document.querySelectorAll('#date-location-select option[value="Her place"], #date-location-select option[value$=" place"]').forEach(opt => {
    opt.value = label; opt.textContent = label;
  });
}

// ═══════════════════════════════════════════════════════
// FAVORITE PLACES
// ═══════════════════════════════════════════════════════
function closePlaces() {
  const overlay = document.getElementById('places-overlay');
  overlay.style.display = 'none';
  overlay.style.zIndex = '400'; // reset
  closeRemoveConfirm();
  // If opened from Edit Date, refresh the activity field with updated idea data
  if (window._editIdeaFromEditDate) {
    window._editIdeaFromEditDate = false;
    if (edSelectedActivity && !edSelectedActivity.custom) {
      const updated = ideas.find(i => i.id === edSelectedActivity.id);
      if (updated) {
        edSelectedActivity = updated;
        const accent = accentColor(updated.type);
        document.getElementById('ed-activity-icon').innerHTML = activityIcon(updated.category, 16, accent);
        document.getElementById('ed-activity-icon').style.display = '';
        document.getElementById('ed-activity-label').textContent = updated.name;
        document.getElementById('ed-activity-label').style.fontSize = '';
        document.getElementById('ed-activity-label').style.color = '#2a1f1f';
        document.getElementById('ed-activity-btn').style.borderColor = accent;
      }
    }
  }
}

// ═══════════════════════════════════════════════════════
// HAMBURGER MENU

// HAMBURGER MENU
// ═══════════════════════════════════════════════════════
function toggleMenu() {
  const overlay = document.getElementById('nav-menu-overlay');
  const dropdown = document.getElementById('nav-menu-dropdown');
  const isOpen = dropdown.style.display === 'block';
  overlay.style.display = isOpen ? 'none' : 'block';
  dropdown.style.display = isOpen ? 'none' : 'block';
}
function closeMenu() {
  document.getElementById('nav-menu-overlay').style.display = 'none';
  document.getElementById('nav-menu-dropdown').style.display = 'none';
}

async function exportAllData() {
  const data = {
    exportedAt: new Date().toISOString(),
    ideas: ideas,
    upcomingDates: UPCOMING_DATES,
    staticPastDates: STATIC_PAST_DATES,
    memoryNotes: (() => { try { return JSON.parse(localStorage.getItem('ll_memories') || '{}'); } catch(e) { return {}; } })(),
    todos: todos,
    settings: {
      homeAddress: homeAddress,
      partnerAddress: partnerAddress,
      partnerPronouns: partnerPronouns,
      partnerPronounsCustom: partnerPronounsCustom,
      hidePrivate: hidePrivate,
      appearance: _appearance,
    },
    appearance: _appearance,
  };
  const json = JSON.stringify(data, null, 2);
  const filename = 'duet-' + new Date().toISOString().slice(0,10) + '.json';
  if (window.showSaveFilePicker) {
    try {
      const fh = await window.showSaveFilePicker({
        suggestedName: filename,
        types: [{ description: 'JSON file', accept: { 'application/json': ['.json'] } }]
      });
      const writable = await fh.createWritable();
      await writable.write(json);
      await writable.close();
      return;
    } catch(e) {
      if (e.name === 'AbortError') return;
    }
  }
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 1000);
}
// ═══════════════════════════════════════════════════════
// EDIT CATEGORIES
// ═══════════════════════════════════════════════════════
let _ecType = 'out';
let _ecOut = [];
let _ecIn  = [];
let _ecDragIdx = null;
let _ecDragOverIdx = null;
let _ecDelIdx = null;
let _ecIconIdx = null;
let _ecIconSelected = null;
let _ecIconPrev = null;
let _ideaIconMode = false; // true when icon picker opened from Edit Idea
let _pfCustomIconKey = null; // temp custom icon key while editing an idea (Edit Idea modal)
let _ideaCustomIconKey = null; // temp custom icon key for New Idea sheet
let _ideaIconNewMode = false; // true when icon picker opened from New Idea sheet

function openEditCategories(startType) {
  _ecOut = OUT_CATS.map(c => ({...c}));
  _ecIn  = IN_CATS.map(c => ({...c}));
  _ecType = (startType === 'in') ? 'in' : 'out';
  _renderEcToggle();
  _renderEcList();
  document.getElementById('editcats-overlay').style.display = 'flex';
}
function closeEditCategories() {
  document.getElementById('editcats-overlay').style.display = 'none';
}
function editCatsSetType(t) {
  // Flush current input values before switching
  _flushEcNames();
  _ecType = t;
  _renderEcToggle();
  _renderEcList();
}
function _ecCats() { return _ecType === 'in' ? _ecIn : _ecOut; }
function _ecSetCats(arr) { if (_ecType === 'in') _ecIn = arr; else _ecOut = arr; }
function _flushEcNames() {
  const cats = _ecCats();
  cats.forEach((c, i) => {
    const inp = document.getElementById(`ec-name-${i}`);
    if (inp) c.label = inp.value.trim() || c.label;
  });
}
function _renderEcToggle() {
  const btnOut = document.getElementById('editcats-btn-out');
  const btnIn  = document.getElementById('editcats-btn-in');
  if (!btnOut || !btnIn) return;
  const isOut = _ecType === 'out';
  btnOut.style.background    = isOut ? 'var(--toggle-active-bg)' : 'transparent';
  btnOut.style.color         = isOut ? 'var(--toggle-active-color)' : 'var(--text-secondary)';
  btnOut.style.boxShadow     = isOut ? '0 1px 3px rgba(0,0,0,0.1)' : 'none';
  btnIn.style.background     = !isOut ? 'var(--toggle-active-bg)' : 'transparent';
  btnIn.style.color          = !isOut ? 'var(--toggle-active-color)' : 'var(--text-secondary)';
  btnIn.style.boxShadow      = !isOut ? '0 1px 3px rgba(0,0,0,0.1)' : 'none';
}
function _renderEcList() {
  const list = document.getElementById('editcats-list');
  if (!list) return;
  const cats = _ecCats();
  list.innerHTML = cats.map((cat, i) => {
    const iconSvg = ICONS[cat.iconKey] ? ICONS[cat.iconKey](18,'#9a8a7a') : ICONS.wine(18,'#9a8a7a');
    return `<div id="ec-row-${i}" class="ec-row" draggable="true"
      ondragstart="_ecDragStart(event,${i})" ondragover="_ecDragOver(event,${i})"
      ondragend="_ecDragEnd(event)" ondrop="_ecDrop(event,${i})"
      style="display:flex;align-items:center;gap:10px;padding:10px 2px;border-bottom:1px solid #f0ede8;user-select:none">
      <div style="cursor:grab;padding:2px 4px;flex-shrink:0;color:#c8bfb8;touch-action:none" id="ec-handle-${i}">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="8" y1="7" x2="16" y2="7"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="8" y1="17" x2="16" y2="17"/>
        </svg>
      </div>
      <button onclick="_openIconPicker(${i})" style="background:none;border:none;cursor:pointer;padding:2px;flex-shrink:0;display:flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:6px" title="Change icon">
        ${iconSvg}
      </button>
      <input id="ec-name-${i}" value="${_escAttr(cat.label)}"
        oninput="_ecUpdateName(${i},this.value)"
        style="flex:1;border:none;background:transparent;font-size:15px;font-family:sans-serif;color:#2a1f1f;outline:none;padding:3px 0;min-width:0;cursor:text"
        onclick="this.select()">
      <button onclick="_openDelCat(${i})" style="background:none;border:none;cursor:pointer;padding:5px;flex-shrink:0;display:flex" title="Delete">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="#c07a8a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
          <path d="M10 11v6"/><path d="M14 11v6"/>
          <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
        </svg>
      </button>
    </div>`;
  }).join('') + `
    <button onclick="_ecAddNew()"
      style="margin-top:12px;width:100%;padding:10px;background:none;border:1px dashed #9a8a7a;border-radius:8px;font-family:sans-serif;font-size:14px;color:#9a8a7a;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px">
      <svg viewBox="0 0 24 24" width="14" height="14" stroke="#9a8a7a" stroke-width="2.5" fill="none" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      New Category
    </button>`;
  _initEcTouchDrag();
}
function _escAttr(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;');
}
function _ecUpdateName(i, val) {
  const cats = _ecCats(); if (cats[i]) cats[i].label = val;
}
function _ecAddNew() {
  _flushEcNames();
  const cats = _ecCats();
  const newId = 'cat_' + Date.now();
  cats.push({id: newId, label: 'New category', iconKey: 'wine'});
  _ecSetCats(cats);
  _renderEcList();
  const idx = cats.length - 1;
  const inp = document.getElementById(`ec-name-${idx}`);
  if (inp) { inp.focus(); inp.select(); }
  const listEl = document.getElementById('editcats-list');
  if (listEl) setTimeout(() => { listEl.scrollTop = listEl.scrollHeight; }, 0);
}

// ── Mouse drag-and-drop ──────────────────────────────
function _ecDragStart(e, i) {
  _ecDragIdx = i;
  e.dataTransfer.effectAllowed = 'move';
  setTimeout(() => { const r = document.getElementById(`ec-row-${i}`); if(r) r.style.opacity='0.4'; }, 0);
}
function _ecDragOver(e, i) {
  e.preventDefault();
  if (_ecDragOverIdx !== i) {
    _ecDragOverIdx = i;
    document.querySelectorAll('.ec-row').forEach((r, ri) => {
      const _dmEc = document.body.classList.contains('dark-mode');
      r.style.borderTop = (ri === i && i !== _ecDragIdx) ? `2px solid ${_dmEc ? ROSE : BURGUNDY}` : '';
    });
  }
}
function _ecDrop(e, i) {
  e.preventDefault();
  if (_ecDragIdx === null || _ecDragIdx === i) return;
  _flushEcNames();
  const cats = _ecCats();
  const moved = cats.splice(_ecDragIdx, 1)[0];
  cats.splice(i, 0, moved);
  _ecSetCats(cats);
  _renderEcList();
}
function _ecDragEnd() {
  document.querySelectorAll('.ec-row').forEach(r => { r.style.opacity=''; r.style.borderTop=''; });
  _ecDragIdx = null; _ecDragOverIdx = null;
}

// ── Touch drag-and-drop ──────────────────────────────
function _initEcTouchDrag() {
  const list = document.getElementById('editcats-list');
  if (!list) return;
  list.querySelectorAll('[id^="ec-handle-"]').forEach((handle, i) => {
    let clone = null, startY = 0, lastOverIdx = null, srcRow = null;
    handle.addEventListener('touchstart', e => {
      e.preventDefault();
      srcRow = document.getElementById(`ec-row-${i}`);
      startY = e.touches[0].clientY;
      srcRow.style.opacity = '0.4';
      clone = srcRow.cloneNode(true);
      const rect = srcRow.getBoundingClientRect();
      Object.assign(clone.style, {
        position:'fixed', left:rect.left+'px', top:rect.top+'px',
        width:rect.width+'px', opacity:'0.9', background:'#fff',
        borderRadius:'8px', boxShadow:'0 4px 20px rgba(0,0,0,0.18)',
        pointerEvents:'none', zIndex:'9999', transition:'none'
      });
      document.body.appendChild(clone);
    }, {passive:false});
    handle.addEventListener('touchmove', e => {
      if (!clone || !srcRow) return;
      e.preventDefault();
      const dy = e.touches[0].clientY - startY;
      clone.style.top = (srcRow.getBoundingClientRect().top + dy) + 'px';
      const el = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY);
      const overRow = el && el.closest('.ec-row');
      const rows = list.querySelectorAll('.ec-row');
      lastOverIdx = null;
      rows.forEach((r, ri) => {
        const isOver = r === overRow && ri !== i;
        const _dmEcT = document.body.classList.contains('dark-mode');
        r.style.borderTop = isOver ? `2px solid ${_dmEcT ? ROSE : BURGUNDY}` : '';
        if (isOver) lastOverIdx = ri;
      });
    }, {passive:false});
    handle.addEventListener('touchend', () => {
      if (clone) { document.body.removeChild(clone); clone = null; }
      if (srcRow) srcRow.style.opacity = '';
      document.querySelectorAll('.ec-row').forEach(r => r.style.borderTop = '');
      if (lastOverIdx !== null && lastOverIdx !== i) {
        _flushEcNames();
        const cats = _ecCats();
        const moved = cats.splice(i, 1)[0];
        cats.splice(lastOverIdx, 0, moved);
        _ecSetCats(cats);
        _renderEcList();
      }
      srcRow = null; lastOverIdx = null;
    });
  });
}

// ── Delete confirm ───────────────────────────────────
function _openDelCat(i) {
  _ecDelIdx = i;
  document.getElementById('delcat-overlay').style.display = 'flex';
  setTimeout(() => { const b = document.getElementById('delcat-cancel-btn'); if(b) b.focus(); }, 50);
}
function closeDelCat() {
  document.getElementById('delcat-overlay').style.display = 'none';
  _ecDelIdx = null;
}
function confirmDelCat() {
  if (_ecDelIdx === null) return;
  _flushEcNames();
  const cats = _ecCats();
  cats.splice(_ecDelIdx, 1);
  _ecSetCats(cats);
  _ecDelIdx = null;
  document.getElementById('delcat-overlay').style.display = 'none';
  _renderEcList();
}

// ── Icon picker ──────────────────────────────────────
function _openIconPicker(catIdx) {
  _ecIconIdx = catIdx;
  _ideaIconMode = false;
  const cats = _ecCats();
  const current = (cats[catIdx] && cats[catIdx].iconKey) || 'wine';
  _ecIconSelected = current;
  _ecIconPrev = current;
  const grid = document.getElementById('iconpicker-grid');
  if (!grid) return;
  grid.innerHTML = ALL_ICON_KEYS.map(key => {
    const sel = key === current;
    const prev = key === _ecIconPrev && !sel;
    const _dm = document.body.classList.contains('dark-mode');
    const _selC = _dm ? ROSE : BURGUNDY;
    const iconColor = sel ? _selC : prev ? ROSE : '#b0a090';
    const bg = sel ? (_dm ? 'rgba(192,122,138,0.12)' : 'rgba(139,58,82,0.08)') : 'transparent';
    const border = sel ? _selC : 'transparent';
    return `<button onclick="_ecSelectIcon('${key}')" id="iconpicker-btn-${key}"
      style="display:flex;align-items:center;justify-content:center;aspect-ratio:1;background:${bg};border:2px solid ${border};border-radius:10px;cursor:pointer;padding:7px">
      ${ICONS[key] ? ICONS[key](22, iconColor) : ''}
    </button>`;
  }).join('');
  document.getElementById('iconpicker-overlay').style.display = 'flex';
}
function _ecSelectIcon(key) {
  _ecIconSelected = key;
  const _dm = document.body.classList.contains('dark-mode');
  const _selC = _dm ? ROSE : BURGUNDY;
  ALL_ICON_KEYS.forEach(k => {
    const btn = document.getElementById(`iconpicker-btn-${k}`);
    if (!btn) return;
    const sel = k === key;
    const prev = k === _ecIconPrev && !sel;
    const iconColor = sel ? _selC : prev ? ROSE : '#b0a090';
    btn.style.background = sel ? (_dm ? 'rgba(192,122,138,0.12)' : 'rgba(139,58,82,0.08)') : 'transparent';
    btn.style.border = `2px solid ${sel ? _selC : 'transparent'}`;
    btn.innerHTML = ICONS[k] ? ICONS[k](22, iconColor) : '';
  });
}
function closeIconPicker(save) {
  document.getElementById('iconpicker-overlay').style.display = 'none';
  if (save && _ideaIconNewMode) {
    // New Idea sheet custom icon
    const defaultKey = _ideaDefaultIconKey(selectedCategory);
    _ideaCustomIconKey = (_ecIconSelected && _ecIconSelected !== defaultKey) ? _ecIconSelected : null;
    updateIdeaCatIcon();
  } else if (save && _ideaIconMode) {
    // Edit Idea modal custom icon
    const typeVal = (document.getElementById('pf-type')||{}).value || '';
    const defaultKey = _ideaDefaultIconKey(typeVal);
    _pfCustomIconKey = (_ecIconSelected && _ecIconSelected !== defaultKey) ? _ecIconSelected : null;
    _updatePfTypeIcon();
  } else if (save && _ecIconIdx !== null && _ecIconSelected) {
    const cats = _ecCats();
    if (cats[_ecIconIdx]) {
      cats[_ecIconIdx].iconKey = _ecIconSelected;
      _ecSetCats(cats);
      _renderEcList();
    }
  }
  _ecIconIdx = null;
  _ideaIconMode = false;
  _ideaIconNewMode = false;
}
function openNewIdeaIconPicker() {
  // Icon picker for the New Idea sheet (both Out and In)
  const defaultKey = _ideaDefaultIconKey(selectedCategory);
  const currentKey = _ideaCustomIconKey || defaultKey;
  _ecIconIdx = null;
  _ideaIconMode = false;
  _ideaIconNewMode = true;
  _ecIconSelected = currentKey;
  _ecIconPrev = currentKey;
  const grid = document.getElementById('iconpicker-grid');
  if (!grid) return;
  grid.innerHTML = ALL_ICON_KEYS.map(key => {
    const sel = key === currentKey;
    const prev = key === _ecIconPrev && !sel;
    const _dm2 = document.body.classList.contains('dark-mode');
    const _selC2 = _dm2 ? ROSE : BURGUNDY;
    const iconColor = sel ? _selC2 : prev ? ROSE : '#b0a090';
    const bg = sel ? (_dm2 ? 'rgba(192,122,138,0.12)' : 'rgba(139,58,82,0.08)') : 'transparent';
    const border = sel ? _selC2 : 'transparent';
    return `<button onclick="_ecSelectIcon('${key}')" id="iconpicker-btn-${key}"
      style="display:flex;align-items:center;justify-content:center;aspect-ratio:1;background:${bg};border:2px solid ${border};border-radius:10px;cursor:pointer;padding:7px">
      ${ICONS[key] ? ICONS[key](22, iconColor) : ''}
    </button>`;
  }).join('');
  document.getElementById('iconpicker-overlay').style.display = 'flex';
}

function openIdeaIconPicker() {
  // Get the current icon for this idea (custom or category default)
  const typeVal = (document.getElementById('pf-type')||{}).value || '';
  const defaultKey = _ideaDefaultIconKey(typeVal);
  const currentKey = _pfCustomIconKey || defaultKey;
  _ecIconIdx = null; // not editing a category
  _ideaIconMode = true;
  _ecIconSelected = currentKey;
  _ecIconPrev = currentKey;
  const grid = document.getElementById('iconpicker-grid');
  if (!grid) return;
  grid.innerHTML = ALL_ICON_KEYS.map(key => {
    const sel = key === currentKey;
    const prev = key === _ecIconPrev && !sel;
    const _dm2 = document.body.classList.contains('dark-mode');
    const _selC2 = _dm2 ? ROSE : BURGUNDY;
    const iconColor = sel ? _selC2 : prev ? ROSE : '#b0a090';
    const bg = sel ? (_dm2 ? 'rgba(192,122,138,0.12)' : 'rgba(139,58,82,0.08)') : 'transparent';
    const border = sel ? _selC2 : 'transparent';
    return `<button onclick="_ecSelectIcon('${key}')" id="iconpicker-btn-${key}"
      style="display:flex;align-items:center;justify-content:center;aspect-ratio:1;background:${bg};border:2px solid ${border};border-radius:10px;cursor:pointer;padding:7px">
      ${ICONS[key] ? ICONS[key](22, iconColor) : ''}
    </button>`;
  }).join('');
  document.getElementById('iconpicker-overlay').style.display = 'flex';
}

function _ideaDefaultIconKey(catVal) {
  const allCats = [...OUT_CATS, ...IN_CATS];
  const catObj = allCats.find(c => c.id === catVal || c.label === catVal || c.id === (catVal||'').toLowerCase());
  return (catObj && catObj.iconKey) || 'dinner';
}

function _updatePfTypeIcon() {
  const typeVal = (document.getElementById('pf-type')||{}).value || '';
  const defaultKey = _ideaDefaultIconKey(typeVal);
  const isCustom = _pfCustomIconKey && _pfCustomIconKey !== defaultKey;
  const iconKey = isCustom ? _pfCustomIconKey : defaultKey;
  const _dmPf = document.body.classList.contains('dark-mode');
  const color = isCustom ? (_dmPf ? ROSE : BURGUNDY) : '#9a8a7a';
  const iconEl = document.getElementById('pf-type-icon');
  if (iconEl) iconEl.innerHTML = ICONS[iconKey] ? ICONS[iconKey](18, color) : activityIcon(typeVal, 18, color);
}


// ── Save categories ──────────────────────────────────
function saveEditCategories() {
  _flushEcNames();

  // Build id->label maps for rename tracking (before applying)
  const outOldMap = {}; OUT_CATS.forEach(c => { outOldMap[c.id] = c.label; });
  const inOldMap  = {}; IN_CATS.forEach(c => { inOldMap[c.id]  = c.label; });

  // Apply new cats
  OUT_CATS = _ecOut.map(c => ({...c}));
  IN_CATS  = _ecIn.map(c => ({...c}));
  saveCats();

  // Build new id->label maps
  const outNewMap = {}; OUT_CATS.forEach(c => { outNewMap[c.id] = c.label; });
  const inNewMap  = {}; IN_CATS.forEach(c => { inNewMap[c.id]  = c.label; });

  // Update all ideas: category stored as id — just ensure id is still valid
  // (labels auto-derive from OUT_CATS/IN_CATS via catLabelForId)
  // No changes needed unless we want to remove orphan cats — skip for now

  // Update UPCOMING_DATES: activity may be stored as id or old label string
  // If stored as old label, remap to new label
  const outLabelToId = {}; OUT_CATS.forEach(c => { outLabelToId[c.label.toLowerCase()] = c.id; });
  const inLabelToId  = {}; IN_CATS.forEach(c => { inLabelToId[c.label.toLowerCase()] = c.id; });
  // Also map old labels -> new labels via id
  const outOldLabelToNew = {};
  Object.keys(outOldMap).forEach(id => {
    if (outNewMap[id] && outNewMap[id] !== outOldMap[id]) outOldLabelToNew[outOldMap[id]] = outNewMap[id];
  });
  const inOldLabelToNew = {};
  Object.keys(inOldMap).forEach(id => {
    if (inNewMap[id] && inNewMap[id] !== inOldMap[id]) inOldLabelToNew[inOldMap[id]] = inNewMap[id];
  });

  UPCOMING_DATES.forEach(u => {
    if (!u.activity) return;
    // If activity is stored as old label that was renamed, update it
    if (outOldLabelToNew[u.activity]) u.activity = outOldLabelToNew[u.activity];
    else if (inOldLabelToNew[u.activity]) u.activity = inOldLabelToNew[u.activity];
  });

  saveIdeas && saveIdeas();
  saveDates && saveDates();
  _rebuildAllCatDropdowns();
  closeEditCategories();
  render();
}

function _rebuildAllCatDropdowns() {
  _rebuildCatDropdown('out');
  _rebuildCatDropdown('in');
  // pf-type (places modal)
  const pfType = document.getElementById('pf-type');
  if (pfType) {
    const prev = window._pfPrevCat || pfType.value;
    const curType = window._pfTypeMode || 'out';
    _rebuildPfTypeSelect(curType);
    const cats = curType === 'in' ? IN_CATS : OUT_CATS;
    if (cats.find(c => c.id === prev)) { pfType.value = prev; window._pfPrevCat = prev; }
    else { pfType.value = cats[0] ? cats[0].id : ''; window._pfPrevCat = pfType.value; }
  }
}

function _rebuildPfTypeSelect(type) {
  const pfType = document.getElementById('pf-type');
  if (!pfType) return;
  const cats = type === 'in' ? IN_CATS : OUT_CATS;
  pfType.innerHTML = `<option value="__edit_cats__" style="color:#9a8a7a;font-style:italic">Edit categories…</option>`
    + cats.map(c => `<option value="${c.id}">${c.label}</option>`).join('');
}

// ═══════════════════════════════════════════════════════
// DARK MODE
// ═══════════════════════════════════════════════════════
let _appearance = localStorage.getItem('duet_appearance') || 'light';
function _applyAppearance(mode) {
  _appearance = mode;
  document.body.classList.toggle('dark-mode', mode === 'dark');
  // Re-render week strip so day number colors update immediately
  if (currentView === 'home') {
    const inner = document.getElementById('week-strip-inner');
    if (inner) {
      const ws = document.getElementById('week-strip-scroll');
      const curPage = ws ? (parseInt(ws.getAttribute('data-cur-page')) || 0) : 0;
      const newHtml = renderWeekStrip();
      const tmp = document.createElement('div');
      tmp.innerHTML = newHtml;
      const newInner = tmp.querySelector('#week-strip-inner');
      if (newInner) inner.innerHTML = newInner.innerHTML;
      setTimeout(() => _initWeekStrip(curPage), 0);
    }
  }
  // Update radio buttons if settings is open
  const rLight = document.getElementById('radio-light');
  const rDark  = document.getElementById('radio-dark');
  if (rLight && rDark) {
    if (mode === 'light') {
      rLight.style.cssText = 'width:18px;height:18px;border-radius:50%;border:2px solid #c07a8a;background:#c07a8a;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer';
      rLight.children[0].style.background = '#fff';
      rDark.style.cssText = 'width:18px;height:18px;border-radius:50%;border:2px solid #c8bfb6;background:transparent;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer';
      rDark.children[0].style.background = 'transparent';
    } else {
      rLight.style.cssText = 'width:18px;height:18px;border-radius:50%;border:2px solid #c8bfb6;background:transparent;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer';
      rLight.children[0].style.background = 'transparent';
      rDark.style.cssText = 'width:18px;height:18px;border-radius:50%;border:2px solid #c07a8a;background:#c07a8a;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer';
      rDark.children[0].style.background = '#fff';
    }
  }
}
function setAppearance(mode) {
  _applyAppearance(mode);
  render();
}
_applyAppearance(_appearance); // apply on load

// ═══════════════════════════════════════════════════════
// MORE MENU
// ═══════════════════════════════════════════════════════
function openMoreMenu() {
  document.getElementById('more-menu-overlay').style.display = 'flex';
}
function closeMoreMenu() {
  document.getElementById('more-menu-overlay').style.display = 'none';
}

// ═══════════════════════════════════════════════════════
// ERASE CONFIRM
// ═══════════════════════════════════════════════════════
function openEraseConfirm() {
  document.getElementById('erase-confirm-overlay').style.display = 'flex';
}
function closeEraseConfirm() {
  document.getElementById('erase-confirm-overlay').style.display = 'none';
}
function eraseAllData() {
  // Clear all app data
  localStorage.removeItem('lovelife_ideas');
  localStorage.removeItem('lovelife_dates');
  localStorage.removeItem('ll_memories');
  localStorage.removeItem('lovelife_todos');
  localStorage.removeItem('ll_cats');
  localStorage.removeItem('duet_reserved');
  // Reload to fresh state
  location.reload();
}

// ═══════════════════════════════════════════════════════
// IMPORT DATA
// ═══════════════════════════════════════════════════════
function importData() {
  document.getElementById('import-file-input').click();
}
function _mergeFields(existing, imported) {
  // Overwrite existing fields with imported values; keep local-only fields untouched
  Object.keys(imported).forEach(key => {
    const impVal = imported[key];
    if (impVal === null || impVal === undefined) return;
    existing[key] = impVal;
  });
}

function handleImportFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const data = JSON.parse(ev.target.result);
      // Debug: show what settings are in the file
      const _dbgS = data.settings || {};
      // Merge ideas: patch existing matches, add new ones
      if (Array.isArray(data.ideas)) {
        data.ideas.forEach(imp => {
          const match = ideas.find(i => i.id === imp.id)
                     || ideas.find(i => (i.name||'').toLowerCase().trim() === (imp.name||'').toLowerCase().trim());
          if (match) { _mergeFields(match, imp); } else { ideas.push(imp); }
        });
        saveIdeas(ideas);
      }
      // Merge upcoming dates: patch existing matches, add new ones
      if (Array.isArray(data.upcomingDates)) {
        data.upcomingDates.forEach(imp => {
          const key = imp.month+'-'+imp.day+'-'+(imp.year||2026)+'-'+(imp.venue||'').toLowerCase();
          const match = UPCOMING_DATES.find(d => d.month+'-'+d.day+'-'+(d.year||2026)+'-'+(d.venue||'').toLowerCase() === key);
          if (match) { _mergeFields(match, imp); } else { UPCOMING_DATES.push(imp); }
        });
        saveDates(UPCOMING_DATES);
      }
      // Merge todos: patch existing matches, add new ones
      if (Array.isArray(data.todos)) {
        data.todos.forEach(imp => {
          const match = todos.find(t => t.id === imp.id);
          if (match) { _mergeFields(match, imp); } else { todos.push(imp); }
        });
        localStorage.setItem('lovelife_todos', JSON.stringify(todos));
      }
      // Restore settings
      const s = data.settings || {};
      if (s.homeAddress   !== undefined) homeAddress          = s.homeAddress;
      if (s.partnerAddress !== undefined) partnerAddress       = s.partnerAddress;
      if (s.partnerPronouns !== undefined) partnerPronouns     = s.partnerPronouns;
      if (s.partnerPronounsCustom !== undefined) partnerPronounsCustom = s.partnerPronounsCustom;
      if (s.hidePrivate   !== undefined) hidePrivate           = s.hidePrivate;
      // Sync appSettings and persist
      appSettings.homeAddress          = homeAddress;
      appSettings.partnerAddress       = partnerAddress;
      appSettings.partnerPronouns      = partnerPronouns;
      appSettings.partnerPronounsCustom = partnerPronounsCustom;
      appSettings.hidePrivate          = hidePrivate;
      saveSettings(appSettings);
      // Refresh Settings popup fields if open
      const _saEl = document.getElementById('settings-overlay');
      if (_saEl && _saEl.style.display !== 'none') openSettings();
      // Restore appearance
      const importedAppearance = s.appearance || data.appearance;
      if (importedAppearance) {
        _appearance = importedAppearance;
        localStorage.setItem('duet_appearance', _appearance);
        _applyAppearance(_appearance);
      }
      FUTURE_DATES = buildFutureDates();
      closeMoreMenu();
      render();
      alert('Import complete!');
    } catch(err) {
      alert('Could not read file. Make sure it\'s a valid duet export.');
    }
    e.target.value = '';
  };
  reader.readAsText(file);
}


render();
// Initialize lock buttons with unlocked state
_renderLockBtn('idea-lock-btn', false);
_renderLockBtn('pf-lock-btn', false);
_renderPrivacyBox('date-lock-icon', 'date-privacy-box', false, false);
_renderPrivacyBox('ts-lock-icon', 'ts-privacy-box', false, false);
</script>
</body>
</html>
